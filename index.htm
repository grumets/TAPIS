<!DOCTYPE html>
<html lang="en">

<head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>TAPIS: Tables from APIs for Sensors (Sensor Things API plus Explorer)</title>
	<script type="text/javascript" src="vis.min.js"></script>
	<script type="text/javascript" src="papaparse.min.js"></script>
	<style type="text/css">
		#mynetwork {
			width: 600px;
			height: 400px;
			border: 1px solid lightgray;
		}

		body {
			font-family: Arial
		}

		.tablesmall {
			font-size: 0.5em;
			border-collapse: collapse;
			border-spacing: 0px;
		}

		.th_compact {
			padding-top: 1px;
			padding-bottom: 1px;
		}

		.td_compact {
			padding-top: 1px;
			padding-bottom: 1px;
		}

		.tr_compact:nth-child(even) {
			background-color: #DCDCCA;
		}

		.tr_compact:nth-child(odd) {
			background-color: #EEEEEB;
		}

		.center {
			margin: 0 auto;
			text-align: center;
		}
	</style>
	<link rel="stylesheet" href="vis.min.css">


</head>

<body onLoad="StartSTAPage();">
	<h2>TAPIS: Tables from APIs for Sensors (Sensor Things API plus Explorer)</h2>

	<button onclick='addCircularImage(null, null, "STAplus", "ogc.png");'><img src="ogc.png" height="20"
		valign="middle"> Add a STA service</button><br>
	<span id="ButtonsSTAEntities"></span>
	<button onclick="addEdge();">Connect two nodes</button><br>

	<div id="clarification"></div>

	<div id="mynetwork"></div>

	<dialog id="DialogSTAURL">
		<form>
			<p>
				<label>STA service URL:
					<input type="text" id="DialogSTAURLInput" size="100"></input>
				</label>
			</p>
			<div class="center">
				<button value="default" onClick="GetSTAURL(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectColumns">
		<form>
			Select columns:
			<span id="DialogSelectColumnsHTML">
			</span>
			<div class="center">
				<button value="default" onClick="GetSelectColumns(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectExpands">
		<form>
			Select what do you want to expand:
			<span id="DialogSelectExpandsHTML">
			</span>
			<div class="center">
				<button value="default" onClick="GetSelectExpands(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectRows">
		<form>
			<span id="DialogSelectRowsTableInputSpan">
			</span>
			<span id="DialogSelectRowsTable">
			</span>
			<br>
			<span id="DialogSelectRowsFilterInputSpan">
			</span>
			<span id="DialogSelectRowsFilter">
			</span>
			<div class="center">
				<button value="default" onClick="GetSelectRows(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogContextMenu">
		<form>
			<p>
				<button onclick='addCircularImage(event, "DialogContextMenu" "STAplus", "ogc.png");'><img src="ogc.png"
						height="20" valign="middle"> Add a STA service</button><br>
				<span id="ButtonsContextMenuObjects"></span>
				<button onclick='removeCircularImage(event, "DialogContextMenu")'>Remove</button><br>
			</p>
			<div class="center">
				<button value="cancel" onClick="startingNodeContextId=null;" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>


	<dialog id="DialogOK">
		<form>
			<span id="DialogOKOptions"></span><br>
			<span id="DialogOKHTML">
			</span>
			<div class="center">
				<button value="cancel" formmethod="dialog">OK</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSaveTable">
		<form>
			Save the table as CSV.
			<br>
			<label>CSV delimiter:
				<input type="text" id="DialogSaveTableDelimiter" size="2" maxlength="1" value=";"></input>
			</label>
			<!--span id="DialogSaveTableOptions"></span--><br>
			</span>
			<div class="center">
				<button value="default" onClick="SaveTable(event)">Save</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSaveLayer">
		<form>
			Save table as GeoJSON
			<be>
			<fieldset>
    				<legend>Position:</legend>
				<label>Place description:
					<span id="DialogSaveLayerPlace"></span>
				</label>
				<br>
				<label>Longitude:
					<span id="DialogSaveLayerLongitude"></span>
				</label>
				<br>
				<label>Latitude:
					<span id="DialogSaveLayerLatitude"></span>
				</label>
			</fieldset>
			<br>
			<label>Date and time:
				<span id="DialogSaveLayerTime"></span>
			</label>
			<br>
			<label>Variable name:
				<span id="DialogSaveLayerVariable"></span>
			</label>
			<br>
			<label>Value:
				<span id="DialogSaveLayerValue"></span>
			</label>
			<br>
			</span>
			<div class="center">
				<button value="default" onClick="SaveLayer(event)">Save</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<!--h2 id="eventSpanHeading"></h2>
	<pre id="eventSpanContent"></pre-->

	<script type="text/javascript">

		"use strict"

		const STAEntities = {ObservedProperties: {singular: "ObservedProperty", entities: ["Datastreams", "MultiDatastreams"], properties: ["name", "definition", "description", "properties"]}, 
				Sensors: {singular: "Sensor", entities: ["Datastreams", "MultiDatastreams"], properties: ["name", "description", "encodingType", "metadata", "properties"]}, 
				Observations: {singular: "Observation", entities: ["Datastream", "MultiDatastream", "FeatureOfInterest", "Groups", "Subjects", "Objects"], properties: ["phenomenonTime", "resultTime", "result", "resultQuality", "validTime", "parameters"]}, 
      				FeaturesOfInterest: {singular: "FeatureOfInterest", entities: ["Observations"], properties: ["name", "description", "encodingType", "feature", "properties"]}, 
				Things: {singular: "Thing", entities: ["Datastreams", "MultiDatastreams", "Party", "Locations", "HistoricalLocations"], properties: ["name", "description", "properties"]},     
				Locations: {singular: "Location", entities: ["Things", "HistoricalLocations"], properties: ["name", "description", "encodingType", "location", "properties"]}, 
				HistoricalLocations: {singular: "HistoricalLocation", entities: ["Things", "Location"], properties: ["time"]}, 
				Projects: {singular: "Project", entities: ["Datastreams", "MultiDatastreams", "Party", "License"], properties: ["name", "description", "classification", "termsOfUse", "privacyPolicy", "creationTime", "startTime", "endTime", "url", "properties"]}, 
				Licenses: {singular: "License", entities: ["Datastreams", "MultiDatastreams", "Projects", "Groups"], properties: ["name", "description", "definition", "logo", "attributionText"]}, 
				Parties: {singular: "Party", entities: ["Datastreams", "MultiDatastreams", "Projects", "Groups", "Things"], properties: ["description", "authId", "role", "displayName"]}, 
				Groups: {singular: "Group", entities: ["Party", "Projects", "License", "Observations", "Relations"], properties: ["name", "description", "purpose", "creationTime", "endTime", "termsOfUsed", "privacyPolicy", "properties", "dataQuality"]}, 
				Relations: {singular: "Relation", entities: ["Object", "Subject", "Groups"], properties: ["role", "description", "externalObject", "properties"]}, 
				Datastreams: {singular: "Datastream", entities: ["Party", "Sensor", "ObservedProperty", "Projects", "License", "Observations", "Thing"], properties: ["name", "description", "unitOfMeasurement", "observationType", "observedArea", "phenomenonTime", "resultTime", "properties"]}, 
				MultiDatastreams: {singular: "MultiDatastream", entities: ["Party", "Sensor", "ObservedProperties", "Projects", "License", "Observations", "Thing"], properties: ["name", "description", "unitOfMeasurements", "observationType", "observedArea", "phenomenonTime", "resultTime", "multiObservationDataTypes", "properties"]}};
		const STAEntitiesArray = Object.keys(STAEntities);
		const STASpecialQueries = {ObsLayer: {description: "Observations Layer", query: "Observations?$orderby=phenomenonTime%20desc&$expand=Datastream($select=unitOfMeasurement),Datastream/ObservedProperty($select=name,%20definition),FeatureOfInterest($select=description,feature)&$select=phenomenonTime,result"}}
		const STASpecialQueriesArray = Object.keys(STASpecialQueries);
		const TableOperations = {Table: {description: "View Table"}, 
					SelectColumns: {description: "Select Columns"},
					SelectRows: {description: "Select Rows"},
					SeparateColumns: {description: "Separate Columns"},
					ViewQuery: {description: "View Query"},
					SaveTable: {description: "Save Table"},
					SaveLayer: {description: "Save Layer"}};
		const TableOperationsArray = Object.keys(TableOperations);


		window.onbeforeunload = function () { return "Your work will be lost."; }

		var currentNode = null, connectionInProcess = false, startingNodeContextId = null;

		function StartSTAPage() {
			var s = "";

			for (var i = 0; i < STAEntitiesArray.length; i++)
				s += "<button onclick='addCircularImage(null, null, \"" + STAEntitiesArray[i] + "\", \"" + STAEntitiesArray[i] + ".png\");'><img src='" + STAEntitiesArray[i] + ".png' height='20' valign='middle'> " + STAEntitiesArray[i] + "</button> ";
			s += "<br>";

			for (var i = 0; i < STASpecialQueriesArray.length; i++)
				s += "<button onclick='addCircularImage(null, null, \"" + STASpecialQueriesArray[i] + "\", \"" + STASpecialQueriesArray[i] + ".png\");'><img src='" + STASpecialQueriesArray[i] + ".png' height='20' valign='middle'> " + STASpecialQueries[STASpecialQueriesArray[i]].description + "</button> ";
			s += "<br>";

			for (var i = 0; i < TableOperationsArray.length; i++)
				s += "<button onclick='addCircularImage(null, null, \"" + TableOperationsArray[i] + "\", \"" + TableOperationsArray[i] + ".png\");'><img src='" + TableOperationsArray[i] + ".png' height='20' valign='middle'> " + TableOperations[TableOperationsArray[i]].description + "</button> ";
			s += "<br>";

			document.getElementById("ButtonsSTAEntities").innerHTML = s;

			s = "";
			for (var i = 0; i < STAEntitiesArray.length; i++)
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + STAEntitiesArray[i] + "\", \"" + STAEntitiesArray[i] + ".png\");'><img src='" + STAEntitiesArray[i] + ".png' height='20' valign='middle'> " + STAEntitiesArray[i] + "</button><br>";
			s += "<br>";
			for (var i = 0; i < STASpecialQueriesArray.length; i++)
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + STASpecialQueriesArray[i] + "\", \"" + STASpecialQueriesArray[i] + ".png\");'><img src='" + STASpecialQueriesArray[i] + ".png' height='20' valign='middle'> " + STASpecialQueries[STASpecialQueriesArray[i]].description + "</button><br>";
			s += "<br>";
			for (var i = 0; i < TableOperationsArray.length; i++)
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + TableOperationsArray[i] + "\", \"" + TableOperationsArray[i] + ".png\");'><img src='" + TableOperationsArray[i] + ".png' height='20' valign='middle'> " + TableOperations[TableOperationsArray[i]].description + "</button><br>";

			document.getElementById("ButtonsContextMenuObjects").innerHTML = s;
		}

		//https://web.dev/fetch-api-error-handling/
		async function LoadJSONData(node) {
			var response, jsonData;
			try {
				response = await fetch(node.STAURL);
			}
			catch (error) {
				document.getElementById("clarification").innerHTML = 'Error getting ' + node.STAURL + ": " + error.message;
				console.log('There was an error', error);
				node.STAdata = null;
				networkNodes.update(node);
				return;
			}
			// Uses the 'optional chaining' operator
			if (!(response?.ok)) {
				document.getElementById("clarification").innerHTML = "HTTP Response Code: " + response?.status + " reading <small>" + node.STAURL + "</small>: " + response?.statusText;
				console.log("HTTP Response Code: " + response?.status + ": " + response?.statusText);
				node.STAdata = null;
				networkNodes.update(node);
				return;
			}
			try {
				jsonData = await response.json();
			} catch (error) {
				if (error instanceof SyntaxError) {
					document.getElementById("clarification").innerHTML = 'Syntax error reading ' + node.STAURL + ": " + error.message;
					console.log('There was a SyntaxError', error);
					node.STAdata = null;
					networkNodes.update(node);
					return;
				}
				else {
					document.getElementById("clarification").innerHTML = 'Error interpreting ' + node.STAURL + ": " + error.message;
					console.log('There was an error', error);
					node.STAdata = null;
					networkNodes.update(node);
					return;
				}
			}
			node.STAdata = (jsonData.value) ? jsonData.value : [jsonData];
			networkNodes.update(node);
		}

		var savedFile = null;

		function MakeHrefData(data, mediatype)
		{
			var blobData = new Blob([data], {type: mediatype});

			// If we are replacing a previously generated file we need to
			// manually revoke the object URL to avoid memory leaks.
			if (savedFile !== null)
				window.URL.revokeObjectURL(savedFile);

			savedFile = window.URL.createObjectURL(blobData);
			return savedFile;
		}

		function SaveLocalDataFile(data, fileName, extension, mediatype)   //Saves a memory data structure to a local file
		{
		const link = document.createElement('a');
			if (fileName.substring(fileName.length-extension.length) != extension)
				fileName+=extension;
			link.setAttribute('download', fileName);
			link.setAttribute('href', MakeHrefData(data));
			document.body.appendChild(link);

			// wait for the link to be added to the document
			window.requestAnimationFrame(function () {
		      	var event = new MouseEvent('click');
				link.dispatchEvent(event);
				document.body.removeChild(link);
			});

		  	return false;
		}

		function GetSTAURL(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSTAURL").close(document.getElementById("DialogSTAURLInput").value);

			if (currentNode.STAURL == document.getElementById("DialogSTAURLInput").value)
				return;

			currentNode.STAURL = document.getElementById("DialogSTAURLInput").value; // Have to send the select box value here.
			if (currentNode.STAURL.charAt(currentNode.STAURL.length - 1) == '/')
				currentNode.STAURL = currentNode.STAURL.slice(0, -1);  //remove last character
			networkNodes.update(currentNode);	//https://visjs.github.io/vis-data/data/dataset.html#Data_Manipulation
			LoadJSONData(currentNode);

			//if childen nodes have also STAURL
			UpdateChildenSTAURL(currentNode);
		}

		function GetSelectColumns(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectColumns").close();

			var nodeids = network.getConnectedNodes(currentNode.id, "from");
			if (nodeids && nodeids.length && networkNodes.get(nodeids[0])) {
				var node = networkNodes.get(nodeids[0]);
				if (node.STAURL)
					currentNode.STAURL = node.STAURL;
				if (node.STAdata)
					currentNode.STAdata = node.STAdata;
			}
			currentNode.STASelectedColumns=[];
			var dataAttributes = getDataAttributes(currentNode.STAdata);
			for (var a = 0; a < dataAttributes.length; a++) {
				if (!document.getElementById("SelectColumn_" + a).checked)
					break;
			}
			if (a < dataAttributes.length) //A checked attribute has been found ("for" breaks before ending).
			{
				var s;
				currentNode.STAURL += "?$select="
				for (var a = 0; a < dataAttributes.length; a++) {
					if (document.getElementById("SelectColumn_" + a).checked) {
						if (dataAttributes[a].startsWith("@iot."))
							s = dataAttributes[a].substring(5);
						else
							s = dataAttributes[a].replace("@iot.", "/");  //Changes Datastreams@iot.navigationLink to Datastreams/navigationLink
						currentNode.STAURL += s + ",";
						currentNode.STASelectedColumns[a]=true;
					}
					else
						currentNode.STASelectedColumns[a]=false;
				}
				currentNode.STAURL = currentNode.STAURL.slice(0, -1); //remove the last coma.	
				networkNodes.update(currentNode);
				LoadJSONData(currentNode);
				UpdateChildenSTAURL(currentNode);
			}
			else   //If no selected collumn has been found, no filter is done and all collumns are selected
			{
				for (var a = 0; a < dataAttributes.length; a++) {
					currentNode.STASelectedColumns[a]=true;
				}
			}
		}

		function GetSelectExpands(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectExpands").close();
			
			var dataAttributes = getDataAttributes(currentNode.STAdata);
			if (!currentNode.STASelectedExpands)
				currentNode.STASelectedExpands={STAURLUnexpanded: currentNode.STAURL, dataAttributesUnexpanded: dataAttributes.slice(), selected: []};
			
			var dataAttr=currentNode.STASelectedExpands.dataAttributesUnexpanded;
			for (var a = 0; a < dataAttr.length; a++) {
				if (document.getElementById("SelectExpand_" + a) && document.getElementById("SelectExpand_" + a).checked)
					break;
			}
			if (a < dataAttr.length) //A checked attribute has been found ("for" breaks before ending).
			{
				var s;
				currentNode.STAURL = currentNode.STASelectedExpands.STAURLUnexpanded + "?$expand="
				for (var a = 0; a < dataAttr.length; a++) {
					if (document.getElementById("SelectExpand_" + a) && 
						document.getElementById("SelectExpand_" + a).checked && 
						dataAttr[a].endsWith("@iot.navigationLink")){
						s = dataAttr[a].substring(0, dataAttr[a].length-"@iot.navigationLink".length);
						currentNode.STAURL += s + ",";
						currentNode.STASelectedExpands.selected[a]=true;
					}
					else
						currentNode.STASelectedExpands.selected[a]=false;
				}
				currentNode.STAURL = currentNode.STAURL.slice(0, -1); //remove the last coma.	
				networkNodes.update(currentNode);
				LoadJSONData(currentNode);
				UpdateChildenSTAURL(currentNode);
			}
			/*else   //If no selected collumn has been found, no expand is needed and the previous request is fine
				;*/
		}

		function isNumeric(str) {
			if (typeof str != "string") return false // we only process strings!  	
			return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
				!isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
		}

		function GetSelectRows(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectRows").close();

			var nodeids = network.getConnectedNodes(currentNode.id, "from");
			if (nodeids && nodeids.length && networkNodes.get(nodeids[0])) {
				var node = networkNodes.get(nodeids[0]);
				if (node.STAURL)
					currentNode.STAURL = node.STAURL;
				if (node.STAdata)
					currentNode.STAdata = node.STAdata;
			}

			if (document.getElementById("DialogSelectRowsTableRadio").checked) {
				var elems = document.getElementsByName("SelectRowRadio");
				for (var i = 0; i < elems.length; i++) {
					if (elems[i].checked)
						break;
				}
				if (i < elems.length) {
					const s = elems[i].id.substring("SelectRow_".length);
					const n = Number(s);
					if (Number.isInteger(n))
						currentNode.STAURL += "(" + n + ")";
					else
						currentNode.STAURL += "(\"" + s + "\")";
				}
			}
			else {
				alert("TBD");
			}
			networkNodes.update(currentNode);
			LoadJSONData(currentNode);
			UpdateChildenSTAURL(currentNode);
		}


		function IdOfSTAEntity(node) {
			for (var i = 0; i < STAEntitiesArray.length; i++) {
				if (node.image == STAEntitiesArray[i] + ".png")
					return i;
			}
			return -1;
		}

		function IdOfSTASpecialQueries(node) {
			for (var i = 0; i < STASpecialQueriesArray.length; i++) {
				if (node.image == STASpecialQueriesArray[i] + ".png")
					return i;
			}
			return -1;
		}

		function UpdateChildenSTAURL(parentNode) {
			var nodeIds = network.getConnectedNodes(parentNode.id, 'to');
			for (var i = 0; i < nodeIds.length; i++) {
				var node = networkNodes.get(nodeIds[i])
				if (node.STAURL) {
					if (IdOfSTAEntity(node) != -1) {
						node.STAURL = parentNode.STAURL + "/" + STAEntitiesArray[IdOfSTAEntity(node)];
						if (node.STASelectedExpands) node.STASelectedExpands=null;
						networkNodes.update(node);
						LoadJSONData(node);
					}
				}
				UpdateChildenSTAURL(node);
			}
		}

		function getDataAttributes(data) {
			var dataAttributes = [], s;

			for (var i = 0; i < data.length; i++) {
				var keys = Object.keys(data[i]);
				for (var k = 0; k < keys.length; k++) {
					for (var a = 0; a < dataAttributes.length; a++) {
						if (dataAttributes[a] == keys[k])
							break;
					}
					if (a == dataAttributes.length)
						dataAttributes.push(keys[k]);
				}
			}
			return dataAttributes;
		}

		function GetHTMLTable(data, rowNumbers, rowChecks) {
			var dataAttributes = getDataAttributes(data);

			var s = "<table class='tablesmall'><tr>";
			if (rowNumbers)
				s += "<th class='th_compact'></th>";
			if (rowChecks)
				s += "<th class='th_compact'></th>";
			for (var a = 0; a < dataAttributes.length; a++)
				s += "<th class='th_compact'>" + dataAttributes[a] + "</th>";
			s += "</tr>";
			for (var i = 0; i < data.length; i++) {
				s += "<tr class='tr_compact'>";
				if (rowNumbers)
					s += "<td class='td_compact'>" + (i + 1) + "</td>";
				if (rowChecks)
					s += "<td class='td_compact'><input type='radio' name='SelectRowRadio' id='SelectRow_" + (data[i]["@iot.id"] ? data[i]["@iot.id"] : i) + "' " + (i == 0 ? "checked='checked'" : "") + "/></td>";
				for (var a = 0; a < dataAttributes.length; a++) {
					s += "<td class='td_compact'>"
					if (typeof data[i][dataAttributes[a]] !== "undefined") {
						if ((dataAttributes[a] == "url" || dataAttributes[a] == "definition" ||
							dataAttributes[a].endsWith("@iot.selfLink") ||
							dataAttributes[a].endsWith("@iot.navigationLink")) && data[i][dataAttributes[a]].length)
							s += "<a href='" + data[i][dataAttributes[a]] + "' target='_blank'>" + data[i][dataAttributes[a]] + "</a>";
						else
							s += JSON.stringify(data[i][dataAttributes[a]]);
					}
					s += "</td>"
				}
				s += "</tr>"
			}
			s += "</table>";
			return s;
		}

		function ShowTableDialog(nodeId) {
			var data = networkNodes.get(nodeId).STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogOKHTML").innerHTML = "No data to show.";
				return;
			}

			document.getElementById("DialogOKHTML").innerHTML = GetHTMLTable(data,
				document.getElementById("ShowTableRowNumberDialogOK").checked ? true : false,
				false);
		}

		function StringifyObjectElements(data) {
			var dataAttributes = getDataAttributes(data), jsonTable=[];

			for (var i = 0; i < data.length; i++) {
				jsonTable[i]={};
				for (var a = 0; a < dataAttributes.length; a++)
					{
					if (typeof data[i][dataAttributes[a]] === "object")  //"arrays" are also objects.
						jsonTable[i][dataAttributes[a]]=JSON.stringify(data[i][dataAttributes[a]]);
					else
						jsonTable[i][dataAttributes[a]]=data[i][dataAttributes[a]];
				}
			}
			return jsonTable;
		}


		function GetGeoJSON(data, selectedOptions) {
			var dataSorted=JSON.parse(JSON.stringify(data)), geojson={"type": "FeatureCollection", "features": []};

			//Sorted by place, variable and date (older first).
			dataSorted.sort(function (a, b) {
				if (a[selectedOptions.place]<b[selectedOptions.place])
					return -1;
				if (a[selectedOptions.place]>b[selectedOptions.place])
					return 1;
				if (a[selectedOptions.longitude]-b[selectedOptions.longitude]<-0.0000001)
					return -1;
				if (a[selectedOptions.longitude]-b[selectedOptions.longitude]>0.0000001)
					return 1;
				if (a[selectedOptions.latitude]-b[selectedOptions.latitude]<-0.0000001)
					return -1;
				if (a[selectedOptions.latitude]-b[selectedOptions.latitude]>0.0000001)
					return 1;
				if (a[selectedOptions.variable]<b[selectedOptions.variable])
					return -1;
				if (a[selectedOptions.variable]>b[selectedOptions.variable])
					return 1;
				if (a[selectedOptions.time]<b[selectedOptions.time])
					return -1;
				if (a[selectedOptions.time]>b[selectedOptions.time])
					return 1;
				return 0;});
			var a, b;
			for (var i = 0, f=-1; i < dataSorted.length; i++) {
				a=dataSorted[i], b=dataSorted[i==0 ? 0 : i-1];
				if (i==0 || a[selectedOptions.place]!=b[selectedOptions.place] ||
					a[selectedOptions.longitude]>b[selectedOptions.longitude]+0.0000001 ||
					a[selectedOptions.latitude]<b[selectedOptions.latitude]-0.0000001 ||
					a[selectedOptions.latitude]>b[selectedOptions.latitude]+0.0000001)
				{
					f++;
					geojson.features[f]={
						"type": "Feature",
						"geometry": {
							"type": "Point",
							"coordinates": [
								a[selectedOptions.longitude],
								a[selectedOptions.latitude]
							]
						},
						"properties": {
							"Place": a[selectedOptions.place],
						}
					};
				}
				geojson.features[f].properties[a[selectedOptions.variable]+"_"+a[selectedOptions.time]]=a[selectedOptions.value];
			}
			return geojson;
		}

		function ShowSaveTableDialog(nodeId) {
			;
		}

		function PopulateSelectSaveLayerDialog(id, dataAttributes, selectedOption)
		{
			var s="<select id=\""+id+"Select"+"\">";
			for (var a=0; a<dataAttributes.length; a++)
				s+="<option value=\""+dataAttributes[a]+"\""+ (dataAttributes[a]==selectedOption ? "selected=\"selected\"" : "") +">"+dataAttributes[a]+"</option>";
			s+="</select>";
			document.getElementById(id).innerHTML=s;
		}

		function ShowSaveLayerDialog(nodeId) {
			var nodeids = network.getConnectedNodes(nodeId, "from");
			if (nodeids && nodeids.length) {
				var data = networkNodes.get(nodeids[0]).STAdata;
				var dataAttributes = getDataAttributes(data), s, elem;
				PopulateSelectSaveLayerDialog("DialogSaveLayerPlace", dataAttributes, "FeatureOfInterest/description");
				PopulateSelectSaveLayerDialog("DialogSaveLayerLongitude", dataAttributes, "FeatureOfInterest/feature/coordinates_0");
				PopulateSelectSaveLayerDialog("DialogSaveLayerLatitude", dataAttributes, "FeatureOfInterest/feature/coordinates_1");
				PopulateSelectSaveLayerDialog("DialogSaveLayerTime", dataAttributes, "PhenomenonTime");
				PopulateSelectSaveLayerDialog("DialogSaveLayerVariable", dataAttributes, "Datastream/ObservedProperty/name");
				PopulateSelectSaveLayerDialog("DialogSaveLayerValue", dataAttributes, "result");
			}
		}

		function GetSelectedOptionsSaveLayer(){
			var selectedOptions={};
			selectedOptions.place=document.getElementById("DialogSaveLayerPlaceSelect").value;
			selectedOptions.longitude=document.getElementById("DialogSaveLayerLongitudeSelect").value;
			selectedOptions.latitude=document.getElementById("DialogSaveLayerLatitudeSelect").value;
			selectedOptions.time=document.getElementById("DialogSaveLayerTimeSelect").value;
			selectedOptions.variable=document.getElementById("DialogSaveLayerVariableSelect").value;
			selectedOptions.value=document.getElementById("DialogSaveLayerValueSelect").value;
			return selectedOptions;
		}

		function SaveTable() {
			event.preventDefault(); // We don't want to submit this form
			var delimiter=document.getElementById("DialogSaveTableDelimiter").value;
			document.getElementById("DialogSaveTable").close();
			var nodeids = network.getConnectedNodes(currentNode.id, "from");
			if (nodeids && nodeids.length) {
				if (networkNodes.get(nodeids[0]))
					SaveLocalDataFile(Papa.unparse(StringifyObjectElements(networkNodes.get(nodeids[0]).STAdata), { quotes: false, quoteChar: '"', escapeChar: '"', delimiter: (delimiter ? delimiter : ";"), header: true, newline: "\r\n", skipEmptyLines: "greedy"}), 
						(IdOfSTAEntity(networkNodes.get(nodeids[0])) == -1) ?  "table" : STAEntitiesArray[IdOfSTAEntity(networkNodes.get(nodeids[0]))], ".csv", "application/vnd.ms-excel");   //https://stackoverflow.com/questions/7076042/what-mime-type-should-i-use-for-csv
			}
		}

		function SaveLayer() {
			event.preventDefault(); // We don't want to submit this form
			var delimiter=document.getElementById("DialogSaveTableDelimiter").value;
			document.getElementById("DialogSaveLayer").close();
			var nodeids = network.getConnectedNodes(currentNode.id, "from");
			if (nodeids && nodeids.length) {
				if (networkNodes.get(nodeids[0]))
					SaveLocalDataFile(JSON.stringify(GetGeoJSON(networkNodes.get(nodeids[0]).STAdata, GetSelectedOptionsSaveLayer())), "GeoJSON", ".geojson", "application/geo+json");   
			}
		}

		function ShowTableSelectColumnsDialog(nodeParentId,nodeId) {
			var data = networkNodes.get(nodeParentId).STAdata, 
					selectedColumns=networkNodes.get(nodeId).STASelectedColumns;

			if (!data || !data.length) {
				document.getElementById("DialogSelectColumnsHTML").innerHTML = "No data to show.";
				return;
			}
			var dataAttributes = getDataAttributes(data);

			var s = "<table>";
			for (var a = 0; a < dataAttributes.length; a++)
				s += "<tr><td><label><input type='checkbox'" + ((!selectedColumns || a>=selectedColumns.length || selectedColumns[a]) ? "checked='checked'" : "") + " id='SelectColumn_" + a + "' /> " + dataAttributes[a] + "</label></td></tr>";
			s += "</table>";
			document.getElementById("DialogSelectColumnsHTML").innerHTML = s;
		}

		function ShowTableSelectExpandsDialog(nodeId) {
			var data = networkNodes.get(nodeId).STAdata, 
					entities=STAEntities[STAEntitiesArray[IdOfSTAEntity(networkNodes.get(nodeId))]].entities,
					selectedExpands=networkNodes.get(nodeId).STASelectedExpands;

			if (!data || !data.length) {
				document.getElementById("DialogSelectExpandsHTML").innerHTML = "No data to show.";
				return;
			}

			var dataAttributes = selectedExpands ? selectedExpands.dataAttributesUnexpanded : getDataAttributes(data);

			var s = "<table>";
			for (var a = 0; a < dataAttributes.length; a++)
			{
				if (dataAttributes[a].endsWith("@iot.navigationLink"))
				{
					var da=dataAttributes[a].substring(0, dataAttributes[a].length-"@iot.navigationLink".length);
					for (var e=0; e < entities.length; e++)
					{
						if (entities[e]==da)
						{
							s += "<tr><td><label><input type='checkbox'" + ((selectedExpands && a<selectedExpands.selected.length && selectedExpands.selected[a]) ? "checked='checked'" : "") + " id='SelectExpand_" + a + "' /> " + da + "</label></td></tr>";
							break;
						}
					}
				}
			}
			s += "</table>";
			document.getElementById("DialogSelectExpandsHTML").innerHTML = s;
		}

		function ShowTableSelectRowsDialog(nodeId) {
			var data = networkNodes.get(nodeId).STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogSelectColumnsHTML").innerHTML = "No data to show.";
				return;
			}

			document.getElementById("DialogSelectRowsTableRadio").checked = true;
			document.getElementById("DialogSelectRowsTable").innerHTML = GetHTMLTable(data, false, true);

			document.getElementById("DialogSelectRowsFilterRadio").checked = false;
			document.getElementById("DialogSelectRowsFilter").innerHTML = "";
		}

		function ShowTableFilterRowsDialog(nodeId) {
			var data = networkNodes.get(nodeId).STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogSelectRowsTable").innerHTML = "No data to show.";
				return;
			}

			document.getElementById("DialogSelectRowsTableRadio").checked = false;
			document.getElementById("DialogSelectRowsTable").innerHTML = "";

			document.getElementById("DialogSelectRowsFilterRadio").checked = true;
			document.getElementById("DialogSelectRowsFilter").innerHTML = "";

		}

		function ChangeTableFilterRowsDialog(nodeId) {
			if (document.getElementById("DialogSelectRowsTableRadio").checked)
				ShowTableSelectRowsDialog(nodeId);
			else
				ShowTableFilterRowsDialog(nodeId);
		}

		function SeparatePropertyIfNeeded(record, property, baseName)
		{
			if (typeof property === "object")  //"arrays" are also objects.
			{
				if (Array.isArray(property))
				{
					//Array: creating multifields
					for (var j = 0; j<property.length; j++)
					{
						if (typeof property[j] === "object")
						{
							if (Array.isArray(property[j]))
							{
								for (var jj = 0; jj<property[j].length; jj++)
									SeparatePropertyIfNeeded(record, property[j][jj], baseName + "_" + j + "_" + jj);
							}
							else
							{
								var subkeys = Object.keys(property[j]);
								for (var kk = 0; kk < subkeys.length; kk++)
									SeparatePropertyIfNeeded(record, property[j][subkeys[kk]], baseName + "/" + subkeys[kk] + "_" + j)
							}
						}
						else
							record[baseName + "_" + j]=property[j];
					}
				}
				else
				{
					//Object; lets separate it.
					var subkeys = Object.keys(property);
					for (var kk = 0; kk < subkeys.length; kk++)
						SeparatePropertyIfNeeded(record, property[subkeys[kk]], baseName + "/" + subkeys[kk])
				}
			}
			else
				record[baseName]=property;
		}

		function SeparateColumns(node, nodeParent) {
			var data=nodeParent.STAdata, record, recordParent;
			node.STAURL=nodeParent.STAURL;
			node.STAdata=[];
			for (var i = 0; i < data.length; i++) {
				record=node.STAdata[i]={};
				recordParent=data[i]
				var keys = Object.keys(recordParent);
				for (var k = 0; k < keys.length; k++)
					SeparatePropertyIfNeeded(record, recordParent[keys[k]], keys[k]);
			}
		}

		function StartCircularImage(nodeTo, nodeFrom, calUnir)
		{
			if (nodeFrom.STAURL && IdOfSTAEntity(nodeTo) != -1) {
				nodeTo.STAURL = nodeFrom.STAURL + "/" + STAEntitiesArray[IdOfSTAEntities(nodeTo)];
				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id }]);
				LoadJSONData(nodeTo);
				return true;
			}
			if (nodeFrom.STAURL && IdOfSTASpecialQueries(nodeTo) != -1) {
				nodeTo.STAURL = nodeFrom.STAURL + "/" + STASpecialQueries[STASpecialQueriesArray[IdOfSTASpecialQueries(nodeTo)]].query;
				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id }]);
				LoadJSONData(nodeTo);
				return true;
			}
			if (nodeFrom.STAURL && (nodeTo.image == "SelectColumns.png" || nodeTo.image == "SelectRows.png")) {
				nodeTo.STAURL = nodeFrom.STAURL;
				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id }]);
				LoadJSONData(nodeTo);
				return true;
			}
			if (nodeFrom.STAURL && (nodeTo.image == "SeparateColumns.png")) {
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id }]);
				SeparateColumns(nodeTo, nodeFrom);
				networkNodes.update(nodeTo);
				return true;
			}
			return false;
		}

		// create an array with nodes	
		var networkNodes = new vis.DataSet([]);

		// create an array with edges	
		var networkEdges = new vis.DataSet([]);

		var network = new vis.Network(document.getElementById("mynetwork"), {
			nodes: networkNodes,
			edges: networkEdges
		},
			{
				interaction: { hover: true },
				manipulation: {  //https://stackoverflow.com/questions/39701703/add-edge-dynamically-visjs
					enabled: false,
					addEdge: function (data, callback) {
						console.log('add edge', data);
						if (data.from == data.to)
							alert("Connection to the same node is not allowed");
						else {
							networkEdges.add([{ from: data.from, to: data.to }]);
							StartCircularImage(networkNodes.get(data.to), networkNodes.get(data.from), false);
						}
						connectionInProcess = false;
						document.getElementById("clarification").innerHTML = "";
					}
				}
			});

		/*network.on("click", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "Click event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("click event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});*/
		network.on("doubleClick", function (params) {
			/*params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "doubleClick event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);*/
			if (params.nodes && params.nodes.length && !connectionInProcess) {
				currentNode = networkNodes.get(params.nodes[0])
				if (currentNode.image == "ogc.png") {
					document.getElementById("DialogSTAURLInput").value = currentNode.STAURL;
					document.getElementById("DialogSTAURLInput").readOnly = false;
					document.getElementById("DialogSTAURL").showModal();
				}
				else if (currentNode.image == "ViewQuery.png") {
					document.getElementById("DialogSTAURLInput").value="";
					var nodeids = network.getConnectedNodes(currentNode.id, "from");
					if (nodeids && nodeids.length) {
						if (networkNodes.get(nodeids[0])) 
							document.getElementById("DialogSTAURLInput").value = networkNodes.get(nodeids[0]).STAURL;
					}
					document.getElementById("DialogSTAURLInput").readOnly = true;
					document.getElementById("DialogSTAURL").showModal();
				}
				else if (currentNode.image == "Table.png") {
					///Determining the parent node.
					var nodeids = network.getConnectedNodes(currentNode.id, "from");
					if (nodeids && nodeids.length) {
						if (networkNodes.get(nodeids[0])) {
							var data = networkNodes.get(nodeids[0]).STAdata;
							if (data && data.length)
								document.getElementById("DialogOKOptions").innerHTML = "<label><input type='checkbox' checked='checked' id='ShowTableRowNumberDialogOK' onChange='ShowTableDialog(\"" + nodeids[0] + "\");'/> Show row numbers</label>";
							else
								document.getElementById("DialogOKOptions").innerHTML = "";
							ShowTableDialog(nodeids[0]);
						}
						document.getElementById("DialogOK").showModal();
					}
				}
				else if (currentNode.image == "SaveTable.png") {
					ShowSaveTableDialog(currentNode.id);
					document.getElementById("DialogSaveTable").showModal();
				}
				else if (currentNode.image == "SaveLayer.png") {
					ShowSaveLayerDialog(currentNode.id);
					document.getElementById("DialogSaveLayer").showModal();
				}
				else if (currentNode.image == "SelectColumns.png") {
					//Determining the parent node.
					var nodeids = network.getConnectedNodes(currentNode.id, "from");
					if (nodeids && nodeids.length) {
						if (networkNodes.get(nodeids[0]) && networkNodes.get(nodeids[0]).STAURL)
							ShowTableSelectColumnsDialog(nodeids[0], currentNode.id);

						document.getElementById("DialogSelectColumns").showModal();
					}
				}
				else if (currentNode.image == "SelectRows.png") {
					//Determining the parent node.
					var nodeids = network.getConnectedNodes(currentNode.id, "from");
					if (nodeids && nodeids.length) {
						if (networkNodes.get(nodeids[0]) && networkNodes.get(nodeids[0]).STAURL) {
							document.getElementById("DialogSelectRowsTableInputSpan").innerHTML = "<label><input type='radio' name='DialogSelectRowsRadio' id='DialogSelectRowsTableRadio' checked='checked' onClick='ChangeTableFilterRowsDialog(\"" + nodeids[0] + "\")'/> Select an element:</label>";
							document.getElementById("DialogSelectRowsFilterInputSpan").innerHTML = "<label><input type='radio' name='DialogSelectRowsRadio' id='DialogSelectRowsFilterRadio' onClick='ChangeTableFilterRowsDialog(\"" + nodeids[0] + "\")'/>  Filter:</label>";
							ShowTableSelectRowsDialog(nodeids[0]);
						}
						document.getElementById("DialogSelectRows").showModal();
					}
				}
				else if (IdOfSTAEntity(currentNode) != -1)
				{
					//Offering expand
					ShowTableSelectExpandsDialog(currentNode.id);
					document.getElementById("DialogSelectExpands").showModal();
				}
			}
		});
		network.on("oncontext", function (params) {
			params.event.preventDefault();  //https://stackoverflow.com/questions/38258940/open-an-extension-popup-html-list-on-right-click-of-node-contextmenu-in-visj

			var nodeId = network.getNodeAt(params.pointer.DOM); //params.nodes is not useful here as params.nodes are the selected ones and not the ones rightclicked.
			if (nodeId) {
				startingNodeContextId = nodeId;
				document.getElementById("DialogContextMenu").showModal();
			}
			/*params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "oncontext (right click) event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);*/
		});
		/*network.on("dragStart", function (params) {
			// There's no point in displaying this event on screen, it gets immediately overwritten
			params.event = "[original event]";
			console.log("dragStart Event:", params);
			console.log("dragStart event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});
		network.on("dragging", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "dragging event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("dragEnd", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "dragEnd event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("dragEnd Event:", params);
			console.log("dragEnd event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});
		network.on("controlNodeDragging", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "control node dragging event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("controlNodeDragEnd", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "control node drag end event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("controlNodeDragEnd Event:", params);
		});
		network.on("zoom", function (params) {
			document.getElementById("eventSpanHeading").innerText = "zoom event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("showPopup", function (params) {
			document.getElementById("eventSpanHeading").innerText = "showPopup event: ";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("hidePopup", function () {
			console.log("hidePopup Event");
		});
		network.on("select", function (params) {
			console.log("select Event:", params);
		});
		network.on("selectNode", function (params) {
			console.log("selectNode Event:", params);
		});
		network.on("selectEdge", function (params) {
			console.log("selectEdge Event:", params);
		});
		network.on("deselectNode", function (params) {
			console.log("deselectNode Event:", params);
		});
		network.on("deselectEdge", function (params) {
			console.log("deselectEdge Event:", params);
		});
		network.on("hoverNode", function (params) {
			console.log("hoverNode Event:", params);
		});
		network.on("hoverEdge", function (params) {
			console.log("hoverEdge Event:", params);
		});
		network.on("blurNode", function (params) {
			console.log("blurNode Event:", params);
		});
		network.on("blurEdge", function (params) {
			console.log("blurEdge Event:", params);
		});*/


		function addCircularImage(event, dialog, label, image) {
			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			var newId = (Math.random() * 1e7).toString(32);
			var node = { id: newId, label: label, image: image, shape: "circularImage" };

			if (image == "ogc.png")
			{
				//node.STAURL = "https://citiobs.demo.secure-dimensions.de/inaturalist/v1.1";
				node.STAURL = "https://citiobs.demo.secure-dimensions.de/staplus/v1.1";
				networkNodes.add(node);
				LoadJSONData(node);
			}
			else if (!startingNodeContextId || !StartCircularImage(node, networkNodes.get(startingNodeContextId), true))
			{
				networkNodes.add(node);
				networkEdges.add([{ from: startingNodeContextId, to: newId }]);
			}

			if (startingNodeContextId)
				startingNodeContextId = null;

			network.selectNodes([newId]);
		}

		function removeCircularImage(event, dialog) {
			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			if (startingNodeContextId) {
				networkNodes.remove(startingNodeContextId);
				startingNodeContextId = null;
			}
		}

		function addEdge() {
			network.addEdgeMode();
			connectionInProcess = true;
			document.getElementById("clarification").innerHTML = "Press the mouse botton on the starting node, and drag and drop the mouse on the end node.";
		}

	</script>

</body>

</html>