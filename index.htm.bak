<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>TAPIS: Tables from APIs for Sensors (Sensor Things API plus Explorer)</title>
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	<script type="text/javascript" src="vis.min.js"></script>
	<script type="text/javascript" src="Chart.bundle.min.js" async defer></script>
        <script type="text/javascript" src="chartjs-plugin-labels.js" async defer></script>
	<script type="text/javascript" src="papaparse.min.js" async defer></script>
	<script type="text/javascript" src="hello.all.min.js"></script>
	<script type="text/javascript" src="authenix.js" async defer></script>
	<script type="text/javascript" src="mmn_postmessage.js" async defer></script>
	<script type="text/javascript" src="guf.js" async defer></script>
	<script type="text/javascript" src="xml2json.js" async defer></script>
	<script type="text/javascript" src="data_tables.js"></script>
	<script type="text/javascript" src="STAselectExpand.js"></script>
	<script type="text/javascript" src="selectColumnsDlg.js"></script>
	<script type="text/javascript" src="groupByDlg.js"></script>
	<script type="text/javascript" src="STAfilter.js"></script>
	<script type="text/javascript" src="diagrams.js"></script>

	<link rel="stylesheet" href="tapis.css">
	<link rel="stylesheet" href="vis.min.css">

</head>

<body onLoad="StartSTAPage();" onkeydown="KeySTAPage(event);">
	<table border="0" style="width:100%">
		<tr>
			<td>
				<table>
					<tr>
						<td><img src="logo.png" height="70"></td>
						<td>
							<div style="font-size: 30px; font-weight: bold;">TAPIS</div>
							<div style="font-size: 20px; font-weight: bold;">Tables from OGC APIs for Sensors</div>
							<div style="font-size: 10px; font-weight: normal;"> or a Sensor Things API plus Explorer
							</div>
						</td>
					</tr>
				</table>
			</td>
			<td align="right" valign="top">
				<span id="UserInfoText"></span>
				<button id="buttonReloadSTA" onclick='reloadSTA(event);'><img src="reload.png" height="20" valign="middle"> Refresh</button>
				<label class=labelbotton><img src="OpenNetwork.png" height="20" valign="middle"> Open
				<input type="file" id="openNetworkFileName" hidden onchange='openFileNetwork(event);'/>
				</label> <!-- https://dev.to/faddalibrahim/how-to-create-a-custom-file-upload-button-using-html-css-and-javascript-1c03 -->
				<button onclick='document.getElementById("DialogOpenURLNetwork").showModal();'><img src="OpenURLNetwork.png" height="20" valign="middle"> Open URL</button>
				<button onclick='saveNetwork(event);'><img src="SaveNetwork.png" height="20" valign="middle"> Save</button>
				<button id="buttonOpenLogin" onclick='OpenLogin(event);'><img src="login.png" height="20" valign="middle"> Login</button>
				<button id="buttonOpenLogout" onclick='OpenLogout(event);' style="display: none");'><img src="login.png" height="20" valign="middle"> Logout</button>
				<button onclick='OpenConfiguration(event);'><img src="config.png" height="20" valign="middle">Configuration</button>
				<button onclick='OpenHelp(event);'><img src="help.png" height="20" valign="middle">Help</button>
				<br>
				<span style="font-size: 10px;"><a href="TermsOfUse.htm">Terms of Use</a><br>
					<a href="PrivacyStatement.htm">Privacy Statement</a><br>
					<a href="AccessPolicy.htm">Access Policy</a><br>
				</span>
			</td>
		</tr>
	</table>

	<span id="ButtonsSTAEntities"></span>
	<button onclick="addEdge();">Connect two nodes</button><br>

	<div>
		<div id="mynetwork" style="float: left; width: 59.4%; height: 400px;"></div>
		<div id="clarification" style="float: left; width: 39.5%; margin-left: 0.2%; height: 400px; border: 1px solid gray; overflow-y: auto; overflow-x: scroll;"></div>
	</div>
	<div style="width: 99%; margin-left: 0.2%; height: 400px; border: 1px solid gray; overflow: auto">
		<div id="showQuery" style="display: none;">OGC query URL: <a id="showQueryLink" href="" target="_blank"></a></div>

		<div id="showTableOptions"></div>
		<div id="showTable"</div>
	</div>

	<dialog id="DialogConfiguration">
		<form>
			<p>
				<label>Table font size ratio:
					<input type="text" id="DialogConfigurationFontSize" size="3" value="50"></input>%
				</label>
				<br>
				<span style="display: flex;align-items: center;">Window disposition: 
				<label style="display: flex;align-items: center;"><input type="radio" name="DialogConfigurationDiv" id="DialogConfigurationDivSideBySide" checked="checked"></input><img src="SideBySide.png"></label>
				<label style="display: flex;align-items: center;"><input type="radio" name="DialogConfigurationDiv" id="DialogConfigurationDivOverUnder"></input><img src="OverUnder.png"></label>
				</span>
				<br>
				<label><input type="checkbox" id="DialogConfigurationAddGeolocationHeader"></input>Add geolocation header</label><br>
				<label><input type="checkbox" id="DialogConfigurationOnlyStartNodeButtons"></input>Show start node buttons only</label>
			</p>
			<div class="center">
				<button value="default" onClick="ChangeConfiguration(event)">OK</button>
				<button value="default" onClick="ApplyConfiguration(event)">Apply</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>


	<dialog id="DialogOpenURLNetwork">
		<form>
			<p>
				<label>Network URL:
					<input type="text" id="DialogOpenURLNetworkInput" size="100"></input>
				</label>
				<br>
				<label>Suggested stored networks:
					<select id="DialogOpenURLNetworkSelect" onChange="PopulateInputFromSelect(event, 'DialogOpenURLNetwork');">
						<option "">-- Select an option--</option>
						<option value="help/recipe01_STA_UML_model.json">Recipe 1: Understanding the concept of Datastream in STAplus</option>
						<option value="help/recipe02_PartyObservationsParty.json">Recipe 2, both methods: Show the current evolution of a variable captured by a particular party
						<option value="help/recipe02_01_PartyObservations.json">Recipe 2, cooking method 1: Recurrently selecting a row using entity identifiers
						<option value="help/recipe02_02_ObservationsParty.json">Recipe 2, cooking method 2: Filtering observations
						<option value="help/recipe03_OpenMap.json">Recipe 3: Show a map of all observation features in an STA service
						<option value="help/recipe04_CSV_meaning.json">Recipe 4: Add semantics (meaning) to a table and share, retrieve and store it
						<option value="help/recipe05_spatialFilterTemperature.json">Recipe 5: Selecting temperatures from an area
					</select>
				</label>
			</p>
			<div class="center">
				<button value="default" id="DialogDialogOpenURLNetworkInputOk" onClick="openURLNetwork(event)" formmethod="dialog">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSTAURL">
		<div id="divTitleDialogSTAURL" class="center" style="font-size: large;"></div>
		<form>
			<p>
				<label>Landing page URL:
					<input type="text" id="DialogSTAURLInput" size="100"></input>
				</label>
				<br>
				<label>Suggested services:
					<select id="DialogSTAURLSelect" onChange="PopulateInputFromSelect(event, 'DialogSTAURL')"></select>
				</label>
			</p>
			<div class="center">
				<button value="default" id="DialogSTAURLOk" onClick="GetSTAURLEvent(event)" formmethod="dialog">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSTAViewQuery">
		<form>
			<p>
				STA query URL:
					<a id="DialogSTAViewQueryLink" href="" target="_blank"></a>
			</p>
			<div class="center">
				<button value="cancel" formmethod="dialog">Close</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogCreateUpdateDeleteEntity">
		<form>
			<span id="dlgCreateUpdateDeleteEntityProperties">
			</span>
			<div class="center">
				<button value="default" id="dlgCreateUpdateDeleteEntityCreate" onClick="GetCreateEntity(event)">Create</button>
				<button value="default" id="dlgCreateUpdateDeleteEntityUpdate" onClick="GetUpdateEntity(event)">Update</button>
				<button value="default" id="dlgCreateUpdateDeleteEntityDelete" onClick="AskForDeleteEntity(event)">Delete</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectColumns">
		<form>
			Select columns:
			<span id="DialogSelectColumnsHTML">
			</span>
			<div class="center">
				<button value="default" onClick="GetSelectColumns(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSeparateColumns">
		<form>
			Separate columns:
			<fieldset>
				<legend>Arrays as:</legend>
				<input type="radio" id="DialogSeparateColumnsArrayAs_Columns" name="ArrayAs" value="columns" checked> 
				<label for="DialogSeparateColumnsArrayAs_Columns">columns</label>
				<input type="radio" id="DialogSeparateColumnsArrayAs_Records" name="ArrayAs" value="records"> 
				<label for="DialogSeparateColumnsArrayAs_Records">records</label>
			</fieldset>
			<br>
			<input type="checkbox" id="DialogSeparateColumns_RemovePresent" value="yes"> 
			<label for="DialogSeparateColumns_RemovePresent">Remove already present elements</label>

			<div class="center">
				<button value="default" onClick="SeparateColumns(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogGroupBy">
		<form>
			<table border="0">
			<tr>
			<td rowspan="2">
			<fieldset>
				<legend>GroupBy:</legend>
				<span id="DialogGroupBySelectsHTML">
				</span>
			</fieldset>
			<br>
			<fieldset>
				<legend>GroupBy date rounding:</legend>
				<span id="DialogGroupByDateTimeOptionsHTML">
				</span>
			</fieldset>

			</td>
			<td>
			<fieldset>
				<legend>Attributes to aggregate:</legend>
				<span id="DialogGroupByAttributesAggrHTML">
				</span>
			</fieldset>
			</td>
			</tr>
			<tr>
			<td>
			<fieldset>
				<legend>Aggregations:</legend>
				<span id="DialogGroupByAggregationOptionsHTML">
				</span>
			</fieldset>
			</td>
			</tr>
			</table>
			<div class="center">
				<button value="default" onClick="GetGroupBy(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>
	<dialog id="DialogCreateColumns">
		<form>
			<span id="DialogCreateColumnsHTML">

				<div>
				  <fieldset>
					  <legend>Select your operation:</legend>
					  <input type="radio" id="columnNameRadioType_constantValue" name="TypeOfValues" value="constantValue" checked> 
					  <label for="columnNameRadioType_constantValue">Constant value</label><input id="inputText_constantValue" type="text" style="margin-left:10px" ><br>
					  <input type="radio" id="columnNameRadioType_autoincrementalValue" name="TypeOfValues" value="autoincrementalValue">
					  <label for="columnNameRadioType_autoincrementalValue">Autoincemental value</label><input id="inputText_autoincrementalValue" type="text" style="margin-left:10px"  placeholder="Initial value" ><br>
					  <input type="radio" id="columnNameRadioType_empty" name="TypeOfValues" value="empty">
					  <label for="columnNameRadioType_empty">Empty column</label><br>
				  </fieldset>
				  <br>
				  <fieldset>
					  <legend>Column name:</legend>
					  <input type="radio" name="columnNameRadioCreateColumns" id ="columnNameRadioACreateColumns_personalized" checked="checked"> <!--Function has no sense, it is only to mimic aggregated columns dialog-->
					  <label for ="columnNameRadioACreateColumns_personalized" >Personalized</label>
					  <input id="columnNameCreateColumns" type="text" style="margin-top: 10px; margin-bottom: 10px; "> 
				  </fieldset>
				  <br>
				  <button value="add" onClick="addColumnToListCreateColumn(event)"style="margin-bottom:10px">Add column to list </button>
				  <br><br><hr>
				  <div style="width:auto;" >
					  <label>List of columns to add</label>
					  <span id= spanColumnsListCreateColumns></span>
			  </div>
			  
		
			</span>
			<div class="center" style="margin-top: 10px">
			  <button value="default" onClick="addColumnsToTableInCreateColumns()">Ok</button>
			  <button value="cancel" formmethod="dialog" onclick="cancelButtonRecoveryOldData(event)">Cancel</button>
			</div>
		  </form>
	</dialog>

	<dialog id="DialogAggregateColumns">
		<form>
			<span id="DialogAggregateColumnsHTML">
			  <br>
			<div>
			<fieldset style="display:inline-block">
			  <legend>Select attributes:</legend>
			  <span id="DialogcolumnsFielsetHTML"></span>
				</fieldset>		
			<fieldset style="display:inline-block">
			  <legend>Aggregations:</legend>
			  <span id="operationsFieldSet"></span>
			  </fieldset>
			<br>
			<fieldset style="display:inline-block">
				<legend>Set number of decimal figures:</legend>
				<span>
					<input type="checkbox" id="chooseNumberDecimals_0" name="chooseNumberDecimals" value="yes"> 
					<label for="chooseNumberDecimals_0">Yes: </label>
					<input id="chooseNumberDecimals_0_input" type="number" max="10" min="0">

				</span>
			</fieldset>
		</div>
			  <br>
			<fieldset style="display:inline-block">
			  <legend>Column name: </legend>
			  <input type="radio" name="columnNameRadioAggregateColumns" id="columnNameRadioAggregateColumns_personalized" onchange="deselectColumnNameRadioButton('personalized')">
			  <label for="columnNameRadioAggregateColumns_personalized">Personalized</label>
			  <input disabled=true id="columnNameAggregateColumns" type="text" style="margin-top: 10px; margin-bottom: 10px; " >
			  <br>
			  <input type="radio" name="columnNameRadioAggregateColumns" checked="checked" id="columnNameRadioAggregateColumns_suggested" onchange="deselectColumnNameRadioButton('suggested')">
			  <label for="columnNameRadioAggregateColumns_suggested">Suggested: </label>
			  <span id="columnNameAggregateColumns_span"></span>
			</fieldset>
			<br>
			<br>	
			<button value="add" onClick="addColumnToListAggregateColumns(event)" style="margin-bottom:10px">Add column to
			  list </button>
	
			<br><br><hr>
			<div style="width:auto;">
			  <label>List of columns to add</label>
			  <span id=spanColumnsListAggregateColumns></span>
			  </div>
			</span>
			<div class="center" style="margin-top: 10px">
			<button value="default" onClick="addColumnsToTableInAggregateColumns(event)">Ok</button>
			  <button value="cancel" formmethod="dialog" onclick="cancelButtonRecoveryOldData(event)">Cancel</button>
			</div>
		  </form>
	</dialog>




	<dialog id="DialogColumnsCalculator">
		<form >
			<br>
			<label for="calculator_selectColumns">Attribute:</label>
			<select id="calculator_selectColumns" name="calculator_selectColumnsValue" style="width:400px;" onchange="">
			</select>
		
			<button onclick="WriteInTheFormulaButtons('attributeSelected')" >Write in the formula</button>
			<br><br>
			<fieldset>
			  <legend>Operators and functions for the formula: </legend>
			  <input type="button" style="width:40px" value="&#40;" onclick="WriteInTheFormulaButtons('&#40;')">
			  <input type="button" style="width:40px" value="&#41;" onclick="WriteInTheFormulaButtons('&#41;')">
			  <input type="button" style="width:40px" value="If" onclick="WriteInTheFormulaButtons('? :')">
			  <br>
			  <input type="button" style="width:40px" value="=" onclick="WriteInTheFormulaButtons('==')">
			  <input type="button" style="width:40px" value="&gt;=" onclick="WriteInTheFormulaButtons('>=')">
			  <input type="button" style="width:40px" value="&lt;" onclick="WriteInTheFormulaButtons('<')">&nbsp;&nbsp;&nbsp;&nbsp;
		
		
		
			  <input type="button" style="width:30px" value="7" onclick="WriteInTheFormulaButtons('7')">
			  <input type="button" style="width:30px" value="8" onclick="WriteInTheFormulaButtons('8')">
			  <input type="button" style="width:30px" value="9" onclick="WriteInTheFormulaButtons('9')">&nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:30px" value="/" onclick="WriteInTheFormulaButtons('/')">
			  &nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:40px" value="and" onclick="WriteInTheFormulaButtons('&&')">
		
			  <br>
			  <input type="button" style="width:40px" value="≠" onclick="WriteInTheFormulaButtons('!=')">
			  <input type="button" style="width:40px" value="&lt;=" onclick="WriteInTheFormulaButtons('<=')">
			  <input type="button" style="width:40px" value="&gt;" 	onclick="WriteInTheFormulaButtons('>')">&nbsp;&nbsp;&nbsp;&nbsp;
		
		
			  <input type="button" style="width:30px" value="4" onclick="WriteInTheFormulaButtons('4')">
			  <input type="button" style="width:30px" value="5" onclick="WriteInTheFormulaButtons('5')">
			  <input type="button" style="width:30px" value="6" onclick="WriteInTheFormulaButtons('6')">&nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:30px" value="×" onclick="WriteInTheFormulaButtons('*')">
			  &nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:40px" value="or" onclick="WriteInTheFormulaButtons('||')">
			  <br>
		
			  <input type="button" style="width:40px" value="Log" onclick="WriteInTheFormulaButtons('Math.log10()')">
			  <input type="button" style="width:40px" value="Ln" onclick="WriteInTheFormulaButtons('Math.log()')">
			  <input type="button" style="width:40px" value="xⁿ"
				onclick="WriteInTheFormulaButtons('**')">&nbsp;&nbsp;&nbsp;&nbsp;
		
		
			  <input type="button" style="width:30px" value="1" onclick="WriteInTheFormulaButtons('1')">
			  <input type="button" style="width:30px" value="2" onclick="WriteInTheFormulaButtons('2')">
			  <input type="button" style="width:30px" value="3" onclick="WriteInTheFormulaButtons('3')">&nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:30px" value="-" onclick="WriteInTheFormulaButtons('-')">
			  &nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:40px" value="not" onclick="WriteInTheFormulaButtons('!')">
		
			  <br>
			  <input type="button" style="width:40px" value="Exp" onclick="WriteInTheFormulaButtons('Math.exp()')">
			  <input type="button" style="width:40px" value="%" onclick="WriteInTheFormulaButtons('%')">
			  <input type="button" style="width:40px" value="√¯" onclick="WriteInTheFormulaButtons('Math.sqrt()')">&nbsp;&nbsp;&nbsp;&nbsp;
		
		
			  <input type="button" style="width:30px" value="&#928;" onclick="WriteInTheFormulaButtons('Math.PI')">
			  <input type="button" style="width:30px" value="0" onclick="WriteInTheFormulaButtons('0')">
			  <input type="button" style="width:30px" value="." onclick="WriteInTheFormulaButtons('.')">&nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:30px" value="+" onclick="WriteInTheFormulaButtons('+')">
			  &nbsp;&nbsp;&nbsp;&nbsp;
		
		
			  <input type="button" style="width:40px" value="xor" onclick="WriteInTheFormulaButtons('^')">
		
			  <br>
		
			  <input type="button" style="width:40px" value="1/x" onclick="WriteInTheFormulaButtons('1/()')">
			  <input type="button" style="width:40px" value="Ent" onclick="WriteInTheFormulaButtons('Math.trunc()')">
			  <input type="button" style="width:40px" value="Abs"
				onclick="WriteInTheFormulaButtons('Math.abs()')">&nbsp;&nbsp;&nbsp;&nbsp;
		
			  <input type="button" style="width:30px" value="e" onclick="WriteInTheFormulaButtons('Math.E')">
		
			  <br><br>
			  <input type="button" style="width:62px" value="sin" onclick="WriteInTheFormulaButtons('Math.sin()')">
			  <input type="button" style="width:62px" value="asin" onclick="WriteInTheFormulaButtons('Math.asin()')">
			  <input type="button" style="width:62px" value="cos" onclick="WriteInTheFormulaButtons('Math.cos()')">
			  <input type="button" style="width:62px" value="acos" onclick="WriteInTheFormulaButtons('Math.acos()')">
			  <input type="button" style="width:62px" value="tan" onclick="WriteInTheFormulaButtons('Math.tan()')">
			  <input type="button" style="width:62px" value="atan" onclick="WriteInTheFormulaButtons('Math.atan()')">
		
			  <br>
			  <input type="button" style="width:62px" value="sing"
				onclick="WriteInTheFormulaButtons('Math.sin( *Math.PI/180)')"> 
			  <input type="button" style="width:62px" value="asing"
				onclick="WriteInTheFormulaButtons('Math.asin()*180/Math.PI')">
			  <input type="button" style="width:62px" value="cosg"
				onclick="WriteInTheFormulaButtons('Math.cos( *Math.PI/180)')">
			  <input type="button" style="width:62px" value="acosg"
				onclick="WriteInTheFormulaButtons('Math.acos( *Math.PI/180)')">
			  <input type="button" style="width:62px" value="tang"
				onclick="WriteInTheFormulaButtons('Math.tan( *Math.PI/180)	')">
			  <input type="button" style="width:62px" value="atang"
				onclick="WriteInTheFormulaButtons('Math.atan( *Math.PI/180)')">
			</fieldset>
			<div>
			<label style="position:relative;top:22px">Formula:</label>
			<br>
			
			<textarea id="textAreaFormulaColumnsCalculator" style="width:350px;height:100px;display:inline-block;position:relative;top:27px"></textarea>
			<fieldset  style="display:inline-block;position:relative; top:10px" >
				<legend>Set number of decimal figures:</legend>
				<span>
					<input type="checkbox" id="chooseNumberDecimalsCalculator_0" name="chooseNumberDecimalsCalculator" value="yes"> 
					<label for="chooseNumberDecimalsCalculator_0">Yes: </label>
					<input id="chooseNumberDecimalsCalculator_0_input" type="number" max="10" min="0">
				</span> 
			</fieldset>
		</div>
		<br>
		<fieldset>
			<legend>Column name:</legend>
			<input type="radio" name="columnNameRadioCalculatorColumns" id ="columnNameRadioACalculatorColumns_personalized" checked="checked"> <!--Function has no sense, it is only to mimic aggregated columns dialog-->
			<label for ="columnNameRadioACalculatorColumns_personalized" >Personalized</label>
			<input id="columnNameColumnsCalculator" type="text" style="margin-top: 10px; margin-bottom: 10px; "> 
		</fieldset>
			<br>
			
			<button value="add" onClick="addColumnToListColumnsCalculator(event)" style="margin-bottom:10px">Add column to list
			</button>
			<br>
			<hr>
			<div style="width:auto;" >
				<label>List of columns to add</label>
				<span id= spanColumnsListCalculatorColumns></span>
			  </div>
			<br>
			<div class="center" style="margin-top: 10px">
			  <button value="default" onClick="addColumnsToTableInColumnsCalculator()">Ok</button>
				<button value="cancel" formmethod="dialog" onclick="cancelButtonRecoveryOldData(event)">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectExpands">
		<form>
			<fieldset id="DialogSelectExpandsHTML">
				<legend>Choose subclasses you want details (expand) and attributes to select</legend>
				<span id="DialogSelectExpandsCheckBoxes">
				</span>
			</fieldset>
			<br>
			<label>Number records to request:
				<input type="text" id="SelectExpandsNumberOfRecords" size="6" maxlength="6" value="100"></input>
			</label>
			<div class="center">
				<button value="default" onClick="GetSelectExpands(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>
	<dialog id="DialogFilterRowEntities">
		<form>
			<fieldset id="DialogFilterRowEntitiesHTML">
				<legend>Choose the way to get to the Entity you want to filter</legend>
				<span id="DialogFilterRowEntitiesCheckBoxes"> 
				</span>
			</fieldset>
			
			<div class="center">
				<button value="default" onClick="OkButtonInRowFilterEntities(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectNRecords">
		<form>
			<label>Number records to request:
				<input type="text" id="SelectNumberOfRecords" size="6" maxlength="6" value="100"></input>
			</label>
			<div class="center">
				<button value="default" onClick="GetSelectNRecords(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSelectSortBy">
		<form>
			<fieldset id="DialogSelectSortByHTML">
				<legend>Select the criteria for sorting:</legend>
				<span id="DialogSelectSortByRadioButtons">
				</span>
			</fieldset>
			<br>
			<label><input type="radio" id="SelectSortByAsc" name="SelectSortByArcDesc" checked />ascending</label>
			<label><input type="radio" id="SelectSortByDesc" name="SelectSortByArcDesc" />descending</label>
			<br>
			<label>Number records to request:
				<input type="text" id="SelectSortByNumberOfRecords" size="6" maxlength="6" value="100"></input>
			</label>
			<div class="center">
				<button value="default" onClick="GetSelectSortBy(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>


	<dialog id="DialogSelectRow">
		<div id="divTitleSelectRow" class="center" style="font-size: large;"></div>
		<form>
			Select an element:
			<span id="DialogSelectRowsTable">
			</span>
			<label id="SelectNumberOfRecordsSelectRowLabel">Number records to request:
				<input type="text" id="SelectNumberOfRecordsSelectRow" size="6" maxlength="6" value="100"></input>
			</label>
			<div class="center">
				<button value="default" onClick="GetSelectRow(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogFilterRows">
		<div id="divTitleSelectRows" class="center" style="font-size: large;"></div>
		<form>
			Filter:
			<div id="DialogSelectRowsFilter">
			</div>
			<label id="SelectNumberOfRecordsFilterRowsLabel">Number records to request:
				<input type="text" id="SelectNumberOfRecordsFilterRows" size="6" maxlength="6" value="100"></input>
			</label>
			<div class="center">
				<button value="default" onClick="GetFilterRows(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogJoinTables">
		<form>
			<fieldset>
				<legend>Row matching fields</legend>
				<span id="DialogJoinTablesRowMatching"></span>
				</label>
			</fieldset>
			<fieldset>
				<legend>Merged records that do not match</legend>
				<label><input type="radio" id="DialogJoinTablesNotMatchRemove" name="JoinTablesNotMatch" />Discard</label>
				<label><input type="radio" id="DialogJoinTablesNotMatchLeftTable" name="JoinTablesNotMatch" checked />Add records of 1st table</label>
				<label><input type="radio" id="DialogJoinTablesNotMatchBothTables" name="JoinTablesNotMatch" />Add records from both tables</label>
			</fieldset>
			<div class="center">
				<button value="default" onClick="GetJoinTables(event)">OK</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>


	<dialog id="DialogContextMenu">
		<form>
			<p>
				<span id="ButtonsContextMenuObjects"></span><br>
				<button onclick='removeCircularImage(event, "DialogContextMenu")'>Remove</button>
				<button onclick='renameCircularImage(event, "DialogContextMenu")'>Rename</button><br>
				<!--button onclick='giveMeNetworkInformation(event, "DialogContextMenu")'>Network Info</button><br><br-->
			</p>
			<div class="center">
				<button value="cancel" onClick="startingNodeContextId=null;" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogEdgeContextMenu">
		<form>
			<p>
				<button onclick='removeEdge(event, "DialogEdgeContextMenu")'>Remove</button>
			</p>
			<div class="center">
				<button value="cancel" onClick="startingEdgeContextId=null;" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogOK">
		<form>
			<span id="DialogOKOptions"></span><br>
			<span id="DialogOKHTML">
			</span>
			<div class="center">
				<button value="cancel" formmethod="dialog">Close</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogImportCSV">
		<form>
			Import CSV file table
			<br>
			<fieldset style="display: inline;">
				<legend>Delimiter</legend>
				<label><input type="radio" name="DialogImportCSVDelimiter" id="DialogImportCSVDelimiterText" checked></input><input type="text" id="DialogImportCSVDelimiter" size="1" maxlength="1" value=";"></input></label> &ensp;
				<label><input type="radio" name="DialogImportCSVDelimiter" id="DialogImportCSVDelimiterTab"></input> Tab</label> &ensp;
				<label><input type="radio" name="DialogImportCSVDelimiter" id="DialogImportCSVDelimiterAuto" checked="checked"></input> Auto</label>
			</fieldset>
			Encoding: <select id="DialogImportCSVEncoding">
				<option value="windows-1252">Windows 1252 (Western Latin)</option>
				<!-- This is not suported by browsers. If we need it in the future we should use de work "binary", read the text and convert it ourselves. option value="ibm850">OEM 850 (MS-DOS Latin-1)</option-->
				<option value="">UTF-8</option>
				<option value="iso8859-2">ISO-8859-2 (Latin 2)</option>
				<option value="iso-8859-3">ISO-8859-3 (Latin 3)</option>
				<option value="iso-8859-4">ISO-8859-4 (Latin 4)</option>
				<option value="iso-8859-5">ISO-8859-5 (Cyrillic)</option>
				<option value="iso-8859-6">ISO-8859-6, ecma-114 (Arabic)</option>
				<option value="iso-8859-7"> ISO-8859-7 (greek)</option>
				<option value="iso-8859-8">"ISO-8859-8 (hebrew)</option>
				<option value="iso-8859-8-i">ISO-8859-8-I (logical)</option>
				<option value="iso-8859-10">ISO-8859-10 (Latin 6)</option>
				<option value="iso-8859-11">Windows-874, DOS-874</option>
				<option value="iso-8859-13">ISO-8859-13</option>
				<option value="iso-8859-14">ISO-8859-14</option>
				<option value="iso-8859-15">ISO-8859-15 (Latin 9)</option>
				<option value="iso-8859-16">ISO-8859-16</option>
				<option value="windows-1250">Windows-1250</option>
				<option value="windows-1251">Windows-1251</option>
				<option value="windows-1253">Windows-1253</option>
				<option value="iso-8859-9">ISO 8859-9, windows-1254, Latin 5</option>
				<option value="windows-1255">Windows-1255</option>
				<option value="windows-1256">Windows-1256</option>
				<option value="windows-1257">Windows-1257</option>
				<option value="windows-1258">Windows-1258</option>
				<option value="cp866">IBM866</option>
				<option value="koi8">KOI8-R</option>
				<option value="koi8-ru">KOI8-U</option>
				<option value="macintosh">Macintosh</option>
				<option value="x-mac-cyrillic">X-MAC-Cyrillic</option>
			</select>
			<br>
			<label><input type="checkbox" id="DialogImportCSVHeader" checked="checked"></input>The first line contains field names</label><br>
			<label><input type="checkbox" id="DialogImportCSVStringTyping"></input>Import numbers as strings</label>
			<br>
			<fieldset>
				<legend>Meaning source</legend>
				<label><input type="radio" id="DialogImportMeaningCSVSourceFile" name="DialogImportMeaningCSVSource" value="file" checked="checked" onClick="SelectImportMeaningCSVSource(event)">
				Local CSVW file: <input type="file" id="DialogImportMeaningCSVSourceFileText" accept=".csvw,.json" onChange="ReadFileImportCSVW(event)"></input></label><br>
				<label><input type="radio" id="DialogImportMeaningCSVSourceURL" name="DialogImportMeaningCSVSource" value="url" onClick='SelectImportMeaningFileSource(event, "CSV")'>
				CSVW URL: <input type="text" size="70" id="DialogImportMeaningCSVSourceURLInput" onChange="ReadURLImportCSVW(event)" disabled="disabled"></input> <button type="button" id="DialogImportMeaningCSVSourceURLButton" onClick="ReadURLImportCSVW(event)" disabled="disabled">Load</button></label><br>
				<label><input type="radio" id="DialogImportMeaningCSVSourceAuto" name="DialogImportMeaningCSVSource" value="auto" onClick='SelectImportMeaningFileSource(event, "CSV")'>
				Automatic retrieve of shared meaning</label><br>
			</fieldset>
			<br>
			<fieldset>
				<legend>CSV source</legend>
				<label><input type="radio" id="DialogImportCSVSourceFile" name="DialogImportCSVSource" value="file" checked="checked" onClick='SelectImportFileSource(event, "CSV")'>
				Local file: <input type="file" accept=".csv,*.txt" id="DialogImportCSVSourceFileText" onChange="ReadFileImportCSV(event)"></input></label><br>
				<label><input type="radio" id="DialogImportCSVSourceURL" name="DialogImportCSVSource" value="url" onClick='SelectImportFileSource(event, "CSV")'>
				URL: <input type="text" size="70" id="DialogImportCSVSourceURLInput" onChange="ReadURLImportCSV(event)" disabled="disabled"></input> <button type="button" id="DialogImportCSVSourceURLButton" onClick="ReadURLImportCSV(event)" disabled="disabled">Load</button></label><br>
				<label>Suggested CSV URLs:
					<select id="DialogImportCSVSourceURLSelect" onChange="PopulateInputFromSelect(event, 'DialogImportCSVSourceURL')"></select>
				</label>

			</fieldset>
			<div class="center">
				<button value="ok" formmethod="dialog" onClick='RetrieveMeaningTable(event, "CSV")'>Done</button>
				<button value="cancel" formmethod="dialog">Close</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSaveTable">
		<form>
			Save the table as CSV
			<br>
			<label>CSV delimiter:
				<input type="text" id="DialogSaveTableDelimiter" size="2" maxlength="1" value=";"></input>
			</label>
			<!--span id="DialogSaveTableOptions"></span--><br>
			<div class="center">
				<button value="default" onClick="SaveTable(event)">Save CSV</button>
				<button value="csvw" onClick="SaveCSVW(event)">Save CSVW</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogMeaningTable">
		<form>
			<span id="DialogMeaningTableTitle"></span>
			<br>
			<span id="DialogMeaningFields"></span>
			<div class="center">
				<button value="default" onClick="SaveMeaningTable(event)">Ok</button>
				<button value="share" onClick="ShareMeaningTable(event)">Share</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogImportGeoJSON">
		<form>
			Import GeoJSON
			<br>

			<! tres variants d'importacio 
				* As is
				* Diferent variables in a time series as columns
                                * A time series variable per row
			-->
			
			<fieldset>
				<legend>Meaning source</legend>
				<label><input type="radio" id="DialogImportMeaningGeoJSONSourceFile" name="DialogImportMeaningGeoJSONSource" value="file" checked="checked" onClick='SelectImportMeaningFileSource(event, "GeoJSON");'>
				Local GeoJSON schema file: <input type="file" id="DialogImportMeaningGeoJSONSourceFileText" accept=".json" onChange="ReadFileImportGeoJSONSchema(event)"></input></label><br>
				<label><input type="radio" id="DialogImportMeaningGeoJSONSourceURL" name="DialogImportMeaningGeoJSONSource" value="url" onClick='SelectImportMeaningFileSource(event, "GeoJSON")'>
				GeoJSON schema URL: <input type="text" size="70" id="DialogImportMeaningGeoJSONSourceURLInput" onChange="ReadURLImportGeoJSONSchema(event)" disabled="disabled"></input> <button type="button" id="DialogImportMeaningGeoJSONSourceURLButton" onClick="ReadURLImportGeoJSONSchema(event)" disabled="disabled">Load</button></label><br>
				<label><input type="radio" id="DialogImportMeaningGeoJSONSourceAuto" name="DialogImportMeaningGeoJSONSource" value="auto" onClick='SelectImportMeaningFileSource(event, "GeoJSON");'>
				Automatic retrieve of shared meaning</label><br>
			</fieldset>
			<br>
			<fieldset>
				<legend>GeoJSON source</legend>
				<label><input type="radio" id="DialogImportGeoJSONSourceFile" name="DialogImportGeoJSONSource" value="file" checked="checked" onClick='SelectImportFileSource(event, "GeoJSON")'>
				Local file: <input type="file" accept=".geojson,*.json" id="DialogImportGeoJSONSourceFileText" onChange="ReadFileImportGeoJSON(event)"></input></label><br>
				<label><input type="radio" id="DialogImportGeoJSONSourceURL" name="DialogImportGeoJSONSource" value="url" onClick='SelectImportFileSource(event, "GeoJSON")'>
				URL: <input type="text" size="70" id="DialogImportGeoJSONSourceURLInput" onChange="ReadURLImportGeoJSON(event)" disabled="disabled"></input> <button type="button" id="DialogImportGeoJSONSourceURLButton" onClick="ReadURLImportGeoJSON(event)" disabled="disabled">Load</button></label><br>
				<label>Suggested GeoJSON URLs:
					<select id="DialogImportGeoJSONSourceURLSelect" onChange="PopulateInputFromSelect(event, 'DialogImportGeoJSONSourceURL')"></select>
				</label>
			</fieldset>
			<div class="center">
				<button value="ok" formmethod="dialog" onClick='RetrieveMeaningTable(event, "GeoJSON")'>Done</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogSaveLayer">
		<form>
			<span id="DialogSaveLayerTitle"></span>
			<fieldset>
				<legend>Position:</legend>
				<label>Place description:
					<span id="DialogSaveLayerPlace"></span>
				</label>
				<br>
				<label>Longitude:
					<span id="DialogSaveLayerLongitude"></span>
				</label>
				<br>
				<label>Latitude:
					<span id="DialogSaveLayerLatitude"></span>
				</label>
			</fieldset>
			<br>
			<label>Date and time:
				<span id="DialogSaveLayerTime"></span>
			</label>
			<span id="DialogSaveLayerVariableDefUoM"></span>
			<br>
			<div class="center">
				<span id="DialogSaveLayerSave"></span>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogGUF">
		<form>
			Geospatial user feedback
			<fieldset>
				<legend>Target:</legend>
				<label>Title <small>(mandatory to add)</small>: <input type="text" id="DialogGUFTitleInput"></input></label><br>
				<label>Code*: <input type="text" id="DialogGUFCodeInput"></input></label><br>
				<label>Codespace*: <input type="text" id="DialogGUFCodespaceInput"></input></label>
			</fieldset>
			<br>
			<div class="center">
				<button value="add" onClick="AddGUF(event)">Add feedback</button>
				<button value="edit" onClick='EditGUF(event)'>Edit previous feedback</button>
				<button value="ok" formmethod="dialog" onClick="ShowGUF(event)">Get feedback</button>
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
	</dialog>

	<dialog id="DialogScatterPlot">
		<table border="0"><tr><td>
			<span id="DialogScatterPlotTitle"></span>
			<form>
			<fieldset>
    				<legend>Axes:</legend>
				<label>Axis x:
					<span id="DialogScatterPlotAxisX"></span>
				</label>
				<br>
				<label>Axis y:
					<span id="DialogScatterPlotAxisY"></span>
				</label>
			</fieldset>
			<br>
			<fieldset id="DialogScatterPlotVariableUoM">
    				<legend>Title:</legend>
				<label>Variable name:
					<span id="DialogScatterPlotVariable"></span>
				</label>
				<br>
				<label>Units of measure:
					<span id="DialogScatterPlotUoM"></span>
				</label>
			</fieldset>
			<br>
			<div class="center">
				<button value="draw" onClick="DrawScatterPlot(event)">Draw</button>
				<button value="ok" onClick="CloseDialogScatterPlot(event)" formmethod="dialog">Close</button>
			</div>
			</form>
		</td>
		<td><div id="DialogScatterPlotVisualization" style="width:600px; height:500px;"></div></td>
		</tr></table>
	</dialog>

	<dialog id="DialogBarPlot">
		<table border="0"><tr><td>
			<span id="DialogBarPlotTitle"></span>
			<form>
			<fieldset>
    				<legend>Plot type:</legend>
				<label><input type="radio" name="DialogBarPlotType" id="DialogBarPlotTypeBar" checked="checked"></input>Bar</label>
				<label><input type="radio" name="DialogBarPlotType" id="DialogBarPlotTypePie"></input>Pie</label>
			</fieldset>
			<fieldset>
    				<legend>Axes:</legend>
				<label>Categories:
					<span id="DialogBarPlotAxisX"></span>
				</label>
				<br>
				<label>Values:
					<span id="DialogBarPlotAxisY"></span>
				</label>
				<br>
				<label>Variable name:
					<span id="DialogBarPlotVariable"></span>
				</label>
			</fieldset>
			<br>
			<div class="center">
				<button value="draw" onClick="DrawBarPlot(event)">Draw</button>
				<button value="ok" onClick="CloseDialogBarPlot(event)" formmethod="dialog">Close</button>
			</div>
			</form>
		</td>
		<td><div id="DialogBarPlotVisualization" style="width:600px; height:500px;">
				<canvas id="DialogBarPlotVisualizationCanvas" style="width:100%; height:100%;"></canvas></div></td>
		</tr></table>
	</dialog>

	<dialog id="DialogImageViewer">
		<table border="0"><tr><td>
			<span id="DialogImageViewerTitle"></span>
			<form>
			<fieldset>
    				<legend>Image Sources:</legend>
				<label>Image URL:
					<span id="DialogImageViewerURL"></span>
				</label><br>
				<label>Label:
					<span id="DialogImageViewerLabel"></span>
				</label>
			</fieldset>
			<label>Image size (px):
				<input type="text" id="DialogImageViewerSizeInput" value="200"></input>
			</label>
			<br>
			<div class="center">
				<button value="draw" onClick="DrawImageViewer(event)">Draw</button>
				<button value="ok" onClick="CloseDialogImageViewer(event)" formmethod="dialog">Close</button>
			</div>
			</form>
		</td></tr>
		<tr><td><div id="DialogImageViewerVisualization" style="width:900px; height:550px;"></div></td>
		</tr></table>
	</dialog>

	<dialog id="DialogOneValue">
		<span id="DialogOneValueTitle"></span>
		<form>
		<fieldset>
			<label>Variable:
				<span id="DialogOneValueVariable"></span>
			</label>
			<br>
			<label>Observation time:
				<span id="DialogOneValueTime"></span>
			</label>
			<br>
			<label>Refresh time:
				<input type="text" id="DialogOneValueRefreshPeriod" size="3" value="20"></input> seconds
			</label>
		</fieldset>
		<br>
		<div class="center">
			<button value="ok" onClick="PrepareRefreshOneValue(event)">Ok</button>
			<button value="stop" onClick="StopRefreshOneValue(event)">Stop refresh</button>
			<button value="cancel" onClick="CloseDialogOneValue(event)" formmethod="dialog">Close</button>
		</div>
		</form>
	</dialog>
	<dialog id="DialogCountResults">
		<span id="DialogCountResultsTitle"></span>
		<form>
		<fieldset>
			<label>Refresh time:
				<input type="text" id="DialogCountResultsRefreshPeriod" size="3" value="20"></input> seconds
			</label>
		</fieldset>
		<br>
		<div class="center">
			<button value="ok" onClick="prepareRefreshCountResults(event)" >Ok</button>
			<button value="ok"  onClick="stopRefreshCountResults(event)" >Stop refresh</button>
			<button value="cancel" onClick="closeDialogCountResults(event)" formmethod="dialog">Close</button>
		</div>
		</form>
	</dialog>

	<dialog id="DialogUploadObservations">
		<div id="DialogUploadObservationsLoginFirst" style="display: none;">
			<form>
				To upload data in a STA server, you should Login first.<br>
				<div class="center">
					<button value="cancel" formmethod="dialog">Cancel</button>
				</div>
			</form>
		</div>
		<form id="DialogUploadObservationsForm">
			Upload table as STA observations
			<br>
			<label><input type="radio" name="DialogUploadObservationsRadio" id="DialogUploadObservationsObsPropsInARow" checked="checked"></input>Each row represents a feature of interest with several observed properties</label>
			<br>
			<label><input type="radio" name="DialogUploadObservationsRadio" id="DialogUploadObservationsObsPropsInAColumn" disabled></input>Several observed properties of the same feature in a single column and in multiple rows</label>
			<fieldset>
				<legend>Position:</legend>
				<label>Place description:
					<span id="DialogUploadObservationsPlace"></span>
				</label>
				<br>
				<label>Longitude:
					<span id="DialogUploadObservationsLongitude"></span>
				</label>
				<br>
				<label>Latitude:
					<span id="DialogUploadObservationsLatitude"></span>
				</label>
			</fieldset>
			<label>Date and time:
				<span id="DialogUploadObservationsTime"></span>
			</label>
			<br>
			<label>Sensor instance id or name:
				<span id="DialogUploadObservationsSensorName"></span>
			</label>
			<br>
			<label>Sensor reference or type:
				<span id="DialogUploadObservationsSensorType"></span>
			</label>
			<br>
			<label>STA service URL:
				<input type="text" id="DialogSTAUploadURLInput" size="100"></input>
			</label>
			<div class="center">
				<button value="ok" onClick="UploadObservationsSTAURL(event)" formmethod="dialog">Upload</button>
			</div>
		</form>
	</dialog>

	<!--dialog id="UploadTimeAverages">
		<div id="UploadTimeAveragesLoginFirst" style="display: none;">
		<form>
			To upload data in a STA server, you should Login first.<br>
			<div class="center">
				<button value="cancel" formmethod="dialog">Cancel</button>
			</div>
		</form>
		</div>
		<form id="UploadTimeAveragesForm">
			Upload Datastream as STA time averages
			<br>
			<label>STA target service URL:
				<input type="text" id="DialogTimeAveragesSTAUploadURLInput" size="100"></input>
			</label>
			<div class="center">
				<button value="ok" onClick="UploadTimeAveragesSTAURL(event)" formmethod="dialog">Upload</button>
			</div>
		</form>
	</dialog-->


	<!--h2 id="eventSpanHeading"></h2>
	<pre id="eventSpanContent"></pre-->

	<script type="text/javascript">
		"use strict"

		/* 
			This file is part of TAPIS. TAPIS is a web page and a Javascript code 
			that builds queries and explore the STAplus content, saves it as CSV or 
			GeoJSON and connects with the MiraMon Map Browser. While the project is 
			completely independent from the Orange data mining software, it has been 
			inspired by its GUI. The general idea of the application is to be able 
			to work with STA data as tables.
		  
			The TAPIS client is free software under the terms of the MIT License
		
			Copyright (c) 2023 Joan Masó
		
			Permission is hereby granted, free of charge, to any person obtaining a copy
			of this software and associated documentation files (the "Software"), to deal
			in the Software without restriction, including without limitation the rights
			to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
			copies of the Software, and to permit persons to whom the Software is
			furnished to do so, subject to the following conditions:
		
			The above copyright notice and this permission notice shall be included in all
			copies or substantial portions of the Software.
		
			THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
			IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
			FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
			AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
			LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
			OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
			SOFTWARE.
		    
			The TAPIS can be updated from https://github.com/joanma747/tapis.
		
			Aquest codi JavaScript ha estat idea de Joan Masó Pau (joan maso at uab cat) 
			dins del grup del MiraMon. MiraMon és un projecte del 
			CREAF que elabora programari de Sistema d'Informació Geogràfica 
			i de Teledetecció per a la visualització, consulta, edició i anàlisi 
			de mapes ràsters i vectorials. Aquest progamari programari inclou
			aplicacions d'escriptori i també servidors i clients per Internet.
			No tots aquests productes són gratuïts o de codi obert. 
		    
			En particular, el TAPIS es distribueix sota els termes de la llicència MIT.
		    
			El TAPIS es pot actualitzar des de https://github.com/joanma747/tapis.
		*/

		var config;

		const ServicesAndAPIs = {sta: {name: "STA plus", description: "Add STA service", startNode: true},
					ogcAPIs: {name: "OGC API", description: "Add OGC API collection", startNode: true},
					csw: {name: "Catalogue", description: "Add OGC CSW", startNode: true},
					ImportCSV: {name: "CSV", description: "Import CSV", startNode: true},
					ImportGeoJSON: {name: "GeoJSON", description: "Import GeoJSON", startNode: true},
					staRoot: {name: "STA root", description: "STA root"}};
		const ServicesAndAPIsArray = Object.keys(ServicesAndAPIs);
		const STAEntities = {
			ObservedProperties: { singular: "ObservedProperty", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "definition", dataType: "URI", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Observations: { singular: "Observation", entities: [{ name: "Datastream", required: "true" }, { name: "MultiDatastream", required: "true" }, { name: "FeatureOfInterest", required: "false" }, { name: "ObservationGroups", required: "false" }, { name: "Subjects", required: "false" }, { name: "Objects", required: "false" }], properties: [{ name: "phenomenonTime", dataType: "object", required: "true" }, { name: "resultTime", dataType: "isodatetime", required: "true" }, { name: "result", dataType: "", required: "true" }, { name: "resultQuality", dataType: "object", required: "false" }, { name: "validTime", dataType: "data_isoperiod", required: "false" }, { name: "parameters", dataType: "JSON", required: "false" }], entityRelations: ["Object", "Subject"] },
			FeaturesOfInterest: { singular: "FeatureOfInterest", entities: [{ name: "Observations", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "encodingType", dataType: "string", required: "true" }, { name: "feature", dataType: "", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Sensors: { singular: "Sensor", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "encodingType", dataType: "string", required: "true" }, { name: "metadata", dataType: "", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Things: { singular: "Thing", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }, { name: "Party", required: "true" }, { name: "Locations", required: "true" }, { name: "HistoricalLocations", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Locations: { singular: "Location", entities: [{ name: "Things", required: "false" }, { name: "HistoricalLocations", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "encodingType", dataType: "string", required: "true" }, { name: "location", dataType: "", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			HistoricalLocations: { singular: "HistoricalLocation", entities: [{ name: "Things", required: "true" }, { name: "Location", required: "true" }], properties: [{ name: "time", dataType: "isodatetime", required: "true" }] },
			Datastreams: { singular: "Datastream", entities: [{ name: "Party", required: "true" }, { name: "Sensor", required: "true" }, { name: "ObservedProperty", required: "true" }, { name: "Campaigns", required: "false" }, { name: "License", required: "false" }, { name: "Observations", required: "false" }, { name: "Thing", required: "true" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "observationType", dataType: "string", required: "true" }, { name: "unitOfMeasurement", dataType: "JSON", required: "true" }, { name: "observedArea", dataType: "object", required: "false" }, { name: "phenomenonTime", dataType: "data_isoperiod", required: "false" }, { name: "resultTime", dataType: "data_isoperiod", required: "false" }, { name: "properties", dataType: "JSON", required: "false" }] },
			MultiDatastreams: { singular: "MultiDatastream", entities: [{ name: "Party", required: "true" }, { name: "Sensor", required: "true" }, { name: "ObservedProperty", required: "true" }, { name: "Campaigns", required: "false" }, { name: "License", required: "false" }, { name: "Observations", required: "false" }, { name: "Thing", required: "true" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "observationType", dataType: "string", required: "true" }, { name: "unitOfMeasurement", dataType: "JSON", required: "true" }, { name: " observedArea", dataType: "object", required: "false" }, { name: "phenomenonTime", dataType: "data_isoperiod", required: "false" }, { name: "resultTime", dataType: "data_isoperiod", required: "false" }, { name: "multiObservationDataType", dataType: "JSON", required: "true" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Parties: { singular: "Party", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }, { name: "Campaigns", required: "false" }, { name: "ObservationGroups", required: "false" }, { name: "Things", required: "false" }], properties: [{ name: "description", dataType: "string", required: "false" }, { name: "authId", dataType: "string", required: "false" }, { name: "role", dataType: "PartyRoleCode", required: "true" }, { name: "displayName", dataType: "string", required: "false" }] },
			Campaigns: { singular: "Campaign", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }, { name: "Party", required: "true" }, { name: "License", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "classification", dataType: "string", required: "false" }, { name: "termsOfUse", dataType: "string", required: "true" }, { name: "privacyPolicy", dataType: "string", required: "false" }, { name: "creationTime", dataType: "isodatetime", required: "true" }, { name: "url", dataType: "URI", required: "false" }, { name: "startTime", dataType: "isodatetime", required: "false" }, { name: "endTime", dataType: "isodatetime", required: "false" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Licenses: { singular: "License", entities: [{ name: "Datastreams", required: "false" }, { name: "MultiDatastreams", required: "false" }, { name: "Campaigns", required: "false" }, { name: "ObservationGroups", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "definition", dataType: "URI", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "logo", dataType: "string", required: "false" }, { name: "attributionText", dataType: "JSON", required: "false" }] },
			ObservationGroups: { singular: "ObservationGroup", entities: [{ name: "Party", required: "true" }, { name: "Campaigns", required: "false" }, { name: "License", required: "false" }, { name: "Observations", required: "false" }, { name: "Relations", required: "false" }], properties: [{ name: "name", dataType: "string", required: "true" }, { name: "description", dataType: "string", required: "true" }, { name: "purpose", dataType: "string", required: "false" }, { name: "creationTime", dataType: "isodatetime", required: "false" }, { name: "endTimecreationTime", dataType: "isodatetime", required: "false" }, { name: "termsOfUsed", dataType: "string", required: "false" }, { name: "privacyPolicy", dataType: "string", required: "false" }, { name: "dataQuality", dataType: "JSON", required: "false" }, { name: "properties", dataType: "JSON", required: "false" }] },
			Relations: { singular: "Relation", entities: [{ name: "Object", required: "true" }, { name: "Subject", required: "true" }, { name: "ObservationGroups", required: "false" }], properties: [{ name: "role", dataType: "URI", required: "true" }, { name: "description", dataType: "string", required: "false" }, { name: "externalObject", dataType: "URI", required: "false" }, { name: "properties", dataType: "JSON", required: "false" }], entityRelations: ["Objects", "Subjects"] }
		};
		const STAEntitiesArray = Object.keys(STAEntities);
		const STASpecialQueries = {ObsLayer: {description: "Observations Layer", query: "Observations?$orderby=phenomenonTime%20desc&$expand=Datastream($select=unitOfMeasurement),Datastream/ObservedProperty($select=name,description,definition),FeatureOfInterest($select=description,feature)&$select=phenomenonTime,result"}}
		const STASpecialQueriesArray = Object.keys(STASpecialQueries);
		const TableOperations = {Table: {description: "View Table", leafNode: true}, 
					Meaning: {description: "Fields meaning"}, 
					SelectColumnsSTA: {description: "Select Columns", callSTALoad: true},
					ExpandColumnsSTA: {description: "Expand Columns", callSTALoad: true},
					SelectRowSTA: {description: "Select Row", callSTALoad: true},
					FilterRowsSTA: {description: "Filter Rows", callSTALoad: true},
					GeoFilterRowsSTA: {description: "Geospatial Filter Rows", callSTALoad: true},
					SortBySTA: {description: "Sort by", callSTALoad: true},
					ViewQuerySTA: {description: "View Query", leafNode: true},
					UploadObservations: {description: "Upload in STA", leafNode: true},
					//UploadTimeAverages: {description: "Upload time averages", leafNode: true},
					SelectColumnsTable: {description: "Select Columns"},
					SelectRowTable: {description: "Select Row"},
					JoinTables: {description: "Join Tables"},
					FilterRowsTable: {description: "Filter Rows"},
					GroupBy: {description: "GroupBy"},
					AggregateColumns:{description: "Aggregate Columns"},
					CreateColumns:{description: "Create Columns"},
					ColumnsCalculator:{description: "Columns calculator"},
					SeparateColumns: {description: "Separate Columns"},
					ScatterPlot: {description: "Scatter Plot", leafNode: true},
					BarPlot: {description: "Bar Plot", leafNode: true},
					ImageViewer: {description: "Image Viewer", leafNode: true},
					OneValueSTA: {description: "One Value", leafNode: true},
					CountResultsSTA: { description: "Count results", leafNode: true },
					SaveTable: {description: "Save Table", leafNode: true},
					SaveLayer: {description: "Save Layer", leafNode: true},
					OpenMap: {description: "Open Map", leafNode: true},
					guf: {description: "Feedback", leafNode: true}};

		const TableOperationsArray = Object.keys(TableOperations);

		//If the two nodes cannot connect it returns null. It transforms a plural to singular if needed.
		function transformToSingularIfNeededSTAEntity(parentEntity, entityName) {
			//Determinino si ha de ser singular o plural
			for (var i=0; i<parentEntity.entities.length; i++)
			{			
				if (parentEntity.entities[i].name==entityName)
					return entityName;
				else if (parentEntity.entities[i].name==STAEntities[entityName].singular)
					return STAEntities[entityName].singular;
			}
			return null;
		}

		//considerEntityRelations means that in some paths you can find "Subject, Object..." that are relations to "Observations" Entity 
		function getSTAEntityPlural(entityName, considerEntityRelations) {
			for (var i=0; i<STAEntitiesArray.length; i++) {
				if (STAEntities[STAEntitiesArray[i]].singular==entityName)
					return STAEntitiesArray[i];
			}
			if (considerEntityRelations) {
				for (var i=0; i<STAEntitiesArray.length; i++) {
					if ( STAEntities[STAEntitiesArray[i]].entityRelations) {
						for (var j=0; j<STAEntities[STAEntitiesArray[i]].entityRelations.length; j++) {
							if (STAEntities[STAEntitiesArray[i]].entityRelations[j]==entityName)
								return STAEntitiesArray[i];
						}
					}
				}
			}
			return entityName;
		}

		function getConnectionSTAEntity(parentNode, node) {
			var parentPlural, parentEntity;
			var idNode=IdOfSTAEntity(node);
			if (idNode<0)
				return {error: "Node is not a STA entity"};
			var parentLastEntity=getSTAURLLastEntity(parentNode.STAURL);
			if (STAEntities[parentLastEntity]){
				parentPlural=true;
				parentEntity=STAEntities[parentLastEntity];
			} else {
				for (var i=0; i<STAEntitiesArray.length; i++)
				{
					if (STAEntities[STAEntitiesArray[i]].singular==parentLastEntity)
					{
						parentPlural=false;
						parentEntity=STAEntities[STAEntitiesArray[i]];
						break;
					}
				}
				if (i==STAEntitiesArray.length)
					return {error: "Parent node is not a STA entity"};
			}

			var nextEntity=removeExtension(node.image);

			if (!STAEntities[nextEntity])
				return {error: "Child node is not a STA entity"};

			if (parentPlural)
			{
				if (null!=getSTAURLSelectingARow(parentNode.STAURL))
				{
					//Determinino si ha de ser singular o plural
					var entityName=transformToSingularIfNeededSTAEntity(parentEntity, nextEntity)
					if (entityName)
						return {entity: entityName};
					else{
						var n=parentEntity.entities.length, s= n ? parentEntity.entities[0].name : "";
						for (var t=1; t<n; t++)
							s+=", " + parentEntity.entities[t].name;
						return {error: "The node connection does not match the STA data model. Connect '" + parentLastEntity + "' to one of the following: " + s};
					}
				}
				else
				{
					//Is parentNode plural? Everything is incompatible
					return {error: "A plural parent node requires selecting a row before being connectable to another STA entity"};
				}
			}
			//else
			//Is parentNode singular?
			var entityName=transformToSingularIfNeededSTAEntity(parentEntity, nextEntity);
			if (entityName)
				return {entity: entityName};
			else{
				var n=parentEntity.entities.length, s= n ? parentEntity.entities[0].name : "";
				for (var t=1; t<n; t++)
					s+=", " + parentEntity.entities[t].name;
				return {error: "The node connection does not match the STA data model. Connect '"+ parentLastEntity +"' to one of the following: " + s};
			}
		}

		//Return null if there is no reason (and there is a "fit").
		function reasonNodeDoesNotFitWithPrevious(node, parentNode) {
			if (parentNode.image == "sta.png" && (node.image == "FilterRowsSTA.png" || node.image == "SelectRowSTA.png" || node.image == "GeoFilterRowsSTA.png" || node.image == "SelectColumnsSTA.png" || node.image == "ExpandColumnsSTA.png" || node.image == "SortBySTA.png" || node.image == "OneValueSTA.png" || node.image == "CountResultsSTA.png" ) )
				return "The operation cannot be applied to the root of an STA. (Suggestion: connect a STA Entity first)";
			if (parentNode.image=="sta.png" || parentNode.image=="ogcAPIs.png" || parentNode.image=="csw.png")
				return null;
			if (TableOperations[removeExtension(parentNode.image)] && TableOperations[removeExtension(parentNode.image)].leafNode==true)
				return "Parent node is a leaf node and cannot be connected with any other node";
			if (node.image=="OneValueSTA.png" && parentNode.image!="Observations.png")
				return "'One value' node is designed be connected to an 'Observations' node only.";
			var idNode=IdOfSTAEntity(node);
			if (idNode<0)
				return null;
			if (!parentNode.STAURL)
				return null;
			var getCon=getConnectionSTAEntity(parentNode, node)
			if (getCon.error)
				return getCon.error;
			return null;
		}


		window.onbeforeunload = function () { return "Your work will be lost."; }

		function showInfoMessage(msg){
			var elem=document.getElementById("clarification");
			elem.innerHTML += (msg + "<br>");
			elem.scrollTop=elem.scrollHeight;  //https://stackoverflow.com/questions/11715646/scroll-automatically-to-the-bottom-of-the-page
		}

		function getURLWithoutQueryParams(s)
		{
			var i=s.indexOf('?')
			if (i==-1)
				return s;
			return s.substring(0, i);
		}

		function getURLQueryParams(s)
		{
			var i=s.indexOf('?')
			if (i==-1)
				return "";
			return s.substring(i+1);
		}


		//Returns the id of the selected resource in the last part of the path. So extracts in the "entities(id)" extracts the id
		function getSTAURLSelectingARow(url)
		{
			var s=getURLWithoutQueryParams(url);
			var i=(s.charAt(s.length-1)=='/')? s.length-2 : s.length-1

			if (s.charAt(i)!=')')
				return null;
			var ii=s.lastIndexOf('(');
			if (ii==-1)
				return null;
			if (ii>s.lastIndexOf('/')+2)
			{
				var id=s.substring(ii+1, i);
				if (id.charAt(0)=='\'' && id.charAt(id.length-1)=='\'')
					return id.substring(1, id.length-1);
				return id;
			}
			return null;
		}

		//Get the last entity of the path (without the filter, selection, expantion... or selection of a single entity by using (id))
		function getSTAURLLastEntity(url)
		{
			var s=getURLWithoutQueryParams(url);
			var i=(s.charAt(s.length-1)=='/')? s.length-2 : s.length-1;

			if (s.charAt(i)!=')')
			{
				i=s.lastIndexOf('/')
				if (-1!=s)
					return s.substring(i+1);
				return s;
			}
			i=s.lastIndexOf('(');
			if (i==-1)
				return s;
			var ii=s.lastIndexOf('/');
			if (i>ii+2)
				return s.substring(ii+1, i);
			return s.substring(ii+1);
		}

		function removeSTAURLNoQueryLastEntity(s)
		{
			var entity;
			var i=(s.charAt(s.length-1)=='/')? s.length-2 : s.length-1;

			if (s.charAt(i)!=')')
			{
				i=s.lastIndexOf('/')
				if (-1==s)
					return null;
				entity=s.substring(i+1);
				return STAEntities[getSTAEntityPlural(entity, false)] ? s.substring(0, i) : null;
			}
			i=s.lastIndexOf('(');
			if (i==-1)
				return null;
			var ii=s.lastIndexOf('/');
			if (i>ii+2) {
				entity=s.substring(ii+1, i);
				return STAEntities[getSTAEntityPlural(entity, false)] ? s.substring(0, ii) : null;
			}
			entity=s.substring(ii+1);
			return STAEntities[getSTAEntityPlural(entity, false)] ? s.substring(0, ii) : null;
		}

		function getSTAURLRoot(url) {
			var s, urlRoot=getURLWithoutQueryParams(url);
			while (null!=(s=removeSTAURLNoQueryLastEntity(urlRoot))) {
				urlRoot=s;
			}
			return urlRoot;
		}

		//From the MiraMon Map Browser TreuAdreca()
		function getFileName(s)
		{
			var i=s.lastIndexOf('/');
			if (i==-1)
				i=s.lastIndexOf('\\');
			if (i==-1)
				return s;
			return s.substring(i+1);
		}

		//From the MiraMon Map Browser DonaAdreca()
		function getAddressPath(s)
		{
			if (s.charAt(s.length-1)=='/')
				return s;
			var i=s.lastIndexOf('/');
			if (i==-1)
				return "";
			return s.substring(0, i);
		}

		//from the MiraMon Map Browser DonaAdrecaAbsoluta()
		function getAbsoluteURL(url)
		{
			if (url.length>8 && (url.substring(0, 7)=="http://" || url.substring(0, 8)=="https://"))
				return url;
			if (url.charAt(0)=="/")
				return location.protocol+"//"+location.host+url;
			return location.protocol+"//"+location.host+getAddressPath(location.pathname)+url;
		}

		function removeExtension(name){
			var i=name.lastIndexOf(".");
			if (i==-1)
				return name;
			return name.substring(0, i);
		}


		function getLang() {
			if (navigator.languages != undefined)
				return navigator.languages[0];
			return navigator.language;
		}

		function removeExtraAmpersand(queryparams) {
			if (!queryparams)
				return queryparams;
			var s;
			if (queryparams.charAt(0)=='&') {
				s=queryparams.substring(1);
				if (!s)
					return s;
			}
			else
				s=queryparams;
			if (queryparams.charAt(s.length-1)=='&')
				return s.substring(0, queryparams.length-1);
			return s;
		}

		//Before it was called AddKVPToURL
		function AddQueryParamsToURL(url, kvp) {
			kvp=removeExtraAmpersand(kvp);
			if (!kvp)
				return url;
			if (url.indexOf('?')==-1)
				return url + "?" + kvp;
			return url + "&" + kvp;
		}

		function GetQueryParamFromURL(url, queryparam) {
			var queryparams=getURLQueryParams(url);
			var kvp=queryparams.split("&");
			for(var i=0; i<kvp.length; i++) {
				var j = kvp[i].indexOf("=");  // Gets the first index where a space occours
				if (j==-1)
					continue;
				if (kvp[i].substring(0, j)==queryparam)
					return kvp[i].substring(j+1);
			}
			return null;
		}

		function RemoveQueryParamFromURL(url, queryparam) {
			var queryparams=getURLQueryParams(url);
			if (!queryparams)
				return url;
			var kvp=queryparams.split("&");
			for(var i=0; i<kvp.length; i++) {
				var j = kvp[i].indexOf("=");  // Gets the first index where a space occours
				if (j==-1)
					continue;
				if (kvp[i].substring(0, j)==queryparam){
					kvp.splice(i, 1);
					if (kvp.length)
						return getURLWithoutQueryParams(url)+'?'+kvp.join('&');
					return getURLWithoutQueryParams(url)
				}
			}
			return url;
		}

		//https://stackoverflow.com/questions/50036922/change-a-css-stylesheets-selectors-properties/50036923#50036923
		function changeCSSStyle(selector, cssProp, cssVal) {
			var ssMain = 0;  //The first stylesheet
			var cssRules = (document.all) ? 'rules': 'cssRules';

			for (var i=0, len=document.styleSheets[ssMain][cssRules].length; i<len; i++) {
				if (document.styleSheets[ssMain][cssRules][i].selectorText === selector) {
					document.styleSheets[ssMain][cssRules][i].style[cssProp] = cssVal;
					return;
				}
			}
		}

		//Returns the protocol of a URL without the double slash
		function getProtocol(s){
			var pos_barrabarra;
			if (-1!=(pos_barrabarra=s.indexOf("://")))
				return s.substring(0, pos_barrabarra+1);
			return "";
		}

		var IdGPSPosition=0;
		function InitGPSPosition() {
			if (navigator.geolocation)
				IdGPSPosition=navigator.geolocation.watchPosition(UpdateGPSPosition, ErrorGPSPosition, {enableHighAccuracy: true, maximumAge: 8000});
			else
			{
				showInfoMessage("Geolocation not supported by the web browser");
				CancelGPSPosition();
			}
		}

		var PreviousGPSPoint=null;

		function CancelGPSPosition() {
			if (IdGPSPosition) {
				navigator.geolocation.clearWatch(IdGPSPosition);
				IdGPSPosition=0;
			}
			PreviousGPSPoint=null;
		}

		var GPSPositionReported=false;
		function UpdateGPSPosition(position) {
			PreviousGPSPoint={long: position.coords.longitude, lat: position.coords.latitude};
			if (!GPSPositionReported)
			{
				showInfoMessage("Geolocation is long: " + PreviousGPSPoint.long + " lat: " + PreviousGPSPoint.lat);
				GPSPositionReported=true;
			}
		}

		function ErrorGPSPosition(error) {
			switch(error.code) {
				case error.PERMISSION_DENIED:
					showInfoMessage("User denied request location.");
					CancelGPSPosition();
					break;
				case error.POSITION_UNAVAILABLE:
					showInfoMessage("Location information is unavailable.");
					CancelGPSPosition();
					break;
				case error.TIMEOUT:
					showInfoMessage("Request location timeOut.");
					CancelGPSPosition();
					break;
				case error.UNKNOWN_ERROR:
				default:
					showInfoMessage("Unknown error obtaining Location (" + error.code + ").");
					break;
			}
		}

		var currentNode=null, connectionInProcess=false, startingNodeContextId=null, startingEdgeContextId=null;

		function StartSTAPage() {

			var s_protocol=getProtocol(location.href);

			if (s_protocol && s_protocol.toLowerCase()!="https:")
				location.replace("https:" + location.href.substring(s_protocol.length));

			hello.init({"authenix": "662eb5eb-e706-40a4-baf8-51016fec5a05"}, {redirect_uri: ((location.pathname.charAt(location.pathname.length-1)=='/') ? location.pathname.substring(0, location.pathname.length-1) : location.pathname)});

			UpdateConfiguration();

			InitSTAPage();  //promise
		}

		function PlaceButtonsSTAEntities() {
			var s = "";
			if (!document.getElementById("DialogConfigurationOnlyStartNodeButtons").checked) {
				for (var i = 0; i < ServicesAndAPIsArray.length; i++)
					s += "<button onclick='addCircularImage(null, null, \"" + ServicesAndAPIs[ServicesAndAPIsArray[i]].name + "\", \"" + ServicesAndAPIsArray[i] + ".png\");'><img src='" + ServicesAndAPIsArray[i] + ".png' height='20' valign='middle'> " + ServicesAndAPIs[ServicesAndAPIsArray[i]].description + "</button> ";
				s += "<br>";
				for (var i = 0; i < STAEntitiesArray.length; i++)
					s += "<button onclick='addCircularImage(null, null, \"" + STAEntitiesArray[i] + "\", \"" + STAEntitiesArray[i] + ".png\");'><img src='" + STAEntitiesArray[i] + ".png' height='20' valign='middle'> " + STAEntitiesArray[i] + "</button> ";
				s += "<br>";
				/*for (var i = 0; i < STAEntitiesArray.length; i++)
					s += "<button onclick='addCircularImage(null, null, \"" + STAEntities[STAEntitiesArray[i]].singular + "\", \"" + STAEntities[STAEntitiesArray[i]].singular + ".png\");'><img src='" + STAEntities[STAEntitiesArray[i]].singular + ".png' height='20' valign='middle'> " + STAEntities[STAEntitiesArray[i]].singular + "</button> ";
				s += "<br>";*/
				for (var i = 0; i < STASpecialQueriesArray.length; i++)
					s += "<button onclick='addCircularImage(null, null, \"" + STASpecialQueriesArray[i] + "\", \"" + STASpecialQueriesArray[i] + ".png\");'><img src='" + STASpecialQueriesArray[i] + ".png' height='20' valign='middle'> " + STASpecialQueries[STASpecialQueriesArray[i]].description + "</button> ";
				s += "<br>";
			}

			for (var i = 0; i < TableOperationsArray.length; i++) {
				if (!document.getElementById("DialogConfigurationOnlyStartNodeButtons").checked || TableOperations[TableOperationsArray[i]].startNode)
					s += "<button onclick='addCircularImage(null, null, \"" + TableOperations[TableOperationsArray[i]].description + "\", \"" + TableOperationsArray[i] + ".png\");'><img src='" + TableOperationsArray[i] + ".png' height='20' valign='middle'> " + TableOperations[TableOperationsArray[i]].description + "</button> ";
			}
			if (!document.getElementById("DialogConfigurationOnlyStartNodeButtons").checked)
				s += "<br>";

			document.getElementById("ButtonsSTAEntities").innerHTML = s;
		}

		async function InitSTAPage() {
			var response=await HTTPJSONData("config.json");
			config=(response && response.obj) ? response.obj : null;
			if (!config)
			{
				showInfoMessage("Error loading \'config.json\'");
				return;
			}
			
			PlaceButtonsSTAEntities();
			var s = "";
			for (var i = 0; i < ServicesAndAPIsArray.length; i++) {
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + ServicesAndAPIs[ServicesAndAPIsArray[i]].name + "\", \"" + ServicesAndAPIsArray[i] + ".png\");'><img src='" + ServicesAndAPIsArray[i] + ".png' height='20' valign='middle'> " + ServicesAndAPIs[ServicesAndAPIsArray[i]].description + "</button> ";
				s += (i+1)%3==0 || i == STAEntitiesArray.length-1 ? "<br>" : " ";
			}
			s += "<br>";
			for (var i = 0; i < STAEntitiesArray.length; i++) {
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + STAEntitiesArray[i] + "\", \"" + STAEntitiesArray[i] + ".png\");'><img src='" + STAEntitiesArray[i] + ".png' height='20' valign='middle'> " + STAEntitiesArray[i] + "</button>";
				s += (i+1)%3==0 || i == STAEntitiesArray.length-1 ? "<br>" : " ";
			}
			s += "<br>";
			for (var i = 0; i < STAEntitiesArray.length; i++)
			{
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + STAEntities[STAEntitiesArray[i]].singular + "\", \"" + STAEntities[STAEntitiesArray[i]].singular + ".png\");'><img src='" + STAEntities[STAEntitiesArray[i]].singular + ".png' height='20' valign='middle'> " + STAEntities[STAEntitiesArray[i]].singular + "</button>";
				s += (i+1)%3==0 || i == STAEntitiesArray.length-1 ? "<br>" : " ";
			}
			s += "<br>";
			for (var i = 0; i < STASpecialQueriesArray.length; i++)
			{
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + STASpecialQueriesArray[i] + "\", \"" + STASpecialQueriesArray[i] + ".png\");'><img src='" + STASpecialQueriesArray[i] + ".png' height='20' valign='middle'> " + STASpecialQueries[STASpecialQueriesArray[i]].description + "</button>";
				s += (i+1)%3==0 || i == STASpecialQueriesArray.length-1 ? "<br>" : " ";
			}
			s += "<br>";
			for (var i = 0; i < TableOperationsArray.length; i++)
			{
				s += "<button onclick='addCircularImage(event, \"DialogContextMenu\", \"" + TableOperations[TableOperationsArray[i]].description + "\", \"" + TableOperationsArray[i] + ".png\");'><img src='" + TableOperationsArray[i] + ".png' height='20' valign='middle'> " + TableOperations[TableOperationsArray[i]].description + "</button>";
				s += (i+1)%3==0 || i == TableOperationsArray.length-1 ? "<br>" : " ";
			}

			document.getElementById("ButtonsContextMenuObjects").innerHTML = s;
		}

		function removeParamContentType(contentType) {
			if (!contentType)
				return contentType;
			var i=contentType.indexOf(';')
			if (i<0)
				return contentType;
			else
				return contentType.substring(0, i);
		}

		var CriptoName=null, DisplayName="";
		function AddHeadersIfNeeded(options) {
			if (CriptoName &&
			    hello("authenix").getAuthResponse() &&
			    hello("authenix").getAuthResponse().access_token) {
				if (!options.headers)
					options.headers={};
				options.headers['Authorization']='Bearer ' + hello("authenix").getAuthResponse().access_token;
			}
			if (PreviousGPSPoint)
			{
				if (!options.headers)
					options.headers={};
				options.headers['Geolocation']='geo:' + PreviousGPSPoint.lat + ',' + PreviousGPSPoint.long;
			}
		}

		//'type' is optional
		function getLinkRelInLinks(links, rel, type) {
			if (!links)
				return null;
			for (var i=0; i<links.length; i++) {
				var link=links[i];
				if (link?.rel==rel){
					if (!link.type || !type || link.type==type)
						return link.href;
				}
			}
			return null;
		}

		function simplifyOGCAPICollections(collections){
			var simpleCollecs=[];
			for (var i=0; i<collections.length; i++) {
				var collection=collections[i];
				simpleCollecs.push({id: collection?.id,
						title: collection?.title,
						link: getLinkRelInLinks(collection?.links, "self", "application/json"),
						extent: collection?.extent,
						itemType: collection?.itemType,
      						storageCrs: collection?.storageCrs,
						defaultStyle: collection?.defaultStyle});
			}
			return simpleCollecs;
		}

		function getSimplifyOGCCSWRecord(metadatas){
			var simpleUrlRecords=[], id, title, bbox, schema;
			for (var i=0; i<metadatas.length; i++)
			{
				var metadata=metadatas[i];
				if (!metadata || !metadata['gmd:distributionInfo'])
					continue;
				id=""
				if (metadata['gmd:fileIdentifier'] && metadata['gmd:fileIdentifier']['gco:CharacterString'])
					id=metadata['gmd:fileIdentifier']['gco:CharacterString'];
				title="";
				schema="";
				bbox=[];
				if (metadata['gmd:identificationInfo']) {
					var identification=(typeof metadata['gmd:identificationInfo'].length==="undefined") ? (metadata['gmd:identificationInfo']['gmd:MD_DataIdentification'] ? metadata['gmd:identificationInfo']['gmd:MD_DataIdentification'] : metadata['gmd:identificationInfo']['srv:SV_ServiceIdentification']) : (metadata['gmd:identificationInfo'][0]['gmd:MD_DataIdentification'] ? metadata['gmd:identificationInfo'][0]['gmd:MD_DataIdentification'] : metadata['gmd:identificationInfo'][0]['srv:SV_ServiceIdentification']);
					if (identification && identification['gmd:citation']) {	
						var citation=identification['gmd:citation']['gmd:CI_Citation'];
						if (citation && citation['gmd:title']['gco:CharacterString'])
							title=citation['gmd:title']['gco:CharacterString'];
					}
					//Detemine the extent
					if (identification && (identification['srv:extent'] || identification['gmd:extent'])) {
						var extents=identification['srv:extent'] ? identification['srv:extent'] : identification['gmd:extent'];
						var ex_len=(typeof extents.length==="undefined") ? 1 : extents.length; 
						for (var ex=0; ex<ex_len; ex++) {
							var extent=(typeof extents.length==="undefined") ? extents['gmd:EX_Extent'] : extents[ex]['gmd:EX_Extent'];
							if (extent && extent['gmd:geographicElement']) {
								var ge_len=(typeof extent['gmd:geographicElement'].length==="undefined") ? 1 : extent['gmd:geographicElement'].length; 
								for (var ge=0; ge<ge_len; ge++) {
									var geoElem=(typeof extent['gmd:geographicElement'].length==="undefined") ? extent['gmd:geographicElement'] : extent['gmd:geographicElement'][ge];
									var gbb=extent['gmd:geographicElement']['gmd:EX_GeographicBoundingBox'];
									if (gbb) {
										var n=0;
										if (gbb['gmd:westBoundLongitude'] && gbb['gmd:westBoundLongitude']['gco:Decimal']) {
											bbox.push(parseFloat(gbb['gmd:westBoundLongitude']['gco:Decimal']));
											n++;
										}
										if (gbb['gmd:southBoundLatitude'] && gbb['gmd:southBoundLatitude']['gco:Decimal']) {
											bbox.push(parseFloat(gbb['gmd:southBoundLatitude']['gco:Decimal']));
											n++;
										}
										if (gbb['gmd:eastBoundLongitude'] && gbb['gmd:eastBoundLongitude']['gco:Decimal']) {
											bbox.push(parseFloat(gbb['gmd:eastBoundLongitude']['gco:Decimal']));
											n++;
										}
										if (gbb['gmd:northBoundLatitude'] && gbb['gmd:northBoundLatitude']['gco:Decimal']) {
											bbox.push(parseFloat(gbb['gmd:northBoundLatitude']['gco:Decimal']));
											n++;
										}
										if (n!=4)
											bbox=[];
									}
								}
							}
						}
					}
				}
				if (metadata['gmd:applicationSchemaInfo']) {
					var asi_len=(typeof metadata['gmd:applicationSchemaInfo'].length==="undefined") ? 1 : metadata['gmd:applicationSchemaInfo'].length;
					for (var asi=0; asi<asi_len; asi++) {
						var appSchemaInfo=(typeof metadata['gmd:applicationSchemaInfo'].length==="undefined") ? metadata['gmd:applicationSchemaInfo']['gmd:MD_ApplicationSchemaInformation'] : metadata['gmd:applicationSchemaInfo'][asi]['gmd:MD_ApplicationSchemaInformation'];
						if (appSchemaInfo['gmd:schemaLanguage'] && appSchemaInfo['gmd:schemaLanguage']['gco:CharacterString'].toLowerCase()=="json" && 
							appSchemaInfo['gmd:constraintLanguage'] && appSchemaInfo['gmd:constraintLanguage']['gco:CharacterString'].toLowerCase()=="csvw")
						{
							if (appSchemaInfo['gmd:name']['gmd:CI_Citation']['gmd:title'] && appSchemaInfo['gmd:name']['gmd:CI_Citation']['gmd:title']['gmx:Anchor'] && appSchemaInfo['gmd:name']['gmd:CI_Citation']['gmd:title']['gmx:Anchor']['@xlink:href']) {
								schema=appSchemaInfo['gmd:name']['gmd:CI_Citation']['gmd:title']['gmx:Anchor']['@xlink:href'];
								break;
							}
						}
					}
				}

				//There can be many online resources. For each online resource, a record is create.
				var d_len=(typeof metadata['gmd:distributionInfo'].length==="undefined") ? 1 : metadata['gmd:distributionInfo'].length
				for (var d=0; d<d_len; d++) {
					var distribution=(typeof metadata['gmd:distributionInfo'].length==="undefined") ? metadata['gmd:distributionInfo']['gmd:MD_Distribution'] : metadata['gmd:distributionInfo'][d]['gmd:MD_Distribution'];
					if (!distribution || !distribution['gmd:transferOptions'])
						continue;
					var dt_len=(typeof distribution['gmd:transferOptions'].length==="undefined") ? 1 : distribution['gmd:transferOptions'].length 
					for (var dt=0; dt<dt_len; dt++) {
						var digitalTransfer=(typeof distribution['gmd:transferOptions'].length==="undefined") ? distribution['gmd:transferOptions']['gmd:MD_DigitalTransferOptions'] : distribution['gmd:transferOptions'][dt]['gmd:MD_DigitalTransferOptions'];
						if (!digitalTransfer || !digitalTransfer['gmd:onLine'])
							continue;
						var ol_len=(typeof digitalTransfer['gmd:onLine'].length==="undefined") ? 1 : digitalTransfer['gmd:onLine'].length;
						for (var ol=0; ol<ol_len; ol++) {
							var online=(typeof digitalTransfer['gmd:onLine'].length==="undefined") ? digitalTransfer['gmd:onLine']['gmd:CI_OnlineResource'] : digitalTransfer['gmd:onLine'][ol]['gmd:CI_OnlineResource'];
							if (!online['gmd:linkage'] || !online['gmd:linkage']['gmd:URL'])
								continue;
							simpleUrlRecords.push({
								id: metadata['gmd:fileIdentifier']['gco:CharacterString'],
								title: title,
								dataURL: online['gmd:linkage']['gmd:URL'],
								schemaURL: schema});
							if (online['gmd:name'] && online['gmd:name']['gco:CharacterString'])
								simpleUrlRecords[simpleUrlRecords.length-1].distribution=online['gmd:name']['gco:CharacterString'];
							if (bbox.length)
								simpleUrlRecords[simpleUrlRecords.length-1].extent=bbox;
						}
					}
				}
			}
			return simpleUrlRecords; 
		}

		async function getSimplifyGUFRecord(metadatas){
			var simpleUrlRecords=[], id, title;
			for (var i=0; i<metadatas.length; i++)
			{
				var metadata=metadatas[i];
				if (!metadata)
					continue;
				simpleUrlRecords.push({
					id: metadata['id'],
					title: metadata['title'],
					updated: metadata['updated']});
				var response=await HTTPJSONData(metadata['link']['@href']);
				var wpsexecute=(response && response.text) ? response.text : null;
				if (!wpsexecute) {
					showInfoMessage("Error retrieving "+metadata['link']['@href']);
					return;
				}
				var wpsex=JSON.parse(xml2json(parseXml(wpsexecute), false, null));
				if (!wpsex || !wpsex['wps:ExecuteResponse'] || !wpsex['wps:ExecuteResponse']['wps:ProcessOutputs'] || !wpsex['wps:ExecuteResponse']['wps:ProcessOutputs']['wps:Output'] || !wpsex['wps:ExecuteResponse']['wps:ProcessOutputs']['wps:Output'].length) {
					showInfoMessage("Error retrieving "+metadata['link']['@href']);
					return;
				}
				var outp=wpsex['wps:ExecuteResponse']['wps:ProcessOutputs']['wps:Output'][wpsex['wps:ExecuteResponse']['wps:ProcessOutputs']['wps:Output'].length-1]
				if (!outp || !outp['wps:Data'] || !outp['wps:Data']['wps:ComplexData'] || !outp['wps:Data']['wps:ComplexData']['guf:GUF_FeedbackItem']) {
					showInfoMessage("Error retrieving "+metadata['link']['@href']);
					return;
				}
				var feedbackItem=outp['wps:Data']['wps:ComplexData']['guf:GUF_FeedbackItem'];
				if (!feedbackItem['guf:abstract'] || !feedbackItem['guf:abstract']['gco:CharacterString'])
					continue;
				simpleUrlRecords[simpleUrlRecords.length-1].abstract=feedbackItem['guf:abstract']['gco:CharacterString'];
				if (!feedbackItem['guf:contact'] || 
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation'] || 
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails'] || 
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual'] || 
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual']['cit:partyIdentifier'] || 
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual']['cit:partyIdentifier']['mcc:MD_Identifier'] ||
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual']['cit:partyIdentifier']['mcc:MD_Identifier']['mcc:description'] ||
				    !feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual']['cit:partyIdentifier']['mcc:MD_Identifier']['mcc:description']['gco:CharacterString'])
					continue;
				simpleUrlRecords[simpleUrlRecords.length-1].owner=feedbackItem['guf:contact']['guf:GUF_UserInformation']['guf:userDetails']['cit:CI_Individual']['cit:partyIdentifier']['mcc:MD_Identifier']['mcc:description']['gco:CharacterString']
				if (!feedbackItem['guf:rating'] || 
				    !feedbackItem['guf:rating']['guf:GUF_Rating'] || 
				    !feedbackItem['guf:rating']['guf:GUF_Rating']['guf:rating'] || 
				    !feedbackItem['guf:rating']['guf:GUF_Rating']['guf:rating']['guf:GUF_RatingCode'] || 
				    !feedbackItem['guf:rating']['guf:GUF_Rating']['guf:rating']['guf:GUF_RatingCode']['@codeListValue'])
					continue;
				simpleUrlRecords[simpleUrlRecords.length-1].rating=feedbackItem['guf:rating']['guf:GUF_Rating']['guf:rating']['guf:GUF_RatingCode']['@codeListValue'];
				if (!feedbackItem['guf:userComment'] || 
				    !feedbackItem['guf:userComment']['guf:GUF_UserComment'] || 
				    !feedbackItem['guf:userComment']['guf:GUF_UserComment']['guf:comment'] || 
				    !feedbackItem['guf:userComment']['guf:GUF_UserComment']['guf:comment']['gco:CharacterString']) 
					continue;
				simpleUrlRecords[simpleUrlRecords.length-1].comment=feedbackItem['guf:userComment']['guf:GUF_UserComment']['guf:comment']['gco:CharacterString'];
			}
			return simpleUrlRecords;
		}

		function standardStatusText(status){
			switch (status){
				case 400:
					return "Bad Request. The request cannot be fulfilled due to bad syntax.";
				case 401: 
					return "Unauthorized. The request was a legal request, but the server is refusing to respond to it. Please authenticate using the Login button and try again.";
				case 403:
					return "Forbidden. The request was a legal request, but the server is refusing to respond to it.";
				case 404: 
					return "Not Found. The requested page could not be found but may be available again in the future.";
				case 405: 
					return "Method Not Allowed. A request was made of a page using a request method not supported by that page.";
				case 406: 
					return "Not Acceptable. The server can only generate a response that is not accepted by the client.";
				case 407: 
					return "Proxy Authentication Required. The client must first authenticate itself with the proxy.";
				case 408: 
					return "Request Timeout. The server timed out waiting for the request.";
				case 409: 
					return "Conflict. The request could not be completed because of a conflict in the request.";
				case 410: 
					return "Gone. The requested page is no longer available.";
				case 411: 
					return "Length Required. The \"Content-Length\" is not defined. The server will not accept the request without it.";
				case 412: 
					return "Precondition Failed. The precondition given in the request evaluated to false by the server.";
				case 413: 
					return "Request Too Large. The server will not accept the request, because the request entity is too large.";
				case 414: 
					return "Request-URI Too Long. The server will not accept the request, because the URI is too long. Occurs when you convert a POST request to a GET request with a long query information.";
				case 415: 
					return "Unsupported Media Type	The server will not accept the request, because the media type is not supported."; 
				case 416: 
					return "Range Not Satisfiable. The client has asked for a portion of the file, but the server cannot supply that portion.";
				case 417: 
					return "Expectation Failed.";
				default:
					return "";
			}
		}

		//https://web.dev/fetch-api-error-handling/
		//Despite its name it can also be used for retrieving non-json files (data as text in value.text).
		//To do GET it can be used with the first parameter only 
		async function HTTPJSONData(url, headersToGet, method, objToSend) {
			var response, jsonData, options={};
			try {
				if (method)
					options.method=method;
				options.headers={'Accept': 'application/json, */*;q=0.8'};

				AddHeadersIfNeeded(options);
				if (objToSend)
				{
					options.headers['Content-Type']='application/json';
					options.body=JSON.stringify(objToSend);
				}
				response = await fetch(url, options);
			}
			catch (error) {
				showInfoMessage('There was an error with ' + url + ": " + error.message);
				console.log('There was an error', error);
				return;
			}
			// Uses the 'optional chaining' operator
			if (!(response?.ok)) {
				var body;
				if (removeParamContentType(response.headers.get('Content-Type'))=="application/json" &&
					(response.headers.get('Content-Length')==null || parseInt(response.headers.get('Content-Length'))>0)) {
					body=await response.json();
					body=JSON.stringify(body);
				}
				else
					body=await response.text();
				showInfoMessage("Error: HTTP " + (method ? method : "GET") + " URL: " + url + ", HTTP code: " + response?.status + ", Description: "+ (response.statusText ? response.statusText : standardStatusText(response.status)) + (body ? ", " + body : ""));
				console.log("HTTP Response Code: " + response?.status + ": " + response?.statusText + (body ? JSON.stringify(body) : ""));
				return response;
			}
			try {
				var headersObj={};
				if (headersToGet)
				{
					for (var i=0; i<headersToGet.length; i++)
						headersObj[headersToGet[i]]=response.headers.get(headersToGet[i]);
					//Enumetates all headers: for(let entry of response.headers.entries()) console.log(entry) })
				}
				if (removeParamContentType(response.headers.get('Content-Type'))=="application/json" &&
					(response.headers.get('Content-Length')==null || parseInt(response.headers.get('Content-Length'))>0))
					return {obj: await response.json(), responseHeaders: headersObj, ok: true};
				else
					return {obj: null, text: await response.text(), responseHeaders: headersObj, ok: true};
			} catch (error) {
				if (error instanceof SyntaxError) {
					showInfoMessage('Syntax error reading ' + url + ": " + error.message);
					console.log('There was a SyntaxError', error);
					return;
				}
				else {
					showInfoMessage('Error interpreting ' + url + ": " + error.message);
					console.log('There was an error', error);
					return;
				}
			}
		}

		async function LoadJSONNodeSTAData(node, callback, url) {
			var response, jsonData, options={};
			try {
				var url_fetch;
				if (url)
					url_fetch=url;
				else if (typeof node.STAExpectedLength==="undefined")
					url_fetch=node.STAURL;
				else
					url_fetch=AddQueryParamsToURL(node.STAURL, ((node.OGCType == "OGCAPIcollections" || node.OGCType == "OGCAPIitems") ? "limit=" : ((node.OGCType == "GUF") ? "COUNT=" : "$top=")) + node.STAExpectedLength);

				AddHeadersIfNeeded(options);

				if (options.headers)
					response = await fetch(url_fetch, options);
				else
					response = await fetch(url_fetch);
			}
			catch (error) {
				showInfoMessage('There was an error with ' + node.STAURL + ": " + error.message);
				console.log('There was an error', error);
				node.STAdata = null;
				networkNodes.update(node);
				return;
			}
			// Uses the 'optional chaining' operator
			if (!(response?.ok)) {
				showInfoMessage("HTTP Response Code: " + response?.status + " reading <small>" + node.STAURL + "</small>: " + response?.statusText);
				console.log("HTTP Response Code: " + response?.status + ": " + response?.statusText);
				node.STAdata = null;
				networkNodes.update(node);
				return;
			}
			try {
				if (node.OGCType=="OGCCSW" || node.OGCType=="GUF")
				        jsonData = JSON.parse(xml2json(parseXml(await response.text()), false, null));
				else
					jsonData = await response.json();
			} catch (error) {
				if (error instanceof SyntaxError) {
					showInfoMessage('Syntax error reading ' + node.STAURL + ": " + error.message);
					console.log('There was a SyntaxError', error);
					node.STAdata = null;
					networkNodes.update(node);
					return;
				}
				else {
					showInfoMessage('Error interpreting ' + node.STAURL + ": " + error.message);
					console.log('There was an error', error);
					node.STAdata = null;
					networkNodes.update(node);
					return;
				}
			}
			if (url && typeof node.STAExpectedLength!=="undefined") {
				if (node.OGCType=="OGCAPIcollections")
					node.STAdata = node.STAdata.concat(simplifyOGCAPICollections(jsonData.collections));
				else if (node.OGCType=="OGCAPIitems")
					node.STAdata = node.STAdata.concat(TransformGeoJSONToTable(jsonData));
				else if (node.OGCType=="OGCCSW")
					node.STAdata = node.STAdata.concat(getSimplifyOGCCSWRecord(jsonData['csw:GetRecordsResponse']['csw:SearchResults']['gmd:MD_Metadata']));
				else if (node.OGCType=="GUF")
					node.STAdata = node.STAdata.concat(await getSimplifyGUFRecord(jsonData['feed']['entry']));
				else
					node.STAdata = node.STAdata.concat(jsonData.value);
					
				if (node.STAdata.length>node.STAExpectedLength)  //too much data. Trucating
					node.STAdata.length=node.STAExpectedLength;
			} else { 
				var nextLink;
				if (node.OGCType=="OGCAPIcollections") {
					node.STAdata = (typeof jsonData.collections!=="undefined") ? simplifyOGCAPICollections(jsonData.collections) : [jsonData];
					nextLink = getLinkRelInLinks(jsonData["links"], "next", "application/json");
				} else if (node.OGCType=="OGCAPIitems") {
					node.STAdata = (jsonData.type=="FeatureCollection") ? TransformGeoJSONToTable(jsonData) : [jsonData];
					nextLink = getLinkRelInLinks(jsonData["links"], "next", "application/geo+json");
				} else if(node.OGCType=="OGCAPIitem") {
					node.STAdata = (jsonData.type=="FeatureCollection") ? TransformGeoJSONToTable(jsonData) : [jsonData];
					//nextLink?
				} else if (node.OGCType=="OGCCSW") {
					node.STAdata = getSimplifyOGCCSWRecord(jsonData['csw:GetRecordsResponse']['csw:SearchResults']['gmd:MD_Metadata']);
				} else if (node.OGCType=="GUF") {
					node.STAdata = await getSimplifyGUFRecord(jsonData['feed']['entry']);
				} else {
					node.STAdata = (typeof jsonData.value!=="undefined") ? jsonData.value : [jsonData];
					nextLink = jsonData["@iot.nextLink"];
				}
			}

			if (jsonData.value && node.STAExpectedLength && node.STAdata.length<node.STAExpectedLength && nextLink)
			{
				networkNodes.update(node);
				await LoadJSONNodeSTAData(node, callback, jsonData["@iot.nextLink"]);
			}
			else
			{
				if (node.image!="sta.png" && !node.OGCType && node.image!="staRoot.png")
				{
					node.STAdataAttributes=getDataAttributes(node.STAdata);
					addSemanticsSTADataAttributes(node.STAdataAttributes, node.STAURL);
				}
				networkNodes.update(node);
				showInfoMessage("Completed.");
				var nodeId = network.getSelectedNodes();
				for (var i=0; i<nodeId.length; i++) {
					if (nodeId[i]==node.id) {
						ShowQueryNode(node);
						ShowTableNode(node);
					}
				}
				await UpdateChildenLoadJSONCallback(node);
				if (callback)
					callback(node);  //The callback function is never used yet.
			}
		}

		var savedFile = null;

		function MakeHrefData(data, mediatype)
		{
			var blobData = new Blob([data], {type: mediatype});

			// If we are replacing a previously generated file we need to
			// manually revoke the object URL to avoid memory leaks.
			if (savedFile !== null)
				window.URL.revokeObjectURL(savedFile);

			savedFile = window.URL.createObjectURL(blobData);
			return savedFile;
		}

		//type should be "CSV" or "GeoJSON"
		function SelectImportFileSource(event, type) {
			if (document.getElementById("DialogImport"+type+"SourceFile").checked) {
				document.getElementById("DialogImport"+type+"SourceFileText").disabled=false;
				document.getElementById("DialogImport"+type+"SourceURLInput").disabled=true;
				document.getElementById("DialogImport"+type+"SourceURLButton").disabled=true;
			} else /*if (document.getElementById("DialogImport"+type+"SourceURL").checked)*/ {
				document.getElementById("DialogImport"+type+"SourceFileText").disabled=true;
				document.getElementById("DialogImport"+type+"SourceURLInput").disabled=false;
				document.getElementById("DialogImport"+type+"SourceURLButton").disabled=false;
			}
		}

		//type should be "CSV" or "GeoJSON"
		function SelectImportMeaningFileSource(event, type) {
			if (document.getElementById("DialogImportMeaning"+type+"SourceFile").checked) {
				document.getElementById("DialogImportMeaning"+type+"SourceFileText").disabled=false;
				document.getElementById("DialogImportMeaning"+type+"SourceURLInput").disabled=true;
				document.getElementById("DialogImportMeaning"+type+"SourceURLButton").disabled=true;
			} else if (document.getElementById("DialogImportMeaning"+type+"SourceURL").checked) {
				document.getElementById("DialogImportMeaning"+type+"SourceFileText").disabled=true;
				document.getElementById("DialogImportMeaning"+type+"SourceURLInput").disabled=false;
				document.getElementById("DialogImportMeaning"+type+"SourceURLButton").disabled=false;
			} else /*if (document.getElementById("DialogImportMeaning"+type+"SourceAuto").checked)*/ {
				document.getElementById("DialogImportMeaning"+type+"SourceFileText").disabled=true;
				document.getElementById("DialogImportMeaning"+type+"SourceURLInput").disabled=true;
				document.getElementById("DialogImportMeaning"+type+"SourceURLButton").disabled=true;
			}
		}

		function RetrieveMeaningTableCallback(usage_descr, params_function) {
			if (usage_descr.codeMediaType=="application/json" && usage_descr.schema==urlSchemaMeaning)
				params_function.node.STAdataAttributes=JSON.parse(usage_descr.code);  //The saved format is tha TAPIS internal format
			networkNodes.update(params_function.node);
			showInfoMessage("Meaning retrieved from NiMMbus.");
		}

		function RetrieveMeaningTable(event, type) {
			event.preventDefault(); // We don't want to submit this form
			if (document.getElementById("DialogImportMeaning"+type+"SourceAuto").checked && 
				document.getElementById("DialogImport"+type+"SourceURL").checked &&
				document.getElementById("DialogImport"+type+"SourceURLInput").value) {
				var urlCSV=document.getElementById("DialogImport"+type+"SourceURLInput").value
				GUFLoadLastPreviousReproducibleUsageCode(getFileName(urlCSV),
					getAddressPath(getAbsoluteURL(urlCSV)), 
					{ru_platform: "https://github.com/joanma747/TAPIS", 
					ru_version: 0.9
					//ru_schema: urlSchemaMeaning
				}, "eng", null, RetrieveMeaningTableCallback, {node: currentNode});
			}
			UpdateChildenTable(currentNode);
			if (!currentNode.STAdata) {
				if (confirm("No data has been loaded. Do you want to close this window anyway?"))
					document.getElementById("DialogImport"+type).close();
			}
			else
				document.getElementById("DialogImport"+type).close();
		}

		function TransformTextCSVWToDataAttributes(csvwText)
		{
			var data_csvw=JSON.parse(csvwText);
			currentNode.STAdataAttributes=getDataAttributesCSVW(data_csvw);
			networkNodes.update(currentNode);
			UpdateChildenTable(currentNode);
			var csvReadParams = getCSVReadParams(data_csvw);
			if (csvReadParams.delimiter) {
				document.getElementById("DialogImportCSVDelimiterAuto").checked=false;
				if ( csvReadParams.delimiter=='\t') {
					document.getElementById("DialogImportCSVDelimiter").value="";
					document.getElementById("DialogImportCSVDelimiterTab").checked=true;
					document.getElementById("DialogImportCSVDelimiterText").checked=false;
				} else {
					document.getElementById("DialogImportCSVDelimiter").value=csvReadParams.delimiter;
					document.getElementById("DialogImportCSVDelimiterTab").checked=false;
					document.getElementById("DialogImportCSVDelimiterText").checked=true;
				}
			} else {
				document.getElementById("DialogImportCSVDelimiterAuto").checked=true; 
				document.getElementById("DialogImportCSVDelimiterText").checked=false;
				document.getElementById("DialogImportCSVDelimiterTab").checked=false;
				document.getElementById("DialogImportCSVDelimiter").value=="";
			}
			if (csvReadParams.header)
				document.getElementById("DialogImportCSVHeader").checked=csvReadParams.header;
			if (csvReadParams.dynamicTyping)
				document.getElementById("DialogImportCSVStringTyping").checked=csvReadParams.dynamicTyping ? false : true;
		}

		function ReadFileImportCSVW(event) {
			var input = event.target;

			var reader = new FileReader();
			reader.onload = function() {
				//Transform the JSON text into a STAdataAttributes structure in memory
				try
				{
					TransformTextCSVWToDataAttributes(reader.result);
				}
				catch (e) 
				{
					showInfoMessage("JSON message parse error: " + e + " The file content is:\n" + reader.result);
					currentNode.STAdataAttributes=null;
					networkNodes.update(currentNode);
					return;
				}
			};
			reader.readAsText(input.files[0]);
		}

		function ReadURLImportCSVW() {
			HTTPJSONData(document.getElementById("DialogImportMeaningCSVSourceURLInput").value).then(
						function(value) { 
							showInfoMessage('Download CSVW completed.'); 
							TransformTextCSVWToDataAttributes(value.text);
						},
						function(error) { 
							showInfoMessage('Error downloading CSVW. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;
						}
					);	
		}


		function TransformTextGeoJSONSchemaToDataAttributes(jsonText)
		{
			return getDataAttributesGeoJSONSchema(JSON.parse(jsonText));
		}

		function ReadFileImportGeoJSONSchema(event) {
			var input = event.target;

			var reader = new FileReader();
			reader.onload = function() {
				//Transform the JSON text into a STAdataAttributes structure in memory
				try
				{
					currentNode.STAdataAttributes=TransformTextGeoJSONSchemaToDataAttributes(reader.result);
					networkNodes.update(currentNode);
					UpdateChildenTable(currentNode);
				}
				catch (e) 
				{
					showInfoMessage("JSON message parse error: " + e + " The file content is:\n" + reader.result);
					currentNode.STAdataAttributes=null;
					networkNodes.update(currentNode);
					return;
				}
			};
			reader.readAsText(input.files[0]);
		}

		function ReadURLImportGeoJSONSchema() {
			HTTPJSONData(document.getElementById("DialogImportMeaningGeoJSONSourceURLInput").value).then(
						function(value) { 
							showInfoMessage('Download GeoJSON schema completed.'); 
							currentNode.STAdataAttributes=TransformTextGeoJSONSchemaToDataAttributes(value.text);
							networkNodes.update(currentNode);
							UpdateChildenTable(currentNode);
						},
						function(error) { 
							showInfoMessage('Error downloading GeoJSON Schema. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;
						}
					);	
		}

		function TransformTextCSVToTable(csvText, url) {
			try
			{
				var result = Papa.parse(csvText, {delimiter: (document.getElementById("DialogImportCSVDelimiterAuto").checked ? null : (document.getElementById("DialogImportCSVDelimiterText").checked ? document.getElementById("DialogImportCSVDelimiter").value : '\t')),
					header: document.getElementById("DialogImportCSVHeader").checked,
					dynamicTyping: document.getElementById("DialogImportCSVStringTyping").checked ? false : true,
					skipEmptyLines: true});
				currentNode.STAdata=result.data;
				if (url)
					currentNode.STAfileUrl=url;
				networkNodes.update(currentNode);
				UpdateChildenTable(currentNode);
			}
			catch (e) 
			{
				showInfoMessage("CSV parse error: " + e + " The file content is:\n" + csvText);
				currentNode.STAdata=null;
				networkNodes.update(currentNode);
				return;
			}
		}

		function ReadFileImportCSV(event) {
			var input = event.target;

			var reader = new FileReader();
			reader.onload = function() {
				TransformTextCSVToTable(reader.result, null);
			};
			reader.readAsText(input.files[0], document.getElementById("DialogImportCSVEncoding").value);
		}


		function ReadURLImportCSV() {
			HTTPJSONData(document.getElementById("DialogImportCSVSourceURLInput").value).then(
						function(value) { 
							showInfoMessage('Download CSV completed.'); 
							TransformTextCSVToTable(value.text, document.getElementById("DialogImportCSVSourceURLInput").value);
						},
						function(error) { 
							showInfoMessage('Error downloading CSV. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;
						}
					);	
		}

		function TransformGeoJSONToTable(geojson) {
			if (!geojson.type || geojson.type!="FeatureCollection")
				return null;
			var data=[], feature;				
			for (var i=0; i<geojson.features.length; i++)
			{
				feature=geojson.features[i];
				data.push(deapCopy(feature.properties)); //JSON properties are directly copied into STAdata
				data[data.length-1].geometry=deapCopy(feature.geometry);  //JSON geometry are directly copied into STAdata
			}
			return data;
		}

		function TransformTextGeoJSONToTable(jsonText, url) {
			try
			{
				var geojson = JSON.parse(jsonText);
			}
			catch (e) 
			{
				showInfoMessage("GeoJSON parse error: " + e + " The file content is:\n" + jsonText);
				currentNode.STAdata=null;
				networkNodes.update(currentNode);
				return;
			}
			currentNode.STAdata=TransformGeoJSONToTable(geojson);
			if (!currentNode.STAdata)
			{
				showInfoMessage("GeoJSON parse error. The only supported GeoJSONs are the ones containing a root type FeatureCollection.");
				networkNodes.update(currentNode);
				return;
			}
			if (currentNode.STAdataAttributes)
			{
				var retorn=transformTimeSeriesTemplateIntoObservedPropertyTimeValue(currentNode.STAdata, currentNode.STAdataAttributes);
				if (retorn) {
					currentNode.STAdata=retorn.data
					currentNode.STAdataAttributes=retorn.dataAttributes;
					retorn=transformObservedPropertyTimeValueIntoTimeSemanticValues(currentNode.STAdata, currentNode.STAdataAttributes, retorn.dataAttributesValues, "extractedObservedProperty", "extractedPhenomenonTime", "extractedValue");
					if (retorn) {
						currentNode.STAdata=retorn.data
						currentNode.STAdataAttributes=retorn.dataAttributes;
					}
				}
			}
			if (url)
				currentNode.STAfileUrl=url;				
			networkNodes.update(currentNode);
			UpdateChildenTable(currentNode);
		}

		function ReadFileImportGeoJSON(event) {
			var input = event.target;

			var reader = new FileReader();
			reader.onload = function() {
				TransformTextGeoJSONToTable(reader.result, null);
			};
			reader.readAsText(input.files[0]);  //By default it assumes "UTF8" as encoding
		}


		function ReadURLImportGeoJSON() {
			HTTPJSONData(document.getElementById("DialogImportGeoJSONSourceURLInput").value).then(
						function(value) { 
							showInfoMessage('Download GeoJSON completed.'); 
							TransformTextGeoJSONToTable(value.text, document.getElementById("DialogImportGeoJSONSourceURLInput").value);
						},
						function(error) { 
							showInfoMessage('Error downloading GeoJSON. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;
						}
					);	
		}

		function SaveLocalDataFile(data, fileName, extension, mediatype)   //Saves a memory data structure to a local file
		{
			const link = document.createElement('a');
			if (fileName.substring(fileName.length-extension.length) != extension)
				fileName+=extension;
			link.setAttribute('download', fileName);
			link.setAttribute('href', MakeHrefData(data));
			document.body.appendChild(link);

			// wait for the link to be added to the document
			window.requestAnimationFrame(function () {
				var event = new MouseEvent('click');
				link.dispatchEvent(event);
				document.body.removeChild(link);
			});

			return false;
		}

		function OpenHelp(event) {
			window.open("help", "TapisHelp");
		}

		function OpenConfiguration(event) {
			document.getElementById("DialogConfiguration").showModal();
		}

		// Helper function to parse the JWT token
		function parseJwt(token) {
			var payload = token.split(".")[1];
			var base64 = payload.replace(/-/g, "+").replace(/_/g, "/");
			return JSON.parse(atob(base64));
		};

		document.getElementById("UserInfoText").innerHTML="";
		function OpenLogin(event) {
			hello("authenix").login({redirect_uri: location.pathname, lang: getLang(), scope: "openid profile idp citiobs.secd.eu%23read citiobs.secd.eu%23create citiobs.secd.eu%23update citiobs.secd.eu%23delete", display: "popup"}).then(
				function(success) {
					document.getElementById("buttonOpenLogin").style.display="none";
					document.getElementById("buttonOpenLogout").style.display="inline-block";
					var jwt_elems=parseJwt(success.authResponse.id_token)
					CriptoName=jwt_elems.sub;
					DisplayName=jwt_elems.preferred_username ? jwt_elems.preferred_username : ""
					if (!CriptoName)
						CriptoName=="Anonymous"
					document.getElementById("UserInfoText").innerHTML=DisplayName +" at "+ jwt_elems.idp_name;
				},
				function(e) 
				{
					alert("Signin error: " + e.error.message);
					document.getElementById("UserInfoText").innerHTML="";
					CriptoName=null;
				}
			);
		}

		function OpenLogout(event) {
			hello("authenix").logout({force:true}).then(
				function(success) {
					document.getElementById("buttonOpenLogin").style.display="inline-block";
					document.getElementById("buttonOpenLogout").style.display="none";
					alert("Signed out from"+ " " + "authenix" + ". ");
					document.getElementById("UserInfoText").innerHTML="";
					CriptoName=null;
				}, function(e) {
					alert("Signed out error: "  + e.error.message);
					document.getElementById("UserInfoText").innerHTML="";
					CriptoName=null;
				});
		}

		function UpdateConfiguration()
		{
			changeCSSStyle(".tablesmall", 'font-size', document.getElementById("DialogConfigurationFontSize").value/100+"em");

			if (document.getElementById("DialogConfigurationDivSideBySide").checked) {
				document.getElementById("mynetwork").style.float="left";
				document.getElementById("mynetwork").style.width="59.4%";
				document.getElementById("mynetwork").style.height="400px";
				document.getElementById("clarification").style.float="left";
				document.getElementById("clarification").style.width="39.5%";
				document.getElementById("clarification").style.marginLeft="0.2%";
				document.getElementById("clarification").style.height="400px";
			} else {
				document.getElementById("mynetwork").style.float="left";
				document.getElementById("mynetwork").style.width="100%";
				document.getElementById("mynetwork").style.height="700px";
				document.getElementById("clarification").style.float="left";
				document.getElementById("clarification").style.width="100%";
				document.getElementById("clarification").style.marginLeft="0";
				document.getElementById("clarification").style.height="400px";
			}
			if (document.getElementById("DialogConfigurationAddGeolocationHeader").checked)
				InitGPSPosition();
			else
				CancelGPSPosition();
			PlaceButtonsSTAEntities();
		}

		function ChangeConfiguration(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogConfiguration").close(document.getElementById("DialogConfigurationFontSize").value);
			UpdateConfiguration();
		}

		function ApplyConfiguration(event) {
			event.preventDefault(); // We don't want to submit this form
			UpdateConfiguration();
		}

		function GetSTAURLEvent(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSTAURL").close(document.getElementById("DialogSTAURLInput").value);
			
			if ((currentNode.image == "sta.png" && currentNode.STAURL == document.getElementById("DialogSTAURLInput").value) ||
				(currentNode.image == "ogcAPIs.png" && currentNode.STAURL == document.getElementById("DialogSTAURLInput").value+"/collections") ||
				(currentNode.image == "csw.png" && currentNode.STAURL == document.getElementById("DialogSTAURLInput").value+"?REQUEST=GetRecords&SERVICE=CSW&version=2.0.2&resultType=results&elementSetName=full&typeNames=gmd:MD_Metadata&namespace=xmlns(gmd=http://www.isotc211.org/2005/gmd)&outputSchema=http://www.isotc211.org/2005/gmd&maxRecords=100"))
				return;
			var previousSTAURL = currentNode.STAURL;
			currentNode.STAURL = document.getElementById("DialogSTAURLInput").value;
			if (currentNode.STAURL.charAt(currentNode.STAURL.length - 1) == '/' || 
				currentNode.STAURL.charAt(currentNode.STAURL.length - 1) == '?')
				currentNode.STAURL = currentNode.STAURL.slice(0, -1);  //remove last character

			if (currentNode.image == "ogcAPIs.png") {
				currentNode.STAURL += "/collections";
				currentNode.OGCType = "OGCAPIcollections";
				askForConformanceInOGCAPIFeatures();//OCGAPICconformance
			} else if (currentNode.image == "csw.png") {
				currentNode.STAURL += "?REQUEST=GetRecords&SERVICE=CSW&version=2.0.2&resultType=results&elementSetName=full&typeNames=gmd:MD_Metadata&namespace=xmlns(gmd=http://www.isotc211.org/2005/gmd)&outputSchema=http://www.isotc211.org/2005/gmd&maxRecords=100";
				currentNode.OGCType = "OGCCSW";
			}
			

			networkNodes.update(currentNode);	//https://visjs.github.io/vis-data/data/dataset.html#Data_Manipulation

			//if childen nodes have also STAURL
			UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
			LoadJSONNodeSTAData(currentNode);
		}

		function PopulateInputFromSelect(event, idPrefix) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById(idPrefix+"Input").value=document.getElementById(idPrefix+"Select").value;
			if (document.getElementById(idPrefix))
				document.getElementById(idPrefix).click();
		}

		function GetOptionsSelectDialog(suggestedURLs) {
			var cdns=[], stas;
			if (suggestedURLs)
			{
				cdns.push('<option value="">-- Select one option below --</option>');
				for (var g=0; g<suggestedURLs.length; g++) {
					cdns.push('<optgroup label="', suggestedURLs[g].group, '">');
					stas=suggestedURLs[g].STAs;
					for (var i=0; i<stas.length; i++)
						cdns.push('<option value="', stas[i].url, '">', stas[i].desc, '</option>');
				}
			}
			return cdns.join("");  
		}

		function ShowUploadObservationsDialog(node) {
			if (CriptoName &&
			    hello("authenix").getAuthResponse() && 
			    hello("authenix").getAuthResponse().access_token)
			{
				document.getElementById("DialogUploadObservationsLoginFirst").style.display="none";
				document.getElementById("DialogUploadObservationsForm").style.display="inline-block";
				document.getElementById("DialogSTAUploadURLInput").value = node.STAURL ? node.STAURL : config.STAurl;
				ShowUploadObservationsSelects(node);
			}
			else
			{
				document.getElementById("DialogUploadObservationsLoginFirst").style.display="inline-block";
				document.getElementById("DialogUploadObservationsForm").style.display="none";
			}
		}
		
		function GetFirstParentNode(node) {
			var nodeids = network.getConnectedNodes(node.id, "from");
			if (nodeids && nodeids.length && networkNodes.get(nodeids[0]))
				return networkNodes.get(nodeids[0]);
			return null;
		}

		function GetParentNodes(node) {
			var nodeids = network.getConnectedNodes(node.id, "from");
			if (nodeids && nodeids.length)
			{
				var nodes=[];
				for (var i=0; i<nodeids.length; i++)
					nodes[i]=networkNodes.get(nodeids[i]);
				return nodes;
			}
			return null;
		}

		function ShowUploadObservationsSelects(node) {
			var parentNode = GetFirstParentNode(node)
			if (parentNode) {
				var data = parentNode.STAdata;
				var dataAttributes = parentNode.STAdataAttributes ? parentNode.STAdataAttributes : getDataAttributes(data);
				PopulateSelectSaveLayerDialog("DialogUploadObservationsPlace", dataAttributes, "place");
				PopulateSelectSaveLayerDialog("DialogUploadObservationsLongitude", dataAttributes, "long");
				PopulateSelectSaveLayerDialog("DialogUploadObservationsLatitude", dataAttributes, "lat");
				PopulateSelectSaveLayerDialog("DialogUploadObservationsTime", dataAttributes, "phenomenonTime");
				PopulateSelectSaveLayerDialog("DialogUploadObservationsSensorName", dataAttributes, "sensor_id");
				PopulateSelectSaveLayerDialog("DialogUploadObservationsSensorType", dataAttributes, "sensor_type");
			}
		}

		function GetSelectedOptionsUploadObservations(){
			var selectedOptions={};
			selectedOptions.place=document.getElementById("DialogUploadObservationsPlaceSelect").value;
			selectedOptions.longitude=document.getElementById("DialogUploadObservationsLongitudeSelect").value;
			selectedOptions.latitude=document.getElementById("DialogUploadObservationsLatitudeSelect").value;
			selectedOptions.time=document.getElementById("DialogUploadObservationsTimeSelect").value;
			selectedOptions.sensorName=document.getElementById("DialogUploadObservationsSensorNameSelect").value;
			selectedOptions.sensorType=document.getElementById("DialogUploadObservationsSensorTypeSelect").value;

			/*selectedOptions.variable=document.getElementById("DialogSaveLayerVariableSelect").value;
			if (descripUoM){
				selectedOptions.variableDescription=document.getElementById("DialogMeaningVariableDescriptionSelect").value;
				selectedOptions.variableDefinition=document.getElementById("DialogMeaningVariableDefinitionSelect").value;
				selectedOptions.variableUoM=document.getElementById("DialogMeaningVariableUoMSelect").value;
				selectedOptions.variableUoMSymbol=document.getElementById("DialogMeaningVariableUoMSymbolSelect").value;
				selectedOptions.variableUoMDefinition=document.getElementById("DialogMeaningVariableUoMDefinitionSelect").value;
			}
			selectedOptions.value=document.getElementById("DialogSaveLayerValueSelect").value;*/
			return selectedOptions;
		}


		function UpdateJoinTablesRowMatchingNode(node) {
			node.STAJoinTables.RowMatching=[];
			for (var i=0; true; i++)
			{
				if (!document.getElementById("DialogJoinTablesRowMatching_" + i + "_left") ||
					!document.getElementById("DialogJoinTablesRowMatching_" + i + "_right"))
					break;
				node.STAJoinTables.RowMatching[i]={left: document.getElementById("DialogJoinTablesRowMatching_" + i + "_left").value,
					right: document.getElementById("DialogJoinTablesRowMatching_" + i + "_right").value};
			}
		}

		function RemoveJoinTablesRowMatchingIds(nodeLeftId, nodeRightId, nodeCurrentId, iRowMatching)
		{
			var node=networkNodes.get(nodeCurrentId);
			UpdateJoinTablesRowMatchingNode(node);

			if (!node.STAJoinTables || !node.STAJoinTables.RowMatching || node.STAJoinTables.RowMatching.length<2)
				return;
			node.STAJoinTables.RowMatching.splice(iRowMatching, 1);
			networkNodes.update(node);
			AddJoinTablesRowMatching(networkNodes.get(nodeLeftId), networkNodes.get(nodeRightId), node, false);
		}

		function AddJoinTablesRowMatchingIds(nodeLeftId, nodeRightId, nodeCurrentId)
		{
			var node=networkNodes.get(nodeCurrentId);
			UpdateJoinTablesRowMatchingNode(node);
			AddJoinTablesRowMatching(networkNodes.get(nodeLeftId), networkNodes.get(nodeRightId), node, true);
		}

		function AddJoinTablesRowMatching(nodeLeft, nodeRight, node, add)
		{
			var dataLeft=nodeLeft.STAdata;
			var dataLeftAttributes = dataLeft.STAdataAttributes ? dataLeft.STAdataAttributes : getDataAttributes(dataLeft);
			var dataLeftAttributesArray = Object.keys(dataLeftAttributes);
			var dataRight=nodeRight.STAdata;
			var dataRightAttributes = nodeRight.STAdataAttributes ? nodeRight.STAdataAttributes : getDataAttributes(dataRight);
			var dataRightAttributesArray = Object.keys(dataRightAttributes);
			var updated=false;
			if (!node.STAJoinTables)
				node.STAJoinTables={};
			if (!node.STAJoinTables.RowMatching) {
				node.STAJoinTables.RowMatching=[{left: [dataLeftAttributesArray[0]],
					right: [dataRightAttributesArray[0]]}];
				updated=true;
			}
			if (add) {
				node.STAJoinTables.RowMatching.push({left: [dataLeftAttributesArray[0]],
					right: [dataRightAttributesArray[0]]});
				updated=true;
			}
			if (updated)
				networkNodes.update(node);

			var s="";
			for (var i=0; i<node.STAJoinTables.RowMatching.length; i++)
			{
				s+=GetSelectSaveLayerDialog("DialogJoinTablesRowMatching_" + i + "_left",  dataLeftAttributes,  node.STAJoinTables.RowMatching[i].left) +
					" matches " +
					GetSelectSaveLayerDialog("DialogJoinTablesRowMatching_" + i + "_right", dataRightAttributes, node.STAJoinTables.RowMatching[i].right) +
					" <button onclick='RemoveJoinTablesRowMatchingIds(\"" + nodeLeft.id + "\", \"" + nodeRight.id + "\", \"" + node.id + "\", " + i + ");'" + (i==0 && node.STAJoinTables.RowMatching.length==1? " disabled='disabled'" : "") + ">Remove</button><br>";
			}
			s+="<button onclick='AddJoinTablesRowMatchingIds(\"" + nodeLeft.id + "\", \"" + nodeRight.id + "\", \"" + node.id + "\");'>Add</button>";
			document.getElementById("DialogJoinTablesRowMatching").innerHTML=s;
		}

		function ShowJoinTablesDialog(parentNodes, node) {
			var dataLeft = parentNodes[0].STAdata;
			if (!dataLeft || !dataLeft.length) {
				document.getElementById("DialogJoinTablesRowMatching").innerHTML = "No data to show.";
				return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       			}
			if (parentNodes.length<2)
			{
				document.getElementById("DialogJoinTablesRowMatching").innerHTML = "Two tables are required.";
				return;
			}
			AddJoinTablesRowMatching(parentNodes[0], parentNodes[1], node, false);
		}


		function ShowOneValueDialog(currentNode) {
			var parentNode=GetFirstParentNode(currentNode);
			if (!parentNode)
				return;
			var data = parentNode.STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogOneValueTitle").innerHTML = "No data to show.";
				return;
			}
			document.getElementById("DialogOneValueTitle").innerHTML = "Select value to see the last value";

			startingNodeContextId=currentNode.id;
			var dataAttributes = parentNode.STAdataAttributes ? parentNode.STAdataAttributes : getDataAttributes(data);
			PopulateSelectSaveLayerDialog("DialogOneValueVariable", dataAttributes, currentNode.STAvariable ? currentNode.STAvariable : "result");
			PopulateSelectSaveLayerDialog("DialogOneValueTime", dataAttributes, currentNode.STAtimeVariable ? currentNode.STAtimeVariable : "phenomenonTime");
			if (currentNode.STAredrawPeriod)
				document.getElementById("DialogOneValueRefreshPeriod").value=currentNode.STAredrawPeriod;
		}

		function PrepareRefreshOneValue(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogOneValue").close();

			var node=networkNodes.get(startingNodeContextId);
			if (!node)
				return;
			startingNodeContextId = null;
			if (node.STAtimeOut) {
				clearTimeout(node.STAtimeOut);
				node.STAtimeOut=null;
			}
			node.STAvariable=document.getElementById("DialogOneValueVariableSelect").value;
			node.STAtimeVariable=document.getElementById("DialogOneValueTimeSelect").value;
			node.STAredrawPeriod=document.getElementById("DialogOneValueRefreshPeriod").value;
			networkNodes.update(node);

			RequestLastObservationAndRefreshOneValue(node, node.STAvariable, node.STAtimeVariable, node.STAredrawPeriod);
		}

		function StopRefreshOneValue(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogOneValue").close();

			var node=networkNodes.get(startingNodeContextId);
			if (!node)
				return;
			if (node.STAtimeOut)
			{
				clearTimeout(node.STAtimeOut);
				showInfoMessage("Refresh cancelled.");
			}
		}


		function prepareRefreshCountResults(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogCountResults").close();

			var node=networkNodes.get(startingNodeContextId);
			if (!node)
				return;
			startingNodeContextId = null;
			if (node.STACountTimeOut) {
				clearTimeout(node.STACountTimeOut);
				node.STACountTimeOut=null;
			}
			node.STAredrawPeriodCount=document.getElementById("DialogCountResultsRefreshPeriod").value;
			networkNodes.update(node);

			requestAndRefreshCountResults(node, node.STAredrawPeriodCount);

		}

function stopRefreshCountResults(event) {
	event.preventDefault(); // We don't want to submit this form
	document.getElementById("DialogCountResults").close();

	if (!currentNode)
		return;
	if (currentNode.STACountTimeOut) {
		clearInterval(currentNode.STACountTimeOut);
		showInfoMessage("Refresh cancelled.");
	}
}

function closeDialogCountResults(event) {
    event.preventDefault(); // We don't want to submit this form
    document.getElementById("DialogCountResults").close();
}

		function getTimeISOTime(isodatetime) {
			var d=new Date(isodatetime);
			return d.getHours()+":"+(d.getMinutes()<10 ? "0" : "")+d.getMinutes()+":"+(d.getSeconds()<10 ? "0" : "")+d.getSeconds();
		}

		function GetObservationResultAsString(v) {
			if (typeof v === "number")
				return v.toString();
			if (typeof v === "object")
				return JSON.stringify(v);
			return v;
		}

		async function RequestLastObservationAndRefreshOneValue(currentNode, variable, timeVariable, period) {
			var parentNode=GetFirstParentNode(currentNode);
			if (!parentNode)
				return;
			currentNode.STAURL = AddQueryParamsToURL(parentNode.STAURL, "$orderby="+timeVariable+" desc");
			if (removeExtension(parentNode.image)=="Observations")
				currentNode.STAURL = AddQueryParamsToURL(currentNode.STAURL, "$expand=Datastream,MultiDatastream")
			currentNode.STAExpectedLength = 1;
			networkNodes.update(currentNode);
			showInfoMessage("Getting the last observation...");
			await LoadJSONNodeSTAData(currentNode);

			//Redraw the label

			var data=currentNode.STAdata;
			if (!data || data.length<1)
				return;

			if (data[0]["MultiDatastream"]) {
				currentNode.label="";
				for (var i=0; i<data[0][variable].length; i++)
				{
					currentNode.label+=GetObservationResultAsString(data[0][variable][i]);
					if (data[0]["MultiDatastream"]?.unitOfMeasurements[i]?.symbol)
						currentNode.label+=data[0]["MultiDatastream"]?.unitOfMeasurements[i]?.symbol;
					if (i+1!=data[0][variable].length)
						currentNode.label+=", ";
				}
			} else {
				currentNode.label=GetObservationResultAsString(data[0][variable]);
				if (data[0]["Datastream"] && data[0]["Datastream"]?.unitOfMeasurement?.symbol)
					currentNode.label+=data[0]["Datastream"].unitOfMeasurement.symbol;
			}
			currentNode.label+=" (" + getTimeISOTime(data[0][timeVariable]) + ")";

			//Redraw
			showInfoMessage(currentNode.label + ". Waiting " + period + " seconds ...");
			currentNode.STAtimeOut=setTimeout(RequestLastObservationAndRefreshOneValue, period*1000, currentNode, variable, timeVariable, period);
			networkNodes.update(currentNode);
		}


async function requestAndRefreshCountResults(currentNode, period) {
    	var parentNode = GetFirstParentNode(currentNode);
	if (!parentNode)
		return;
	currentNode.STAURL = AddQueryParamsToURL(parentNode.STAURL, "$count=true&$top=0");
	currentNode.STAExpectedLength = 1;	
	networkNodes.update(currentNode);
	showInfoMessage("Getting number of items");
	var numberOfResults = await loadAPIDataWithReturn(currentNode.STAURL, "CountResults");

	//Redraw the label	
	currentNode.label = "Items: " + numberOfResults;
	
	//Redraw	
	showInfoMessage(currentNode.label + ". Waiting " + period + " seconds ...");
	currentNode.STACountTimeOut=setTimeout(requestAndRefreshCountResults, period*1000, currentNode, period);
	networkNodes.update(currentNode);
}

		function CloseDialogOneValue(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogOneValue").close();
		}


		//From iNat2STA
		function ExtractIdFromURL(url)
		{
			var id;
			if (!url && url!==0)
				return;
			if (-1!=url.indexOf("('") && -1!=url.indexOf("')", url.indexOf("('")+2))
			{
				id=url.substring(url.indexOf("('")+2,url.indexOf("')",url.indexOf("('")+2));
				if (id==+id)  //Is it a numerical id?  /inspired in https://stackoverflow.com/questions/20169217/how-to-write-isnumber-in-javascript
					return +id;  //returns a number
				return id;  //returns a string
			}
			if (-1!=url.indexOf("(") && -1!=url.indexOf(")", url.indexOf("(")+1))
			{
				id=url.substring(url.indexOf("(")+1,url.indexOf(")",url.indexOf("(")+1));
				return +id;  //returns a number
			}
			else
				return url;
		}

		function getUrlToId(url, objsName, id) {
			return url + "/" + objsName + "(" + (typeof id==="number" ? "" :"'") + id + (typeof id==="number" ? "" :"'") + ")";
		}


		function AddKeysToFilter(url, obj, prefix) {
			var objArray=Object.keys(obj);
			for (var i=0; i<objArray.length; i++)
			{
				var propName=objArray[i];
				var value=obj[propName];
				if (value==null)  //Do not consider null properties in the queries
 					continue;
				if (typeof value==="object")
				{
					if (propName=="feature" || propName=="location"){
						var coords;
						if (value.geometry && value.geometry.coordinates)
							coords=value.geometry.coordinates;
						else if (value.coordinates)
							coords=value.coordinates;
						else {
							alert("Wrong format for 'feature' or 'location'. I cannot find the coordinates.");
							continue;
						}
						if (!Array.isArray(coords) || 
							coords.length<2 || 
							Array.isArray(coords[0]) || Array.isArray(coords[1])) {
							alert("The coordinates format for 'feature' or 'location' is not supported. Only a Point structure is supported: Array of two decimal numbers.");
							continue;
						}
						url+=(url=="" ? "" : " and ") + "st_equals(" + propName + ", geography'POINT (" + coords[0] + " " + coords[1] + ")')";
					}
					else if (Array.isArray(value) && value.length==1 && typeof value[0]==="object")
						url=AddKeysToFilter(url, value[0], prefix ? prefix + "/" + propName : propName);
					else
						url=AddKeysToFilter(url, value, prefix ? prefix + "/" + propName : propName);
					continue;
				}
				if (propName=="encodingType")
					continue;  //I'm ignoring this element in the queries.
				url+=(url=="" ? "" : " and ") + (prefix ? prefix + "/" : "")+ propName + " eq ";
				if (typeof value==="number" || propName=="resultTime" || propName=="phenomenonTime" || propName=="validTime" || propName=="creationTime" || propName=="startTime" || propName=="endTime")
					url+=value;
				else
					url+="'" + value + "'";
			}
			return url;
		}

		async function GetObjectId(url, objsName, obj){
			if (objsName=="Parties")
				var response=await HTTPJSONData(url+"/"+objsName+ "?$filter=authId eq '" + obj.authId + "'");
			else
				var response=await HTTPJSONData(url+"/"+objsName+ "?$filter=" + encodeURIComponent(AddKeysToFilter("", obj)));
			if (!response || (!response.obj && !response.ok && response.status!=404))
				throw {name: "Error requesting resource existance.", message: "Status: "+ response.status, at: "", text: url+"/"+objsName+ "?$filter=" + AddKeysToFilter("", obj)};
			var data=response.obj;
			if (data && data.value && data.value.length)
				return data.value[0]["@iot.id"];
			else
			{
				//Not found. I'm creating it.
				var response=await HTTPJSONData(url+"/"+objsName, ['Location'], 'POST', obj);
				if (response?.ok)
					return ExtractIdFromURL(response.responseHeaders['Location']);
				else
					null; /*throw {name: "Error creating resource", message: "Status: "+ response.status, at: "", text: url+"/"+objsName+ "?$filter=" + AddKeysToFilter("", obj)};*/
			}
		}

		async function GetPartyId(url, authId) {
			return await GetObjectId(url, "Parties", {
				"authId": authId,
				//"displayName": authId,  //It might change soon to "description"
				//"description": null,
				"role": "individual"
			});
		}

		async function GetObservedPropertyId(url, name, description, definition) {
			return await GetObjectId(url, "ObservedProperties", {
				"name": name,
				"description": description,
				"definition": definition
			});
		}
		async function GetSensorId(url, name, description, metadata) {
			return await GetObjectId(url, "Sensors", {
				"name": "Sensor for measuring " + name.charAt(0).toLowerCase() + name.substring(1),
				"description": "Sensor for measuring " + description.charAt(0).toLowerCase() + description.substring(1),
				"encodingType": "text/html",
				"metadata": metadata
			});
		}

		async function GetThingId(url, partyId, name, description) {
			return await GetObjectId(url, "Things", {
				"name": "Platform that measures " + name.charAt(0).toLowerCase() + name.substring(1),
				"description": "Platform that measures " + description.charAt(0).toLowerCase() + description.substring(1),
				"Party": { "@iot.id":  partyId }
			});
		}


		async function GetDatastreamId(url, partyId, obsPropId, sensorId, thingId, name, description, UoM, UoMSymbol, UoMDefinition) {
			return await GetObjectId(url, "Datastreams", {
				"unitOfMeasurement":{
					"name": UoM,
					"symbol": UoMSymbol,
					"definition": UoMDefinition
				},
				"observationType": "http://www.opengis.net/def/observationType/OGC-OM/2.0/OM_Measurement",
				"name": name,
				"description": description,
				"ObservedProperty": { "@iot.id": obsPropId },
				"Sensor": { "@iot.id":  sensorId },
				"Thing": { "@iot.id": thingId },
				"Party": { "@iot.id":  partyId }
			});
		}

		async function GetFeatureOfInterestId(url, place, longitude, latitude) {
			return await GetObjectId(url, "FeaturesOfInterest", {
				"name": place,
				"description": place,
				"encodingType": "application/geo+json",
				"feature": {
					"type": "Feature",
					"geometry": {
						"type": "Point",
						"coordinates": [longitude, latitude]
					}
				}
			});
		}

		async function GetObservationId(url, datastreamId, FoIId, time, result) {
			var d=new Date(time);
			var t=d.toISOString();

			return await GetObjectId(url, "Observations", {
				"result": result,
				"resultTime": t,
				"phenomenonTime": t,
				"FeatureOfInterest": { "@iot.id": FoIId },
				"Datastream": { "@iot.id": datastreamId }
			});
		}

		async function UploadObservationsSTA(url, data, dataAttributes, selectedOptions) {
			var record, obsPropId, sensorId, partyId, thingId, datastreamIds=[];
			var dataAttributesArray = Object.keys(dataAttributes);

			partyId=await GetPartyId(url, CriptoName);
			if (!partyId && partyId!==0)
				return;
			record=data[0];  //to be able to extract a constant value (the sensor name)
			for (var i = 0; i < dataAttributesArray.length; i++) {
				if (dataAttributesArray[i]==selectedOptions.place ||
					dataAttributesArray[i]==selectedOptions.longitude ||
					dataAttributesArray[i]==selectedOptions.latitude ||
					dataAttributesArray[i]==selectedOptions.time ||
					dataAttributesArray[i]==selectedOptions.sensorName ||
					dataAttributesArray[i]==selectedOptions.sensorType)
					continue;
				if (!dataAttributes[dataAttributesArray[i]].description ||
					!dataAttributes[dataAttributesArray[i]].definition)
				{
					datastreamIds[i]=null;
					continue;
				}
				obsPropId=await GetObservedPropertyId(url, dataAttributesArray[i], dataAttributes[dataAttributesArray[i]].description, dataAttributes[dataAttributesArray[i]].definition);
				if (!obsPropId && obsPropId!==0)
					return;
				sensorId=await GetSensorId(url, dataAttributesArray[i], (selectedOptions.sensorType && record[selectedOptions.sensorType]) ? record[selectedOptions.sensorType] : dataAttributes[dataAttributesArray[i]].description, dataAttributes[dataAttributesArray[i]].definition);
				if (!sensorId && sensorId!==0)
					return;

				thingId=await GetThingId(url, partyId, dataAttributesArray[i], (selectedOptions.sensorName && record[selectedOptions.sensorName]) ? record[selectedOptions.sensorName] : dataAttributes[dataAttributesArray[i]].description);
				if (!thingId && thingId!==0)
					return;

				datastreamIds[i]=await GetDatastreamId(url, partyId, obsPropId, sensorId, thingId, dataAttributesArray[i], dataAttributes[dataAttributesArray[i]].description, dataAttributes[dataAttributesArray[i]].UoM, dataAttributes[dataAttributesArray[i]].UoMSymbol, dataAttributes[dataAttributesArray[i]].UoMDefinition);
				if (!datastreamIds[i] && datastreamIds[i]!==0)
					return;
				showInfoMessage("Datastream <a href='" + getUrlToId(url, "Datastreams", datastreamIds[i]) + "' target='_blank'>" + datastreamIds[i] + "</a> available in STA");
			}
			for (var i = 0; i < data.length; i++) {
				record=data[i];
				var FoIId=await GetFeatureOfInterestId(url, record[selectedOptions.place], record[selectedOptions.longitude], record[selectedOptions.latitude]);
				if (!FoIId && FoIId!==0)
					return;
				var keys = Object.keys(data[i]);
				for (var k = 0; k < keys.length; k++) {
					if (keys[k]==selectedOptions.place ||
						keys[k]==selectedOptions.longitude ||
						keys[k]==selectedOptions.latitude ||
						keys[k]==selectedOptions.time)
						continue;
					if (!datastreamIds[k])
						continue;

					var observationId=await GetObservationId(url, datastreamIds[k], FoIId, record[selectedOptions.time], record[keys[k]]);
					if (!observationId && observationId!==0)
						return;
					showInfoMessage("Observation <a href='" + getUrlToId(url, "Observations", observationId) + "' target='_blank'>" + observationId + "</a> available in STA under Datastream <a href='" + getUrlToId(url, "Datastreams", datastreamIds[k]) + "' target='_blank'>" + datastreamIds[k] + "</a>");
				}
			}
			return;  //value	
		}

		function UploadObservationsSTAURL(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogUploadObservations").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				var url=document.getElementById("DialogSTAUploadURLInput").value;
				if (url.charAt(url.length - 1) == '/')
					url = url.slice(0, -1);  //remove last character
				showInfoMessage('Upload observations in STA started...');
				UploadObservationsSTA(url,
					parentNode.STAdata,
					parentNode.STAdataAttributes ? parentNode.STAdataAttributes : getDataAttributes(parentNode.STAdata),
					GetSelectedOptionsUploadObservations()).then(
						function(value) { showInfoMessage('Upload observations in STA completed.'); },
						function(error) { showInfoMessage('Error uploading Observations to STA. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;}
					);
			}
		}



		function GetSelectNRecords(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectNRecords").close();

			var previousSTAURL= currentNode.STAURL;
			
			if (!isNaN(parseInt(document.getElementById("SelectNumberOfRecords").value)))
				currentNode.STAExpectedLength = parseInt(document.getElementById("SelectNumberOfRecords").value);
			networkNodes.update(currentNode);
			showInfoMessage("Loading STA count...");
			UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
			LoadJSONNodeSTAData(currentNode);
		}

		function GetSelectSortBy(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectSortBy").close();

			var previousSTAURL= currentNode.STAURL;

			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				if (parentNode.STAURL)
					currentNode.STAURL = parentNode.STAURL;
				if (parentNode.STAdata)
					currentNode.STAdata = parentNode.STAdata;
				var dataAttributes = currentNode.STAdataAttributes ? currentNode.STAdataAttributes : getDataAttributes(currentNode.STAdata);
				var dataAttributesArray=Object.keys(dataAttributes)
			}
			else
				return;

			if (document.getElementById("DialogSelectSortByHTML").style.display != "none")
			{
				for (var a = 0; a < dataAttributesArray.length; a++)
				{
					if (!dataAttributesArray[a].endsWith("@iot.navigationLink") && dataAttributesArray[a].charAt(0)!='@')
					{
						if (document.getElementById("SelectSortByEntity_" + a) && document.getElementById("SelectSortByEntity_" + a).checked)
							break;
					}
				}

				if (a < dataAttributesArray.length) //A checked attribute has been found ("for" breaks before ending).
				{
					var s;
					currentNode.STAURL = AddQueryParamsToURL(currentNode.STAURL, "$orderby="+dataAttributesArray[a]+" "+((document.getElementById("SelectSortByDesc") && document.getElementById("SelectSortByDesc").checked) ? "desc" : "asc"));
				}
			}
			if (!isNaN(parseInt(document.getElementById("SelectExpandsNumberOfRecords").value)))
				currentNode.STAExpectedLength = parseInt(document.getElementById("SelectSortByNumberOfRecords").value);
			networkNodes.update(currentNode);
			showInfoMessage("Sorting STA by "+ dataAttributesArray[a] + " ...");
			UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
			LoadJSONNodeSTAData(currentNode);
		}

		function isNumeric(str) {
			if (typeof str != "string") return false // we only process strings!  	
			return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
				!isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
		}

		function returnIndexEntityRelatedInSTAEntity(entityName, entityRelated) {
			var n=STAEntities[entityName].entities.length;
			for (var t=0;t<n;t++){
				if (STAEntities[entityName].entities[t].name==entityRelated)
					return t;
			}
			return -1;
		}

		function PopulateCreateUpdateDeleteEntity(entityName, currentNode) {
			var cdns=[];

			var parentNodes=GetParentNodes(currentNode);
			if (parentNodes.length==0) {
				alert("Parent(s) node(s) are needed to know about the STA root url");
				return false;
			}

			cdns.push('<span id="dlgCreateUpdateDeleteEntityType">',STAEntities[entityName].singular, "</span>:<br>");
			for (var i=0; i<parentNodes.length; i++)
			{
				var parentNode=parentNodes[i];
				if (!parentNode.STAdata || parentNode.STAdata.length==0){
					alert("Parent node has no STA data associated");
					return false;
				}
				if (parentNode.image != "sta.png"){
					if (parentNode.STAdata.length>1){
						alert("Parent node has more than a single record. Please select a record first.");
						return false;
					}
					var parentEntityName=getSTAEntityPlural(getSTAURLLastEntity(parentNode.STAURL), false);
					if (parentEntityName!=entityName && returnIndexEntityRelatedInSTAEntity(entityName, parentEntityName)==-1 && returnIndexEntityRelatedInSTAEntity(entityName, STAEntities[parentEntityName].singular)==-1) {
						alert("Parent node ("+STAEntities[parentEntityName].singular+") is not a/an " + STAEntities[entityName].singular + " or is directly related to a/an " +  STAEntities[entityName].singular);
						return false;
					}
					if (parentEntityName==entityName) { 
						if (i>1) {
							alert("One parent node is the same as the entity " + STAEntities[entityName].singular + ". This is for update or delete the entity. In this case, only one parent node is allowed.");
							return false;
						}
						var record=parentNode.STAdata[0];
						if (!record["@iot.id"]){
							alert("Cannot find @iot.id. Did you removed in a select?");
							return false;
						}
						cdns.push('Id: <input id="dlgCreateUpdateDeleteEntity_id" type="text" value="', record["@iot.id"], '" readonly=="readonly"><br>'); //update/delete
					}
					else { 
						var record=parentNode.STAdata[0];
						if (!record["@iot.id"]){
							alert("Cannot find @iot.id in parent node " + STAEntities[parentEntityName].singular + ". Did you removed in a select?");
							return false;
						}
						cdns.push(STAEntities[parentEntityName].singular, ' id: <a href="', getUrlToId(getSTAURLRoot(parentNodes[0].STAURL), parentEntityName, record["@iot.id"]), '" target="_blank">', record["@iot.id"], '</a><br>');
					}
				}
			}
			for (var i=0; i<STAEntities[entityName].properties.length; i++){
				if ((entityName=="Observations" ? STAEntities[entityName].properties[i].name=="parameters" : STAEntities[entityName].properties[i].name=="properties") || 
					((entityName=="Datastreams" || entityName=="MultiDatastreams") && (STAEntities[entityName].properties[i].name=="observedArea" || STAEntities[entityName].properties[i].name=="phenomenonTime" || STAEntities[entityName].properties[i].name=="resultTime")))
					continue;
				if ((entityName=="Locations" && STAEntities[entityName].properties[i].name=="location") || 
				    (entityName=="FeaturesOfInterest" && STAEntities[entityName].properties[i].name=="feature"))
				{
					//For the moment in supporting only a point
					cdns.push('<fieldset>',
						'<legend>', STAEntities[entityName].properties[i].name, ' (point):</legend>', //Volem posar que sigui required?
						'<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_longitude">', 'longitude: </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_longitude" type="text"><br>',
						'<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_latitude">', 'latitude: </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_latitude" type="text"><br>',
						'</fieldset>',
						'<br>');
					continue;	
				}
				if (entityName=="Datastreams" && STAEntities[entityName].properties[i].name=="unitOfMeasurement") {
					//Something similar needs to be done for MultiDataStream
					cdns.push('<fieldset>',
						'<legend>', STAEntities[entityName].properties[i].name, ':</legend>', //Quins volem que siguin required? perque al esquema diu que es required el unitOfMeasurement sencer, no desglosa
						'<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_name">', 'name: </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_name" type="text"><br>',
						'<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_symbol">', 'symbol: </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_symbol" type="text"><br>',
						'<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_definition">', 'definition: </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '_definition" type="text"><br>',
						'</fieldset>',
						'<br>');
					continue;
				}
				cdns.push('<label for="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '" data-STArequired='+STAEntities[entityName].properties[i].required+'>', (STAEntities[entityName].properties[i].required=='true')? STAEntities[entityName].properties[i].name+'*':STAEntities[entityName].properties[i].name, ': </label><input id="dlgCreateUpdateDeleteEntity_', STAEntities[entityName].properties[i].name, '" type="text"><br>');
			}

			document.getElementById("dlgCreateUpdateDeleteEntityProperties").innerHTML=cdns.join("");

			if (parentNodes[0].image != "sta.png" && parentEntityName==entityName) {
				//Edit or delete
				for (var i=0; i<STAEntities[entityName].properties.length; i++) {
					if (entityName=="Observations" ? STAEntities[entityName].properties[i].name=="parameters" : STAEntities[entityName].properties[i].name=="properties")
						continue;
					document.getElementById("dlgCreateUpdateDeleteEntity_"+STAEntities[entityName].properties[i].name).value=record[STAEntities[entityName].properties[i].name] ? record[STAEntities[entityName].properties[i].name] : "";
				}
				document.getElementById("dlgCreateUpdateDeleteEntityCreate").style.display="none";
				document.getElementById("dlgCreateUpdateDeleteEntityUpdate").style.display="inline-block";
				document.getElementById("dlgCreateUpdateDeleteEntityDelete").style.display="inline-block";
				return true;
			}
			else {
				//Create
				if (entityName=="Parties") {
					if (CriptoName && CriptoName!="Anonymous")
						document.getElementById("dlgCreateUpdateDeleteEntity_authId").value=CriptoName;
					else {
						alert("To create a STA Pa·rty, you should login first.");
						return false;
					}
					document.getElementById("dlgCreateUpdateDeleteEntity_authId").readOnly=true;
					document.getElementById("dlgCreateUpdateDeleteEntity_role").value="individual";
					document.getElementById("dlgCreateUpdateDeleteEntity_displayName").value=DisplayName;
				}
				else if (entityName=="Locations" || entityName=="FeaturesOfInterest")
				{
					document.getElementById("dlgCreateUpdateDeleteEntity_encodingType").value="application/geo+json";
					document.getElementById("dlgCreateUpdateDeleteEntity_encodingType").readOnly=true;	
				}
				else if (entityName=="Datastreams")	
					document.getElementById("dlgCreateUpdateDeleteEntity_observationType").value="http://www.opengis.net/def/observationType/OGC-OM/2.0/OM_Measurement";

				document.getElementById("dlgCreateUpdateDeleteEntityCreate").style.display="inline-block";
				document.getElementById("dlgCreateUpdateDeleteEntityUpdate").style.display="none";
				document.getElementById("dlgCreateUpdateDeleteEntityDelete").style.display="none";
			}
			return true;
		}

		function GetCreateEntity(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogCreateUpdateDeleteEntity").close();
			var node=currentNode;

			var parentNodes=GetParentNodes(node);
			if (parentNodes.length==0)
				return;

			var entityName=getSTAEntityPlural(document.getElementById("dlgCreateUpdateDeleteEntityType").innerHTML)
			var url=getSTAURLRoot(parentNodes[0].STAURL);
			var obj={};
			showInfoMessage("Creating a/an "+ STAEntities[entityName].singular +"...");

			for (var i=0; i<parentNodes.length; i++) {
				var parentNode=parentNodes[i];
				if (parentNode.image == "sta.png")
					continue;
				if (i!=0 && getSTAURLRoot(parentNode.STAURL)!=url) {
					alert("Not all parent nodes are from the same root URL: " + getSTAURLRoot(parentNode.STAURL) + ", " + url);
					continue;
				}
			
				var parentEntityName=getSTAEntityPlural(getSTAURLLastEntity(parentNode.STAURL), true);
				var entity;
				if (returnIndexEntityRelatedInSTAEntity(entityName, parentEntityName)!=-1)
					entity=parentEntityName;
				else if (returnIndexEntityRelatedInSTAEntity(entityName, STAEntities[parentEntityName].singular)!=-1)
					entity=STAEntities[parentEntityName].singular;
				else {
					alert("Parent node ("+STAEntities[parentEntityName].singular+") is not directly related to a/an " +  STAEntities[entityName].singular);
					continue;
				}

				if (!parentNode.STAdata || parentNode.STAdata.length==0){
					alert("Parent node has no STA data associated");
					return;
				}
				if (parentNode.STAdata.length>1){
					alert("Parent node '"+STAEntities[parentEntityName].singular+"' has more than a single record. Please select a record first.");
					return;
				}
				var record=parentNode.STAdata[0];
				if (!record["@iot.id"]){
					alert("Cannot find @iot.id. Did you removed in a select?");
					return;
				}
				if (obj[entity]){  //add to a plural array
					if (entity==STAEntities[parentEntityName].singular){
						alert("An element '"+STAEntities[entityName].singular+"' can not have more than one '"+parentEntityName+"' Associated. One the first will be considered.");
						continue;
					}					
					obj[parentEntityName].push({"@iot.id": record["@iot.id"]});
				}
				else if (entity==STAEntities[parentEntityName].singular)
					obj[STAEntities[parentEntityName].singular] = {"@iot.id": record["@iot.id"]}
				else  //Add to a plural element
					obj[parentEntityName]=[{"@iot.id": record["@iot.id"]}];
	
			}
			var prop;
			for (var i=0; i<STAEntities[entityName].properties.length; i++) {
				if ((entityName=="Observations" ? STAEntities[entityName].properties[i].name=="parameters" : STAEntities[entityName].properties[i].name=="properties") || 
					((entityName=="Datastreams" || entityName=="MultiDatastreams") && (STAEntities[entityName].properties[i].name=="observedArea" || STAEntities[entityName].properties[i].name=="phenomenonTime" || STAEntities[entityName].properties[i].name=="resultTime")))
					continue;
				if ((entityName=="Locations" && STAEntities[entityName].properties[i].name=="location") || 
				    (entityName=="FeaturesOfInterest" && STAEntities[entityName].properties[i].name=="feature"))
				{
					//For the moment in supporting only a point
					obj[STAEntities[entityName].properties[i].name]={"type": "Point", "coordinates": []};
					obj[STAEntities[entityName].properties[i].name].coordinates[0]=parseFloat(document.getElementById("dlgCreateUpdateDeleteEntity_"+STAEntities[entityName].properties[i].name+"_longitude").value);
					obj[STAEntities[entityName].properties[i].name].coordinates[1]=parseFloat(document.getElementById("dlgCreateUpdateDeleteEntity_"+STAEntities[entityName].properties[i].name+"_latitude").value);
					continue;	
				}
				if (entityName=="Datastreams" && STAEntities[entityName].properties[i].name=="unitOfMeasurement")
				{
					//Something similar needs to be done for MultiDataStream
					obj[STAEntities[entityName].properties[i].name]={};
					obj[STAEntities[entityName].properties[i].name].name=document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_name").value ? document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_name").value : null;
					obj[STAEntities[entityName].properties[i].name].symbol=document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_symbol").value ? document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_symbol").value : null; 
					obj[STAEntities[entityName].properties[i].name].definition=document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_definition").value ? document.getElementById("dlgCreateUpdateDeleteEntity_" + STAEntities[entityName].properties[i].name + "_definition").value : null;
					continue;
				}
				prop=document.getElementById("dlgCreateUpdateDeleteEntity_"+STAEntities[entityName].properties[i].name).value;
				if (prop!=="")
					obj[STAEntities[entityName].properties[i].name]=(entityName=="Observations" && STAEntities[entityName].properties[i].name=="result" && !isNaN(prop)) ? parseFloat(prop) : prop;
			}

			GetObjectId(url, entityName, obj).then(
				function(value) {
					if (value)
					{ 
						document.getElementById("DialogCreateUpdateDeleteEntity").close();
						showInfoMessage('Available at: <a href="' + getUrlToId(url, entityName, value) + '" target="_blank">' + value + '</a>');
						node.STAURL=getUrlToId(url, entityName, value);
						node.STAdata=[];
						node.STAdata.push(obj);
						node.STAdata[0]["@iot.id"]=isNaN(value) ? value : parseInt(value);
						networkNodes.update(node);
					}
				},
				function(error) { 
					showInfoMessage('Error creating entity. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
					console.log(error) ;
				}
			);	
		}

		function GetUpdateEntity(event){
			event.preventDefault(); 
			document.getElementById("DialogCreateUpdateDeleteEntity").close();
			var parentNodes=GetParentNodes(currentNode);
			var url=parentNodes[0].STAURL;
			var entityName=getSTAEntityPlural(document.getElementById("dlgCreateUpdateDeleteEntityType").innerHTML)
			
			showInfoMessage("Updating  "+ STAEntities[entityName].singular +" "+parentNodes[0].STAURLIdSelected+" ...");
			
			var childrenNodes=document.getElementById("dlgCreateUpdateDeleteEntityProperties").childNodes;
			console.log(childrenNodes)
			var obj={}, idSplited
			for (var i=0;i<childrenNodes.length;i++){
				if (childrenNodes[i].nodeName=="INPUT"){
					//Està en reqired i al value es blanc? anulaho tot
					idSplited=childrenNodes[i].id.split("dlgCreateUpdateDeleteEntity_")[1];
					obj[idSplited]=childrenNodes[i].value;
				}
			}

			console.log(obj);

			var response= HTTPJSONData(url,null,"PUT",obj);
			


		}
		function AskForDeleteEntity(event){
			event.preventDefault(); 
			var parentNodes=GetParentNodes(currentNode);
			var entityName=getSTAEntityPlural(document.getElementById("dlgCreateUpdateDeleteEntityType").innerHTML);
			var entityNameSingular= STAEntities[entityName].singular;
			var id= parentNodes[0].STAURLIdSelected;

			var opcion = confirm("Do you want to erase "+entityNameSingular+" "+parentNodes[0].STAURLIdSelected);
				if (opcion == true) {
					GetDeleteEntity(entityName, id)
					console.log("borrar")
				} else{
					console.log("cancelar")
				}
		}


		function GetDeleteEntity(entityName, id){
			event.preventDefault(); 
			console.log("borrant")
			document.getElementById("DialogCreateUpdateDeleteEntity").close();
			var parentNodes=GetParentNodes(currentNode);
			var url=parentNodes[0].STAURL;

			//var response= HTTPJSONData(url,null,"DELETE",null);

			showInfoMessage("Deleting  "+ entityName +" "+id+" ...");
		}




		function GetSelectRow(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectRow").close();

			if (currentNode.STAURL)
				var previousSTAURL=currentNode.STAURL;

			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				if (parentNode.STAURL)
					currentNode.STAURL = parentNode.STAURL;
				if (parentNode.OGCType=="OGCAPIcollections")
					currentNode.OGCType = "OGCAPIitems";
			}
			else
				return;

			var elems = document.getElementsByName("SelectRowRadio");
			for (var i = 0; i < elems.length; i++) {
				if (elems[i].checked)
					break;
			}
			var requiresLoadJSON=currentNode.STAURL && (!parentNode || parentNode.OGCType!="OGCCSW");
			if (i < elems.length) {
				if (requiresLoadJSON) {
					const s = elems[i].id.substring("SelectRow_".length);
					currentNode.STAURLIdSelected=s;

					if (currentNode?.OGCType=="OGCAPIitems")
						currentNode.STAURL = parentNode.STAdata ? (parentNode.STAdata[i].link ? getURLWithoutQueryParams(parentNode.STAdata[i].link) : currentNode.STAURL+"/"+parentNode.STAdata[i].id) + "/items"  : parentNode.STAURL;
					else {					
						const n = Number(s);
						currentNode.STAURL = AddQueryParamsToURL(getURLWithoutQueryParams(currentNode.STAURL) + (Number.isInteger(n) ? "(" + n + ")" : "('" + s + "')"), getURLQueryParams(currentNode.STAURL));
					}
				}
				else  //This should be a table operation: I'll do it myself here
				{
					if (parentNode.STAdata && i<parentNode.STAdata.length){
						currentNode.STAdata=[];
						currentNode.STAdata.push(deapCopy(parentNode.STAdata[i]));
					}
				}
			}
			if (requiresLoadJSON){
				// currentNode.STAExpectedLength = parentNode.STAExpectedLength;
				currentNode.STAExpectedLength = document.getElementById("SelectNumberOfRecordsSelectRow").value;				
				if (currentNode.OGCType=="OGCAPIitems")
					askForCollectionQueryables();
			}
			else
				currentNode.STAURL = null;
				
			networkNodes.update(currentNode);
			if (requiresLoadJSON)
			{
				showInfoMessage("Selecting OGC row...");
				UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
				LoadJSONNodeSTAData(currentNode);
			}
		}

		function GetFilterRowsSTA() {
				var previousSTAURL = currentNode.STAURL;
				var parentNode = GetFirstParentNode(currentNode);
				if (parentNode) {
					if (parentNode.STAURL)
						currentNode.STAURL = parentNode.STAURL;
					if (parentNode.STAdata)
						currentNode.STAdata = parentNode.STAdata;
				}
				else
					return;

				currentNode.STAUrlAPICounter = []; // I need to restart it 
				var previousURL = parentNode.STAURL;//put URL ready to add things

				var prevFilter = GetQueryParamFromURL(parentNode.STAURL, "$filter");
				if (prevFilter) {
					currentNode.STAUrlAPI = RemoveQueryParamFromURL(parentNode.STAURL, "$filter");
					currentNode.STAUrlAPI = AddQueryParamsToURL(currentNode.STAUrlAPI, "$filter=" + prevFilter + " and ");
				}
				else
					currentNode.STAUrlAPI = AddQueryParamsToURL(parentNode.STAURL, "$filter=");

				stopreadInformationRowFilterSTA = false;
				var entity=getSTAURLLastEntity(currentNode.STAURL);

				readInformationRowFilterSTA(currentNode.STAelementFilter, entity, "no", "no"); //apply filter
				currentNode.STAURL = currentNode.STAUrlAPI;

				currentNode.STAExpectedLength = document.getElementById("SelectNumberOfRecordsFilterRows").value;
				LoadJSONNodeSTAData(currentNode);
				UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
			}
		function GetFilterRowsTable() {
			stopreadInformationRowFilterTable = false;
			currentNode.STAtableCounter = [];
			currentNode.STAtable = "";
			readInformationRowFilterTable(currentNode.STAelementFilter, "no", "no"); //apply filter
			applyEvalAndFilterData();
			UpdateChildenTable(currentNode);
				
		}
		async function GetFilterRowsOGCAPIFeatures(){
			var previousNode=networkNodes.get(network.getConnectedNodes(currentNode.id, "from"));
			var previousURL = previousNode[0].STAURL;//put URL ready to add things 
			if (currentNode.STAOGCAPIconformance.includes("cql-text")){
				currentNode.STAUrlAPICounter = []; // I need to restart it 
				stopreadInformationRowFilterOGCAPIFeatures = false;
				currentNode.STAURL = previousURL  +"?filter=";
				if (currentNode.STAUrlAPI){
					currentNode.STAUrlAPI="";
				}
				readInformationRowFilterOGCAPIFeatures(currentNode.STAelementFilter, "no", "no"); //apply filter
				currentNode.STAURL = currentNode.STAURL+currentNode.STAUrlAPI+"&f=json";
				currentNode.STAExpectedLength = document.getElementById("SelectNumberOfRecordsFilterRows").value;
				LoadJSONNodeSTAData(currentNode);
				networkNodes.update(currentNode);
				UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousURL);

			}

		}
		function GetFilterRows(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogFilterRows").close();
			//updateinfoFilter
			takeSelectInformation(currentNode.id);

			if (currentNode.image == "FilterRowsTable.png" ) { //import CSV
				GetFilterRowsTable();
			}else if (currentNode.STAOGCAPIconformance){//OGCAPIFeatures
				if (currentNode.STAOGCAPIconformance?.includes("filter")){
					GetFilterRowsOGCAPIFeatures()// we can apply filter from API
				}else{
					GetFilterRowsTable(); //No filter, use table filter
				}
			}else if (currentNode.image == "FilterRowsSTA.png"){ //STA
				GetFilterRowsSTA();
			}

			showInfoMessage("Filtering STA rows...");
			networkNodes.update(currentNode);
		}

		function getGeospatialFilter(node, parentNode){
			var data=node.STAdata, geometry, coords, cdns=[];
			for (var i=0; i<data.length; i++){
				cdns.push("geo.intersects(");
				var id=IdOfSTAEntity(parentNode);
				if (STAEntitiesArray[id]=="Parties" || STAEntitiesArray[id]=="Sensors" || STAEntitiesArray[id]=="ObservedProperties" || STAEntitiesArray[id]=="Things" || STAEntitiesArray[id]=="Licenses")
					cdns.push("Observations/FeatureOfInterest/");
				else if (STAEntitiesArray[id]=="Datastreams" || STAEntitiesArray[id]=="MultiDatastreams" || STAEntitiesArray[id]=="ObservationGroups")
					cdns.push("Observations/FeatureOfInterest/");
				else if (STAEntitiesArray[id]=="Observations")
					cdns.push("FeatureOfInterest/");
				cdns.push("feature,geography'");
				geometry=data[i]["geometry"];
				coords=geometry["coordinates"];
				if (geometry["type"]=="Polygon") {
					cdns.push("POLYGON (");
					for (var j=0; j<coords.length; j++){
						cdns.push("(");
						for (var k=0; k<coords[j].length; k++){
							cdns.push(coords[j][k][0], " ", coords[j][k][1]);
							if (k<coords[j].length-1)
								cdns.push(", ");
						}
						cdns.push(")");
						if (j<coords.length-1)
							cdns.push(",");
					}
					cdns.push(")')");
				}
				if (i<data.length-1)
					cdns.push(" or ");
			}
			return cdns.join("");
		}

		function DoGeoFilterRows(node) {
			var previousSTAURL=node.STAURL;
			var nodes=GetParentNodes(node);
			if (nodes && nodes.length>1)
				var parentNode=nodes[0];
			else
				return;				
			
			if (parentNode.STAURL)
				node.STAURL = parentNode.STAURL;
			if (parentNode.STAdata)
				node.STAdata = parentNode.STAdata;

			var previousURL = parentNode.STAURL;
		
			var geo=getGeospatialFilter(nodes[1], nodes[0]);
			
			if (!geo)
				return;

			var prevFilter=GetQueryParamFromURL(parentNode.STAURL, "$filter");
			if (prevFilter) {
				node.STAURL=RemoveQueryParamFromURL(parentNode.STAURL, "$filter");
				node.STAURL=AddQueryParamsToURL(node.STAURL, "$filter=" + prevFilter + " and " + geo);
			}
			else
				node.STAURL=AddQueryParamsToURL(parentNode.STAURL, "$filter="+geo);

			node.STAExpectedLength = parseInt(document.getElementById("SelectSortByNumberOfRecords").value);
			networkNodes.update(node);
			showInfoMessage("Filtering STA rows by polygon...");
			UpdateChildenSTAURL(node, node.STAURL, previousSTAURL);
			LoadJSONNodeSTAData(node);
		}

		function GetJoinTables(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogJoinTables").close();
			UpdateJoinTablesRowMatchingNode(currentNode);
			if (document.getElementById("DialogJoinTablesNotMatchRemove").checked)
				currentNode.STAJoinTables.NotMatch="Remove";
			else if (document.getElementById("DialogJoinTablesNotMatchLeftTable").checked)
				currentNode.STAJoinTables.NotMatch="LeftTable";
			else //if (document.getElementById("DialogJoinTablesNotMatchBothTables").checked)
				currentNode.STAJoinTables.NotMatch="BothTables";
			var parentNodes=GetParentNodes(currentNode);
			if (!parentNodes && parentNodes.length<2) {
				return;
			}
			currentNode.STAdataAttributes={};
			currentNode.STAdata=JoinTablesData(parentNodes[0].STAdata, parentNodes[1].STAdata, 
					parentNodes[0].STAdataAttributes ? parentNodes[0].STAdataAttributes : getDataAttributes(parentNodes[0].STAdata), 
					parentNodes[1].STAdataAttributes ? parentNodes[1].STAdataAttributes : getDataAttributes(parentNodes[1].STAdata), 
					currentNode.STAdataAttributes, currentNode.STAJoinTables);
			networkNodes.update(currentNode);
		}

		function IdOfSTAEntity(node) {
			for (var i = 0; i < STAEntitiesArray.length; i++) {
				if (node.image == STAEntitiesArray[i] + ".png")
					return i;
			}
			//Perhaps this node is a filter of a previous node. The URL can help me to find the entity to use
			if (node.STAURL)
				return STAEntitiesArray.indexOf(getSTAURLLastEntity(node.STAURL));
			return -1;
		}

		function IdOfSTASpecialQueries(node) {
			for (var i = 0; i < STASpecialQueriesArray.length; i++) {
				if (node.image == STASpecialQueriesArray[i] + ".png")
					return i;
			}
			return -1;
		}

		function UpdateChildenSTAURL(parentNode, currentSTAURLroot, previousSTAURLroot) {
			var nodeIds = network.getConnectedNodes(parentNode.id, 'to');
			for (var i = 0; i < nodeIds.length; i++) {
				var node = networkNodes.get(nodeIds[i])
				if (node.STAURL && currentSTAURLroot && previousSTAURLroot) {
					var previousSTAURLrootWithoutQuery=getURLWithoutQueryParams(previousSTAURLroot);
					if (node.STAURL.substring(0, previousSTAURLrootWithoutQuery.length)==previousSTAURLrootWithoutQuery)
					{
						var previousQueryParams=getURLQueryParams(previousSTAURLroot)
						var currentQueryParams=getURLQueryParams(currentSTAURLroot)
						var queryParam=getURLQueryParams(node.STAURL);
						if (!previousQueryParams && !currentQueryParams)
							;
						else if (!previousQueryParams)
							queryParam=queryParam ? queryParam + '&' + currentQueryParams : currentQueryParams;
						else 
							queryParam=queryParam.replace(previousQueryParams, currentQueryParams);
						
						getURLQueryParams(node.STAURL).replace(previousQueryParams, getURLQueryParams(currentSTAURLroot))
						node.STAURL = AddQueryParamsToURL(getURLWithoutQueryParams(currentSTAURLroot)+getURLWithoutQueryParams(node.STAURL).substring(previousSTAURLrootWithoutQuery.length), 
									queryParam);
						networkNodes.update(node);
					}
				}
				UpdateChildenSTAURL(node, currentSTAURLroot, previousSTAURLroot);
			}
		}

		function UpdateChildTableNode(node, parentNode) {
			node.STAdata = deapCopy(parentNode.STAdata);
			if (parentNode.STAdataAttributes)
				node.STAdataAttributes = deapCopy(parentNode.STAdataAttributes);
			if (parentNode.STAfileUrl)
				node.STAfileUrl = deapCopy(parentNode.STAfileUrl);
			networkNodes.update(node);
		}

		function UpdateChildenTable(parentNode) {
			var nodeIds = network.getConnectedNodes(parentNode.id, 'to');
			for (var i = 0; i < nodeIds.length; i++) {
				var node=networkNodes.get(nodeIds[i]);
				if (parentNode.STAdata && 
					(node.image == "SelectColumnsTable.png" || node.image == "Meaning.png"))
					UpdateChildTableNode(node, parentNode);
				UpdateChildenTable(node);
			 }
		}

		async function UpdateChildenLoadJSONCallback(parentNode) {
			var nodeIds = network.getConnectedNodes(parentNode.id, 'to');
			for (var i = 0; i < nodeIds.length; i++) {
				var node = networkNodes.get(nodeIds[i])
				if (node.image == "SeparateColumns.png")
					SeparateColumnsNode(node, parentNode);
				else if (node.image == "SelectColumnsTable.png")
				{
					//pensar com es podria fer.
					showInfoMessage("Automatic update of SelectColumns not implemented for table nodes.");
				}
				else if (IdOfSTAEntity(node) != -1 || IdOfSTASpecialQueries(node)!=-1 || TableOperations[removeExtension(node.image)].callSTALoad)
				{
					showInfoMessage("Updating "+ removeExtension(node.image) + " ...");
					await LoadJSONNodeSTAData(node);
				}
				else if (node.image == "OneValueSTA.png")
				{
					if (node.STAtimeOut) {
						clearTimeout(node.STAtimeOut);
						node.STAtimeOut=null;
					}
					await RequestLastObservationAndRefreshOneValue(node, node.STAvariable, node.STAtimeVariable, node.STAredrawPeriod);
				}
				else if (node.image == "CountResultsSTA.png")
				{
					if (node.STACountTimeOut) {
						clearTimeout(node.STACountTimeOut);
						node.STACountTimeOut=null;
					}
					await requestAndRefreshCountResults(node, node.STAredrawPeriodCount);
				}
			}
		}

		function getCSVWTypeFromAttributeType(t)
		{
			if (t=="array" || t=="null" || t=="object" || t=="undefined")
				return "json";
			return t;
		}

		function getAttributeTypeFromCSVWType(t)
		{
			if (t=="json")
				return "object";
			return t;
		}


		function getJSONSchemaTypeFromAttributeType(t)
		{
			if (t=="anyURI")
				return "string";
			return t;
		}

		//Creates dataAttributes and determines the "type" attribute only.
		function getDataAttributes(data) {
			var dataAttributes = {}, dataAttribute, type;

			for (var i = 0; i < data.length; i++) {
				var keys = Object.keys(data[i]);
				for (var k = 0; k < keys.length; k++) {
					if (dataAttributes[keys[k]]) {
						dataAttribute=dataAttributes[keys[k]];
						if (!isAttributeAnyURI(keys[k]))
						{
							type=getJSONType(data[i][keys[k]]);
							if (dataAttribute.type=="null" || dataAttribute.type=="undefined")
								dataAttribute.type=type;
							if (type!="null" && type!="undefined")
							{
								if ( (dataAttribute.type=="boolean" && type!="boolean") ||
								    ((dataAttribute.type=="integer" || dataAttribute.type=="number") && (type=="object" || type=="array" || type=="string")) ||
								    (dataAttribute.type=="string" && (type=="object" || type=="array")) ||
								    (dataAttribute.type=="array" && type=="object") )
									dataAttribute.type=type;
								else if (dataAttribute.type=="integer" && type=="number")
									dataAttribute.type="number";
							}
							if (dataAttribute.type=="object")
								break;
						}
					}
					else
						dataAttributes[keys[k]]={
							type: isAttributeAnyURI(keys[k]) ? "anyURI" : getJSONType(data[i][keys[k]])
						};
				}
			}
			return dataAttributes;
		}

		//Add the definition URL to a preexisting dataAttributes based on the STA Entity requested.
		function addSemanticsSTADataAttributes(dataAttributes, url) {
			var dataAttributesArray = Object.keys(dataAttributes);

			var parentLastEntity=getSTAEntityPlural(getSTAURLLastEntity(url), true);
			for (var attr = 0; attr < dataAttributesArray.length; attr++) {
				dataAttributes[dataAttributesArray[attr]].definition="http://www.opengis.net/def/docs/15-078r6/" + STAEntities[parentLastEntity].singular + "/" + dataAttributesArray[attr];
			}
		}

		function isAttributeAnyURI(s){
			return (s == "url" || s == "definition" || s.endsWith("@iot.selfLink") || s.endsWith("@iot.navigationLink"));
		}

		function isAttributeSelfNavLink(s){
			return (s.endsWith("@iot.selfLink") || s.endsWith("@iot.navigationLink"));
		}

		function ShowTableOptionsDiv(node, optionsDiv, fn_showTable) {
			if (node.STAdata && node.STAdata.length)
				document.getElementById(optionsDiv).innerHTML = "<label><input type='checkbox' "+ ((!document.getElementById(optionsDiv + "RowNumber") || document.getElementById(optionsDiv + "RowNumber").checked) ? "checked='checked' " : "") +"id='" + optionsDiv + "RowNumber' onChange='"+fn_showTable+"(networkNodes.get(\"" + node.id + "\"));'/> Show row numbers</label> &ensp;" +
										"<label><input type='checkbox' "+ ((!document.getElementById(optionsDiv + "SelfNavLink") || document.getElementById(optionsDiv + "SelfNavLink").checked) ? "checked='checked' " : "") +"id='" + optionsDiv + "SelfNavLink' onChange='"+fn_showTable+"(networkNodes.get(\"" + node.id + "\"));'/> Show self and navigation links</label>";
			else
				document.getElementById(optionsDiv).innerHTML = "";
		}

		function ShowTableDialog(node) {
			var data = node.STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogOKHTML").innerHTML = "No data to show.";
				return;
			}

			document.getElementById("DialogOKHTML").innerHTML = GetHTMLTable(data, node.STAdataAttributes ? node.STAdataAttributes : getDataAttributes(data),
				document.getElementById("DialogOKOptionsRowNumber").checked ? true : false,
				"", null, null, "", isAttributeAnyURI, document.getElementById("DialogOKOptionsSelfNavLink").checked ? null : isAttributeSelfNavLink);
		}

		function StringifyObjectElements(data, dataAttributesInput) {
			var dataAttributes = dataAttributesInput? dataAttributesInput : getDataAttributes(data);
			var jsonTable=[];
			var dataAttributesArray = Object.keys(dataAttributes);

			for (var i = 0; i < data.length; i++) {
				jsonTable[i]={};
				for (var a = 0; a < dataAttributesArray.length; a++)
					{
					if (typeof data[i][dataAttributesArray[a]] === "object")  //"arrays" are also objects.
						jsonTable[i][dataAttributesArray[a]]=JSON.stringify(data[i][dataAttributesArray[a]]);
					else
						jsonTable[i][dataAttributesArray[a]]=data[i][dataAttributesArray[a]];
				}
			}
			return jsonTable;
		}


		function GetGeoJSON(data, selectedOptions) {
			var geojson={"type": "FeatureCollection", "features": []};

			if (selectedOptions.time && selectedOptions.value) {
				var dataSorted=deapCopy(data); 

				//Sorted by place, variable and date (older first).
				dataSorted.sort(function (a, b) {
					if (a[selectedOptions.place]<b[selectedOptions.place])
						return -1;
					if (a[selectedOptions.place]>b[selectedOptions.place])
						return 1;
					if (a[selectedOptions.longitude]-b[selectedOptions.longitude]<-0.0000001)
						return -1;
					if (a[selectedOptions.longitude]-b[selectedOptions.longitude]>0.0000001)
						return 1;
					if (a[selectedOptions.latitude]-b[selectedOptions.latitude]<-0.0000001)
						return -1;
					if (a[selectedOptions.latitude]-b[selectedOptions.latitude]>0.0000001)
						return 1;
					if (a[selectedOptions.variable]<b[selectedOptions.variable])
						return -1;
					if (a[selectedOptions.variable]>b[selectedOptions.variable])
						return 1;
					if (a[selectedOptions.time]<b[selectedOptions.time])
						return -1;
					if (a[selectedOptions.time]>b[selectedOptions.time])
						return 1;
					return 0;});
				var a, b;
				for (var i = 0, f=-1; i < dataSorted.length; i++) {
					a=dataSorted[i], b=dataSorted[i==0 ? 0 : i-1];
					if (i==0 || a[selectedOptions.place]!=b[selectedOptions.place] ||
						a[selectedOptions.longitude]>b[selectedOptions.longitude]+0.0000001 ||
						a[selectedOptions.latitude]<b[selectedOptions.latitude]-0.0000001 ||
						a[selectedOptions.latitude]>b[selectedOptions.latitude]+0.0000001)
					{
						f++;
						geojson.features[f]={
							"type": "Feature",
							"geometry": {
								"type": "Point",
								"coordinates": [
									a[selectedOptions.longitude],
									a[selectedOptions.latitude]
								]
							},
							"properties": {
								"Place": a[selectedOptions.place],
							}
						};
					}
					geojson.features[f].properties[a[selectedOptions.variable]+"_"+a[selectedOptions.time]]=a[selectedOptions.value];
				}
			}
			else
			{
				for (var i = 0; i < data.length; i++) {
					var a=data[i];
					geojson.features.push({
							"type": "Feature",
							"geometry": {
								"type": "Point",
								"coordinates": [
									a[selectedOptions.longitude],
									a[selectedOptions.latitude]
								]
							},
							"properties": {
							}
						});
					if (selectedOptions.place) {
						geojson.features[i].properties["Place"]=a[selectedOptions.place];
					}
					var propertiesArray = Object.keys(a);
					for (var j=0; j<propertiesArray.length; j++) {
						if (propertiesArray[j]==selectedOptions?.place || propertiesArray[j]==selectedOptions?.longitude || propertiesArray[j]==selectedOptions?.latitude)
							continue;
						geojson.features[i].properties[propertiesArray[j]]=a[propertiesArray[j]];
					}
				}
			}
			return geojson;
		}

		function GetGeoJSONSchema(data, selectedOptions) {
			return {
				"$id": "https://meaning.ad4gd.eu/meaning.schema.json",
				"$schema": "https://meaning.ad4gd.eu/json-meta/meaning",
				"type": "object",
				"properties": {
					"features": {
						"type": "array",
						"items": {
							"type": "object",
							"properties": {
								"geometry": {
									"type": "object",
									"properties": {
										"type": {"type": "string"},
										"coordinates": {"type": "array"}
									}
								},
								"properties": {
									"type": "object",
									"properties": GetGeoJSONPropertiesSchema(data, null, selectedOptions)
								}
							}
						}
					}
				}
			};
		}

		function GetGeoJSONPropertiesSchema(data, dataAttributes, selectedOptions) {

			var attributes={};
			if (selectedOptions.place)
				attributes["Place"]= {"description": "Place name", "mostrar": "si"};

			if (selectedOptions.time && selectedOptions.value) {
				var dataSorted=deapCopy(data);

				//Sorted by variable.
				dataSorted.sort(function (a, b) {
					if (a[selectedOptions.variable]<b[selectedOptions.variable])
						return -1;
					if (a[selectedOptions.variable]>b[selectedOptions.variable])
						return 1;
					return 0;});
				var a, b, UoMSymbol;
				for (var i = 0; i < dataSorted.length; i++) {
					a=dataSorted[i], b=dataSorted[i==0 ? 0 : i-1];
					if (i==0 || a[selectedOptions.variable]!=b[selectedOptions.variable])
					{
						UoMSymbol=a[selectedOptions.variableUoMSymbol];
						if (UoMSymbol=="ug/m3")
							UoMSymbol=="µg/m³";
						attributes[a[selectedOptions.variable] + "_{time?f=ISO}"]={
							"description": a[selectedOptions.variableDescription],
							"definition": a[selectedOptions.variableDefinition],
							"UoM": a[selectedOptions.variableUoM],
							"UoMSymbol": UoMSymbol,
							"UoMDefinition": a[selectedOptions.variableUoMDefinition],
							"mostrar": "si",
							"serieTemporal": {
								"color": "#ff0000"
							}
						};
					}
				}
			} else {
				if (!dataAttributes)
					dataAttributes=getDataAttributes(data);
				var dataAttributesArray = Object.keys(dataAttributes);
				for (i=0; i<dataAttributesArray.length; i++)
				{
					if (dataAttributesArray[i]==selectedOptions?.place || dataAttributesArray[i]==selectedOptions?.longitude || dataAttributesArray[i]==selectedOptions?.latitude)
						continue;
					attributes[dataAttributesArray[i]]={
						"description": dataAttributes[dataAttributesArray[i]].description ? dataAttributes[dataAttributesArray[i]].description : null,
						"definition": dataAttributes[dataAttributesArray[i]].definition ? dataAttributes[dataAttributesArray[i]].definition : null,
						"UoM": dataAttributes[dataAttributesArray[i]].UoM ? dataAttributes[dataAttributesArray[i]].UoM : null,
						"UoMSymbol": dataAttributes[dataAttributesArray[i]].UoMSymbol? dataAttributes[dataAttributesArray[i]].UoMSymbol : null,
						"UoMDefinition": dataAttributes[dataAttributesArray[i]].UoMDefinition ? dataAttributes[dataAttributesArray[i]].UoMDefinition : null,
						"mostrar": "si",
					};
				}
			}
			return attributes;
		}

		function GetGeoJSONMetaschema() {
			return {
	"title": "GeoJSON properties meaning schema",
	"$schema": "http://json-schema.org/draft/2019-09/schema#",
	"$id": "https://meaning.ad4gd.eu/json-meta/meaning",
	"$vocabulary": {
		"https://json-schema.org/draft/2019-09/vocab/core": true,
		"https://json-schema.org/draft/2019-09/vocab/applicator": true,
		"https://json-schema.org/draft/2019-09/vocab/validation": true,
		"https://json-schema.org/draft/2019-09/vocab/meta-data": true,
		"https://json-schema.org/draft/2019-09/vocab/format": false,
		"https://json-schema.org/draft/2019-09/vocab/content": true,
		"https://meaning.ad4gd.eu/json-meta/meaning": false
	},
	"$recursiveAnchor": true,
	"allOf": [
		{
			"$ref": "https://json-schema.org/draft/2019-09/schema"
		},
		{
			"$ref": "#/definitions/AttributeDescription"
		}
	],
	"definitions": {
		"AttributeDescription": {
			"title": "GeoJSON meaning vocabulary meta-schema",
			"type": "object",
			"$comment": "The name of the property is the name of the attribute. If the server is SOS there are 2 special names can be used __om_time__, __om_sensor__ and the rest match the field names of the table containing the data. The properties that define each attribute can be de ones defined below or properties from JSON schema itself if indicated in this comment. For the moment, only 'description' is implemented. Others from 'string' (https://json-schema.org/understanding-json-schema/reference/string.html) or number can be useful (https://json-schema.org/understanding-json-schema/reference/numeric.html).",
			"properties": {
				"originalName": {
					"description": "Name of the original attribute. Optional. If the attributes are taken from a CSV and are transformed into one or more attributes (because they are associated with time). In this case the nomOri maybe different from the property name.",
					"type": [ "string", "null" ]
				},
				"symbol": {
					"description": "Symbol of the attribute. Note that it is not the units of measurement symbol but the attribute itself. For example, the letter 'σ' (sigma) usually represents the standard deviation. It will be used in the compact display (coordinates box) if defined. Created for statistical attributes, but can be used elsewhere.",
					"type": [ "string", "null" ]
				},
				"descripcio": {
					"description": "Description of the attribute in multiple languages. If you do not need multilanguage support, please use 'description'",
					"$ref": "#/definitions/StringOCadenaLang"
				},
				"definition": {
					"description": "A URI that defines the observedProperty or the variable. You may find the right definitions in https://qudt.org/2.1/vocab/quantitykind, http://vocabs.lter-europe.net/EnvThes or https://www.eea.europa.eu/help/glossary/eea-glossary.",
					"type": [ "string", "null" ],
					"format": "uri"
				},
				"UoM": {
					"description": "Units of measurement of the attribute. Formerly refered as 'unitats'",
					"type": [ "string", "null" ]
				},
				"UoMSymbol": {
					"description": "Symbol of the units of measurement of the atributte.",
					"type": [ "string", "null" ]
				},
				"UoMDefinition": {
					"description": "A URI that defines the units of measurement of the observedProperty or variable. You may find the right definitions in https://qudt.org/2.1/vocab/unit",
					"type": [ "string", "null" ],
					"format": "uri"
				},
				"calcul": {
					"description": "Mathematical formula to transform the values of one or more properties of another vector or raster 'capa'. To point to a raster 'capa', see the explanation in 'component'; to point to a vector 'capa', we should use {'i_capa': 2, 'prop': 'flower_name'} to refer to 'capa' 2 which is of 'model' ='vector'. Can only be used if there are capa.objectes on the given 'capa'. If you do not specify i_capa, this 'capa' is assumed. For each 'objecte' {'i_capa': 2, 'prop': 'flower_name'} (or the equivalent for raster 'capa' for each pixel) is transformed into the value and, once done, the formula is evaluated as JavaScript syntax.",
					"type": "string"
				},
				"FormulaConsulta": {
					"description": "Mathematical formula to transform the values of objectes[].feature[].properties of this 'capa' (or into values[]). To know about v[0] etc see the explanation under 'component'. Use p['name'] to indicate the name of the property inside properties. You can also specify nomPropId to refer to the feature identifier (e.g. the feature id, in case of GeoJSON). Can only be used if there is capa.valors or capa.objectes. If you want to choose a value from another 'capa' use 'calcul' instead. Internally, 'FormulaConsulta' is transformed into 'calcul'.",
					"type": "string"
				},
				"separador": {
					"description": "Separator of the next block of attributes",
					"$ref": "#/definitions/StringOCadenaLang"
				},
				"esLink": {
					"description": "Is the attribute value a link?",
					"type": "boolean"
				},
				"descLink": {
					"description": "Description of the link",
					"$ref": "#/definitions/StringOCadenaLang"
				},
				"esImatge": {
					"description": "Is the attribute value a image URI?. This forces the attribute to appear as an embedded image in the query box",
					"type": "boolean"
				},
				"FormatVideo": {
					"description": "If the attribute is a link to a video, this is the video format. This forces the attribute to appear as an embedded video with a play button in the query box. It should be a MIME type. Example: video/mp4. optional",
					"type": "string",
					"format": "uri"
				},
				"mostrar": {
					"description": "Should it be shown in the query box? Can be 'si' (always), 'no' (never), 'si_ple' (it will only be displayed if the attribute has content).",
					"enum": [ "si", "no", "si_ple" ]
				},
				"mida": {
					"description": "Implementation pending (maxLength should be used instead of 'mida'). Attribute size. Optional. Maximum width the field type can have. In the case of numerical types it is the maximum precision. In the case of strings it is the maximum length in characters. In the case of date-time it is the maximum length in characters of the representation of the date-time as text.",
					"type": "number"
				},
				"pDecimals": {
					"description": "Implementation pending. Number of decimals places of the attribute. It only applies if the attribute is of type 'number'. Optional. (Note: do not confused with NDecimals, which is the number of decimals to display in the screen).",
					"type": "number"
				},
				"presentation": {
					"description": "It is the format in which we receive the value from the server. Currently it is only used for a very specific thing in the interpretation of dates. In the future it could be combined with to the JSON schema 'type' to indicate whether string, date, number, float... and 'format'.",
					"enum": [ "dd/mm/yyyy" ]
				},
				"NDecimals": {
					"description": "Number of decimal places to be displayed in the screen. Optional, when not indicated, precision is not truncated.",
					"type": "number",
					"minimum": 0,
					"maximum": 20,
					"multipleOf": 1
				},
				"serieTemporal": {
					"description": "The values of this attribute form a time series that will be displayed as a graph.",
					"type": "object",
					"required": [ "color" ],
					"properties": {
						"color": {
							"description": "Line color in the graph",
							"type": "string"
						}
					}
				}
			}
		},
		"StringOCadenaLang": {
			"description": "String or multilanguage object.",
			"oneOf": [
				{
					"type": [ "string", "null" ]
				},
				{
					"type": "object",
					"properties": {
						"cat": {
							"description": "Català",
							"type": [ "string", "null" ]
						},
						"spa": {
							"description": "Español",
							"type": [ "string", "null" ]
						},
						"eng": {
							"description": "English",
							"type": [ "string", "null" ]
						},
						"fre": {
							"description": "Français",
							"type": [ "string", "null" ]
						},
						"cze": {
							"description": "Čeština",
							"type": [ "string", "null" ]
						},
						"ger": {
							"description": "Deutsch",
							"type": [ "string", "null" ]
						}
					}
				}
			]
		}
	}
};
		}

		function GetGeoJSONStyles(data, selectedOptions) {
			var estil=[];
			if (selectedOptions.time && selectedOptions.value) {

				var dataSorted=deapCopy(data);

				//Sorted by variable.
				dataSorted.sort(function (a, b) {
					if (a[selectedOptions.variable]<b[selectedOptions.variable])
						return -1;
					if (a[selectedOptions.variable]>b[selectedOptions.variable])
						return 1;
					return 0;});
				var a, b, maximum;
				for (var i = 0, f=-1; i < dataSorted.length; i++) {
					a=dataSorted[i], b=dataSorted[i==0 ? 0 : i-1];
					if (i==0 || a[selectedOptions.variable]!=b[selectedOptions.variable])
					{
						if (f>=0)
							estil[f].simbols[0].simbol[0].icona.r=maximum>0.001 ? 10/maximum: 1; 
						f++;
						maximum=a[selectedOptions.value];
						estil[f]={
							"nom": null,
							"desc": a[selectedOptions.variableDescription],
							"DescItems": a[selectedOptions.variableUoMSymbol],
							"TipusObj": "P",
							"ItemLleg": [
								{
									"color": "#ff0000",
									"DescColor": a[selectedOptions.variableDescription]
								}
							],
							"ncol": 1,
							"simbols": [
								{
									"NomCampFEscala": a[selectedOptions.variable] + "_{time?f=ISO}",
									"simbol": [
										{
											"icona": {
												"type": "circle",
												"r": 1
											}
										}
									]
								}
							],
							"formes": [{
								"vora": {
									"paleta": {
										"colors": [
											"#ff0000"
										]
									}
								},
								"interior": {
									"paleta": {
										"colors": [
											"rgba(255,0,0,0.4)"
										]
									}
								}}],
							"fonts": {
								"NomCampText": a[selectedOptions.variable] + "_{time?f=ISO}",
								"aspecte": [
									{
										"font": {
											"font": "12px Verdana",
											"color": "#B50000",
											"align": "center",
											"i": 0,
											"j": -5
										}
									}
								]
							}
						};
					}
					else
					{
						if (maximum<a[selectedOptions.value])
							maximum=a[selectedOptions.value];
					}
				}
				if (f>=0)
					estil[f].simbols[0].simbol[0].icona.r=maximum>0.001 ? 10/maximum: 1;
			}
			else
			{
				estil.push({
					"nom": null,
					"desc": null,
					"DescItems": null,
					"TipusObj": "P",
					"ItemLleg": [
						{
							"color": "#ff0000",
							"DescColor": ""
						}
					],
					"ncol": 1,
					"simbols": [
						{
							"simbol": [
								{
									"icona": {
										"type": "circle",
										"r": 10
									}
								}
							]
						}
					],
					"formes": [{
						"vora": {
							"paleta": {
								"colors": [
									"#ff0000"
								]
							}
						},
						"interior": {
							"paleta": {
								"colors": [
									"rgba(255,0,0,0.4)"
								]
							}
						}}],
					"fonts": {
						"NomCampText": selectedOptions.place ? "Place" : null,
						"aspecte": [
							{
								"font": {
									"font": "12px Verdana",
									"color": "#B50000",
									"align": "center",
									"i": 0,
									"j": -5
								}
							}
						]
					}
				});
			}
			return estil;
		}

		function GetGeoJSONDates(data, selectedOptions) {
			if (selectedOptions.time && selectedOptions.value) {
				var dataSorted=deapCopy(data), datetimes=[];

				//Sorted by date (older first).
				dataSorted.sort(function (a, b) {
					if (a[selectedOptions.time]<b[selectedOptions.time])
						return -1;
					if (a[selectedOptions.time]>b[selectedOptions.time])
						return 1;
					return 0;});
				var a, b;
				for (var i = 0; i < dataSorted.length; i++) {
					a=dataSorted[i], b=dataSorted[i==0 ? 0 : i-1];
					if (i==0 || a[selectedOptions.time]!=b[selectedOptions.time])
						datetimes.push(a[selectedOptions.time]);
				}
				return datetimes;
			}
			else
				return null;
		}

		/*function ShowSaveTableDialog(nodeId) {
			;   //Nothing to do
		}*/

		function PopulateSelectSaveLayerDialog(id, dataAttributes, selectedOption)
		{
			document.getElementById(id).innerHTML=GetSelectSaveLayerDialog(id+"Select", dataAttributes, selectedOption);
		}

		function GetSelectSaveLayerDialog(id, dataAttributes, selectedOption)
		{
			var thereIsSelectionOption=false;
			var dataAttributesArray = Object.keys(dataAttributes);
	
			var s="<select id=\""+id+"\">";
			for (var a=0; a<dataAttributesArray.length; a++)
			{
				if (dataAttributesArray[a]==selectedOption)
				{
					thereIsSelectionOption=true;
					break;
				}
			}
			s+="<option value=\"\""+ (!thereIsSelectionOption ? "selected=\"selected\"" : "") +"></option>";
			for (var a=0; a<dataAttributesArray.length; a++)
				s+="<option value=\""+dataAttributesArray[a]+"\""+ (dataAttributesArray[a]==selectedOption ? "selected=\"selected\"" : "") +">"+dataAttributesArray[a]+"</option>";
			s+="</select>";
			return s;
		}

		// params.nameInLegend
		// params.showValue
		// params.showType
		function GetHTMLVariableDefUoM(suffix, params) {
			var cdns=[];
			cdns.push('<fieldset>');
			if (params.nameInLegend)
				cdns.push('	<legend><span id="DialogSaveLayerVariable' + suffix + '"></span>',
					'	</legend>');
			else	
				cdns.push('	<legend>Observed property:</legend>',
					'	<label>Name:',
					'		<span id="DialogSaveLayerVariable' + suffix + '"></span>',
					'		</label>',
					'	<br>');
			if (params.showPredefOptions)
				cdns.push('	<label>Predefined options:',
					'		<span id="DialogMeaningVariableDropDown' + suffix + '"></span>',
					'		</label>',
					'	<br>');
			if (params.showType)
				cdns.push('	<label>Data type:',
					'		<span id="DialogMeaningVariableType' + suffix + '"></span>',
					'		</label>',
					'	<br>');
			cdns.push('	<span id="DialogMeaningVariableDescriptionUoM' + suffix + '">',
				'		<label>Description:',
				'			<span id="DialogMeaningVariableDescription' + suffix + '"></span>',
				'		</label>',
				'		<br>',
				'		<label>Definition (URI):',
				'			<span id="DialogMeaningVariableDefinition' + suffix + '"></span>',
				'		</label>',
				'		<br>',
				'		<fieldset>',
				'			<legend>Units of measurement:</legend>',
				'			<label>Name:',
				'				<span id="DialogMeaningVariableUoM' + suffix + '"></span>',
				'			</label>',
				'			<br>',
				'			<label>Symbol:',
				'				<span id="DialogMeaningVariableUoMSymbol' + suffix + '"></span>',
				'			</label>',
				'			<br>',
				'			<label>Definition (URI):',
				'				<span id="DialogMeaningVariableUoMDefinition' + suffix + '"></span>',
				'			</label>',
				'		</fieldset>',
				'		<br>',
				'	</span>');
			if (params.showValue)
				cdns.push('	<br>',
					'	<label>Value:',
					'		<span id="DialogSaveLayerValue' + suffix + '"></span>',
					'	</label>');
			cdns.push('</fieldset>');
			return cdns.join("");
		}			

		function ShowSaveLayerDialogSelects(node, descripUoM) {
			var parentNode=GetFirstParentNode(node);
			if (parentNode) {
				var data = parentNode.STAdata;
				var dataAttributes = parentNode.STAdataAttributes ? parentNode.STAdataAttributes : getDataAttributes(data);
				var s, elem;
				PopulateSelectSaveLayerDialog("DialogSaveLayerPlace", dataAttributes, "FeatureOfInterest/description");
				PopulateSelectSaveLayerDialog("DialogSaveLayerLongitude", dataAttributes, "FeatureOfInterest/feature/coordinates_0");
				PopulateSelectSaveLayerDialog("DialogSaveLayerLatitude", dataAttributes, "FeatureOfInterest/feature/coordinates_1");
				PopulateSelectSaveLayerDialog("DialogSaveLayerTime", dataAttributes, "phenomenonTime");
				PopulateSelectSaveLayerDialog("DialogSaveLayerVariable", dataAttributes, "Datastream/ObservedProperty/name");
				if (descripUoM){
					document.getElementById("DialogMeaningVariableDescriptionUoM").style.display="inline-block";
					PopulateSelectSaveLayerDialog("DialogMeaningVariableDescription", dataAttributes, "Datastream/ObservedProperty/description");
					PopulateSelectSaveLayerDialog("DialogMeaningVariableDefinition", dataAttributes, "Datastream/ObservedProperty/definition");
					PopulateSelectSaveLayerDialog("DialogMeaningVariableUoM", dataAttributes, "Datastream/unitOfMeasurement/name");
					PopulateSelectSaveLayerDialog("DialogMeaningVariableUoMSymbol", dataAttributes, "Datastream/unitOfMeasurement/symbol");
					PopulateSelectSaveLayerDialog("DialogMeaningVariableUoMDefinition", dataAttributes, "Datastream/unitOfMeasurement/definition");
				}
				else
					document.getElementById("DialogMeaningVariableDescriptionUoM").style.display="none";

				PopulateSelectSaveLayerDialog("DialogSaveLayerValue", dataAttributes, "result");
			}
		}

		function GetSelectedOptionsSaveLayer(descripUoM){
			var selectedOptions={};
			selectedOptions.place=document.getElementById("DialogSaveLayerPlaceSelect").value;
			selectedOptions.longitude=document.getElementById("DialogSaveLayerLongitudeSelect").value;
			selectedOptions.latitude=document.getElementById("DialogSaveLayerLatitudeSelect").value;
			selectedOptions.time=document.getElementById("DialogSaveLayerTimeSelect").value;
			selectedOptions.variable=document.getElementById("DialogSaveLayerVariableSelect").value;
			if (descripUoM){
				selectedOptions.variableDescription=document.getElementById("DialogMeaningVariableDescriptionSelect").value;
				selectedOptions.variableDefinition=document.getElementById("DialogMeaningVariableDefinitionSelect").value;
				selectedOptions.variableUoM=document.getElementById("DialogMeaningVariableUoMSelect").value;
				selectedOptions.variableUoMSymbol=document.getElementById("DialogMeaningVariableUoMSymbolSelect").value;
				selectedOptions.variableUoMDefinition=document.getElementById("DialogMeaningVariableUoMDefinitionSelect").value;
			}
			selectedOptions.value=document.getElementById("DialogSaveLayerValueSelect").value;
			return selectedOptions;
		}

		function ShowSaveLayerDialog(node) {
			document.getElementById("DialogSaveLayerVariableDefUoM").innerHTML=GetHTMLVariableDefUoM("", {nameInLegend: false, showValue: true})
			ShowSaveLayerDialogSelects(node, true);
			document.getElementById("DialogSaveLayerTitle").innerHTML="Save table as GeoJSON";
			document.getElementById("DialogSaveLayerSave").innerHTML="<button value=\"default\" onClick=\"SaveLayer(event)\">Save GeoJSON</button> " +
				"<button onClick=\"SaveLayerSchema(event)\">Save JSON Schema</button> " +
				"<button onClick=\"SaveLayerMetaschema(event)\">Save JSON Metaschema</button>";
		}

		function ShowOpenMapDialog(node) {
			document.getElementById("DialogSaveLayerVariableDefUoM").innerHTML=GetHTMLVariableDefUoM("", {nameInLegend: false, showValue: true});
			ShowSaveLayerDialogSelects(node, true);
			document.getElementById("DialogSaveLayerTitle").innerHTML="Open in the Map Browser";
			document.getElementById("DialogSaveLayerSave").innerHTML="<button value=\"default\" onClick=\"OpenMap(event)\">Open</button>";
		}

		function PopulateDialogSaveLayerVariableFromDropDownSelect(i) {
			var gi=JSON.parse(document.getElementById("DialogMeaningVariableDropDownSelect_" + i).value);
			if (gi==-1)
				return;
			PopulateDialogSaveLayerVarUoM(i, config.suggestedVarUoMs[gi.g].varUoMs[gi.i]);
		}

		function PopulateDialogSaveLayerVarUoM(i, varUoM) {
			document.getElementById("DialogMeaningVariableDescriptionInput_"+i).value=varUoM.description ? varUoM.description : "";
			document.getElementById("DialogMeaningVariableDefinitionInput_"+i).value=varUoM.definition ? varUoM.definition : "";
			document.getElementById("DialogMeaningVariableUoMInput_"+i).value=varUoM.UoM ? varUoM.UoM : "";
			document.getElementById("DialogMeaningVariableUoMSymbolInput_"+i).value=varUoM.UoMSymbol ? varUoM.UoMSymbol : "";
			document.getElementById("DialogMeaningVariableUoMDefinitionInput_"+i).value=varUoM.UoMDefinition ? varUoM.UoMDefinition : "";
		}

		function ShowMeaningTableDialog(node) {
			var data = node.STAdata, cdns, vus;
			var dataAttributes = node.STAdataAttributes ? node.STAdataAttributes : getDataAttributes(data);
			var dataAttributesArray = Object.keys(dataAttributes);

			document.getElementById("DialogMeaningFields").innerHTML="";
			for (var i = 0; i < dataAttributesArray.length; i++) {
				document.getElementById("DialogMeaningFields").innerHTML+=GetHTMLVariableDefUoM("_" + i, {nameInLegend: true, showValue: false, showType: true, showPredefOptions:true});
				document.getElementById("DialogSaveLayerVariable_"+i).innerHTML="Field "+(i+1)+ ": " + dataAttributesArray[i];

				cdns=[];
				cdns.push('<select id="DialogMeaningVariableDropDownSelect_' + i + '" onChange="PopulateDialogSaveLayerVariableFromDropDownSelect(' + i + ')">',
					"<option value='{\"g\":-1}'>--Select to populate below--</option>");
				for (var g=0; g<config.suggestedVarUoMs.length; g++) {
					cdns.push('<optgroup label="', config.suggestedVarUoMs[g].group, '">');
					vus=config.suggestedVarUoMs[g].varUoMs;
					for (var j=0; j<vus.length; j++)
						cdns.push("<option value='{\"g\":", g, ",\"i\":", j, "}'>", vus[j].varUoMdesc, "</option>");
				}
				cdns.push('</select>');				
				document.getElementById("DialogMeaningVariableDropDown_"+i).innerHTML=cdns.join("");

				document.getElementById("DialogMeaningVariableType_"+i).innerHTML=dataAttributes[dataAttributesArray[i]].type;
				document.getElementById("DialogMeaningVariableDescription_"+i).innerHTML='<input id="DialogMeaningVariableDescriptionInput_' + i + '" type="text" size="50" value="a">';
				document.getElementById("DialogMeaningVariableDefinition_"+i).innerHTML='<input id="DialogMeaningVariableDefinitionInput_' + i + '" type="text" size="50" value="">';
				document.getElementById("DialogMeaningVariableUoM_"+i).innerHTML='<input id="DialogMeaningVariableUoMInput_' + i + '" type="text" size="30" value="">';
				document.getElementById("DialogMeaningVariableUoMSymbol_"+i).innerHTML='<input id="DialogMeaningVariableUoMSymbolInput_' + i + '" type="text" size="15" value="">';
				document.getElementById("DialogMeaningVariableUoMDefinition_"+i).innerHTML='<input id="DialogMeaningVariableUoMDefinitionInput_' + i + '" type="text" size="50" value="">';
			}
			for (var i = 0; i < dataAttributesArray.length; i++)
				PopulateDialogSaveLayerVarUoM(i, dataAttributes[dataAttributesArray[i]]);
		}

		function GetMeaningTable() {
			var data = currentNode.STAdata;
			var dataAttributes = currentNode.STAdataAttributes ? currentNode.STAdataAttributes : getDataAttributes(data);
			var dataAttributesArray = Object.keys(dataAttributes);
			for (var i = 0; i < dataAttributesArray.length; i++) {
				dataAttributes[dataAttributesArray[i]].description=document.getElementById("DialogMeaningVariableDescriptionInput_"+i).value;
				dataAttributes[dataAttributesArray[i]].definition=document.getElementById("DialogMeaningVariableDefinitionInput_"+i).value;
				dataAttributes[dataAttributesArray[i]].UoM=document.getElementById("DialogMeaningVariableUoMInput_"+i).value;
				dataAttributes[dataAttributesArray[i]].UoMSymbol=document.getElementById("DialogMeaningVariableUoMSymbolInput_"+i).value;
				dataAttributes[dataAttributesArray[i]].UoMDefinition=document.getElementById("DialogMeaningVariableUoMDefinitionInput_"+i).value;
			}
			return dataAttributes;
		}
		
		function SaveMeaningTable(event) {
			event.preventDefault(); // We don't want to submit this form
			currentNode.STAdataAttributes=GetMeaningTable();
			networkNodes.update(currentNode);
			document.getElementById("DialogMeaningTable").close();
		}

		const urlSchemaMeaning="https://github.com/grumets/MiraMonMapBrowser/config_attributes_metaschema.json#/definitions/AttributeDescription";

		function ShareMeaningTable(event) {
			event.preventDefault(); // We don't want to submit this form
			currentNode.STAdataAttributes=GetMeaningTable();
			networkNodes.update(currentNode);
			var fileName=getFileName(currentNode.STAfileUrl);
			GUFCreateFeedbackWithReproducibleUsage([{title: fileName, code: fileName, codespace: getAddressPath(getAbsoluteURL(currentNode.STAfileUrl))}],
				{abstract: "Meaning of the fields in the "+fileName, specific_usage: "Share meaning of fields in tabular data",
				ru_code: JSON.stringify(currentNode.STAdataAttributes), ru_code_media_type: "application/json",
				ru_platform: "https://github.com/joanma747/TAPIS", ru_version: 0.9, ru_schema: urlSchemaMeaning},
				"eng", "" //access_token_type
			);
			showInfoMessage("Sharing Meaning. Redirected to NiMMbus (please authenticate and save).");
		}

		function SaveTable(event) {
			event.preventDefault(); // We don't want to submit this form
			var delimiter=document.getElementById("DialogSaveTableDelimiter").value;
			document.getElementById("DialogSaveTable").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				SaveLocalDataFile(Papa.unparse(StringifyObjectElements(parentNode.STAdata, parentNode.STAdataAttributes), { quotes: false, quoteChar: '"', escapeChar: '"', delimiter: (delimiter ? delimiter : ";"), header: true, newline: "\r\n", skipEmptyLines: "greedy"}), 
						(IdOfSTAEntity(parentNode) == -1) ?  "table" : STAEntitiesArray[IdOfSTAEntity(parentNode)], ".csv", "application/vnd.ms-excel");   //https://stackoverflow.com/questions/7076042/what-mime-type-should-i-use-for-csv
			}
		}

		//https://csvw.org/
		//https://w3c.github.io/csvw/metadata/#dialect-descriptions
		function CreateCSVW(data, dataAttributesInput, delimiter) {
			var dataAttributes = dataAttributesInput ? dataAttributesInput : getDataAttributes(data);
			var dataAttributesArray = Object.keys(dataAttributes), dataAttribute, c;

			var csvw={ tableSchema: {
					"columns": []
				},
				"dialect": {
					"header": true,
					"delimiter": delimiter
				}
			};
			for (var a = 0; a < dataAttributesArray.length; a++) {
				dataAttribute=dataAttributes[dataAttributesArray[a]];
				csvw.tableSchema.columns.push({
					"name": dataAttributesArray[a],
					"datatype": getCSVWTypeFromAttributeType(dataAttribute.type),
				});
				c=csvw.tableSchema.columns[a];
				if (dataAttribute.description)
					c.titles=dataAttribute.description;
				if (dataAttribute.definition)
					c.propertyUrl=dataAttribute.definition;
				if (dataAttribute.UoM)
					c.unitMeasureTitles=dataAttribute.UoM;
				if (dataAttribute.UoMSymbol)
					c.unitMeasureSymbol=dataAttribute.UoMSymbol;
				if (dataAttribute.UoMDefinition)
					c.unitMeasureUrl=dataAttribute.UoMDefinition;
			}
			return csvw;
		}


		function SaveCSVW(event) {
			event.preventDefault(); // We don't want to submit this form
			var delimiter=document.getElementById("DialogSaveTableDelimiter").value;
			document.getElementById("DialogSaveTable").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				SaveLocalDataFile(JSON.stringify(CreateCSVW(parentNode.STAdata, parentNode.STAdataAttributes, delimiter ? delimiter : ";"), null, "\t"), 
						(IdOfSTAEntity(parentNode) == -1 ?  "table" : STAEntitiesArray[IdOfSTAEntity(parentNode)]) + "_csvw", ".json", "application/json");   //https://stackoverflow.com/questions/7076042/what-mime-type-should-i-use-for-csv
			}
		}

		function getDataAttributesCSVW(csvw){
			var dataAttributes = {}, c;
			for (var a = 0; a < csvw.tableSchema.columns.length; a++) {
				c=csvw.tableSchema.columns[a];
				dataAttributes[c.name]={
					"type": getAttributeTypeFromCSVWType(c.datatype),
					"description": (c.titles && Array.isArray(c.titles)) ? c.titles[0] : c.titles,
					"definition": c.propertyUrl,
					"UoM": c.unitMeasureTitles && Array.isArray(c.unitMeasureTitles) ? c.unitMeasureTitles[0] : c.unitMeasureTitles,
					"UoMSymbol": c.unitMeasureSymbol,
					"UoMDefinition": c.unitMeasureUrl
				};
			}
			return dataAttributes;
		}

		function getDataAttributesGeoJSONSchema(jsonschema){
			var dataAttributes;
			dataAttributes=deapCopy(jsonschema.properties.features.items.properties.properties.properties);
			dataAttributes["geometry"]={
				"type": "object",
				"definition": "Datastream/Observations/FeatureOfInterest/feature/geometry"
			};
			return dataAttributes;
		}

		//Has the string s a ISO data in the position i?
		function fragmentStartsWithISODate(s, i) {
			return s.charAt(i+0) >= '0' && s.charAt(i+0) <= '9' &&
				s.charAt(i+1) >= '0' && s.charAt(i+1) <= '9' &&
				s.charAt(i+2) >= '0' && s.charAt(i+2) <= '9' &&
				s.charAt(i+3) >= '0' && s.charAt(i+3) <= '9' &&
				s.charAt(i+4) == '-' &&
				s.charAt(i+5) >= '0' && s.charAt(i+5) <= '1' &&
				s.charAt(i+6) >= '0' && s.charAt(i+6) <= '9' &&
				s.charAt(i+7) == '-' &&
				s.charAt(i+8) >= '0' && s.charAt(i+8) <= '3' &&
				s.charAt(i+9) >= '0' && s.charAt(i+9) <= '9' &&
				s.charAt(i+10) == 'T' &&
				s.charAt(i+11) >= '0' && s.charAt(i+11) <= '2' &&
				s.charAt(i+12) >= '0' && s.charAt(i+12) <= '9' &&
				s.charAt(i+13) == ':' &&
				s.charAt(i+14) >= '0' && s.charAt(i+14) <= '5' &&
				s.charAt(i+15) >= '0' && s.charAt(i+15) <= '9' &&
				s.charAt(i+16) == ':' &&
				s.charAt(i+17) >= '0' && s.charAt(i+17) <= '5' &&
				s.charAt(i+18) >= '0' && s.charAt(i+18) <= '9' &&
				s.charAt(i+19) == 'Z';
		}

		//transforms a full ISO data (2024-03-05T01:41:00Z) into a template {time?f=ISO}
		function replaceISODateBySISOTemplate(s) {
			for (var i=0; i<s.length-19; i++) {
				if (fragmentStartsWithISODate(s, i)) {
					s=s.substring(0, i) + "{time?f=ISO}" + s.substring(i+20);
					i+=11;
				}
			}
			return s;
		}
		//returns the first full ISO data (2024-03-05T01:41:00Z) found in the string
		function getISODateFromDataAttribute(s) {
			for (var i=0; i<s.length-19; i++) {
				if (fragmentStartsWithISODate(s, i)) {
					return s.substr(i, 20);
				}
			}
			return null;
		}

		function removeTimeISOTemplate(attributeName)
		{
			var s=attributeName.replaceAll("{time?f=ISO}", "");
			if (s.length>1 && (s[s.length-1]=="_" || s[s.length-1]=="-" || s[s.length-1]==" "))
				s=s.substr(0, s.length-1);
			return s;
		}

		function transformTimeSeriesTemplateIntoObservedPropertyTimeValue(data, dataAttributes)
		{	
			var dataAttributesArray=Object.keys(dataAttributes);

			var dataAttrFromData=getDataAttributes(data)
			var dataAttrFromDataArray=Object.keys(dataAttrFromData);

			for (var a=0; a<dataAttributesArray.length; a++) {
				if (-1!=dataAttributesArray[a].indexOf("{time?f=ISO}"))
					break;
			}
			if (a==dataAttributesArray.length)
				return null; //nothing to do.

			var resultDataAttributes={}
			var resultDataAttributesValues={};
			for (var a=0; a<dataAttributesArray.length; a++) {
				if (-1!=dataAttributesArray[a].indexOf("{time?f=ISO}"))
					resultDataAttributesValues[removeTimeISOTemplate(dataAttributesArray[a])]=deapCopy(dataAttributes[dataAttributesArray[a]]);
				else
					resultDataAttributes[dataAttributesArray[a]]=deapCopy(dataAttributes[dataAttributesArray[a]]);
			}
			resultDataAttributes["extractedObservedProperty"]={
				"definition": "Datastream/ObservedProperty/name"
			};
			resultDataAttributes["extractedPhenomenonTime"]={
				"definition": "Datastream/Observations/phenomenonTime"
			};
			resultDataAttributes["extractedValue"]={
				"definition": "Datastream/Observations/result"
			};
			var resultData=[], resultRecord, record, first, replaceddataAttrFromDataItem;
			for (var r=0; r<data.length; r++) {  //for each record
				record=data[r];
				resultData.push({});
				resultRecord=resultData[resultData.length-1];
				first=true;
				for (var i=0; i<dataAttrFromDataArray.length; i++) {  //for each attribute found in the data
					if (dataAttributes[dataAttrFromDataArray[i]]) {
						if (typeof record[dataAttrFromDataArray[i]] !== "undefined")
							resultRecord[dataAttrFromDataArray[i]]=record[dataAttrFromDataArray[i]];
					}
				}
				for (var i=0; i<dataAttrFromDataArray.length; i++) {  //for each attribute found in the data
					if (dataAttributes[dataAttrFromDataArray[i]])
						continue;
					replaceddataAttrFromDataItem=replaceISODateBySISOTemplate(dataAttrFromDataArray[i]);
					if (dataAttributes[replaceddataAttrFromDataItem] && replaceddataAttrFromDataItem!=dataAttrFromDataArray[i]) {
						if (!first) {
							resultData.push(deapCopy(resultRecord));
							resultRecord=resultData[resultData.length-1];
						}
						resultRecord["extractedObservedProperty"]=removeTimeISOTemplate(replaceddataAttrFromDataItem);
						resultRecord["extractedPhenomenonTime"]=getISODateFromDataAttribute(dataAttrFromDataArray[i]);
						resultRecord["extractedValue"]=record[dataAttrFromDataArray[i]];
						first=false;
					}
				}
			}
			return {data: resultData, dataAttributes: resultDataAttributes, dataAttributesValues: resultDataAttributesValues};
		}
	
		function transformObservedPropertyTimeValueIntoTimeSemanticValues(data, dataAttributes, dataAttributesValues, observedPropertyName, phenomenonTimeName, extractedValueName) {

			function sortObservedPropertyTimeValue(a, b) {
				for (var i=0; i<dataAttributesArray.length; i++) {
					if (dataAttributesArray[i]==observedPropertyName ||
					    dataAttributesArray[i]==phenomenonTimeName ||
					    dataAttributesArray[i]==extractedValueName)
						continue;	
					if (a[dataAttributesArray[i]]<b[dataAttributesArray[i]])
						return -1;
					if (a[dataAttributesArray[i]]>b[dataAttributesArray[i]])
						return 1;
				}
				if (a[phenomenonTimeName]<b[phenomenonTimeName])
					return -1;
				if (a[phenomenonTimeName]>b[phenomenonTimeName])
					return 1;
				return 0;};

			//Sort by time
			var dataSorted=deapCopy(data);
			var dataAttributesArray=Object.keys(dataAttributes);
			dataSorted.sort(sortObservedPropertyTimeValue);

			var resultDataAttributes={}
			for (var attr=0; attr<dataAttributesArray.length; attr++) {
				if (dataAttributesArray[attr]==observedPropertyName ||
				    dataAttributesArray[attr]==extractedValueName)
					continue;	
				resultDataAttributes[dataAttributesArray[attr]]=deapCopy(dataAttributes[dataAttributesArray[attr]]);
			}
			var dataAttributesValuesArray=Object.keys(dataAttributesValues);
			for (var attr=0; attr<dataAttributesValuesArray.length; attr++) {
				resultDataAttributes[dataAttributesValuesArray[attr]]=deapCopy(dataAttributesValues[dataAttributesValuesArray[attr]]);
			}

			var resultData=[], resultRecord, a, b;

			for (var r=0; r<data.length; r++) {
				a=dataSorted[r];
				b=dataSorted[r==0 ? 0 : r-1];
				if (r==0 || 0!=sortObservedPropertyTimeValue(a,b)) {
					resultData.push({});
					resultRecord=resultData[resultData.length-1];
					for (var attr=0; attr<dataAttributesArray.length; attr++) {
						if (dataAttributesArray[attr]==observedPropertyName ||
						    dataAttributesArray[attr]==extractedValueName ||
						    dataAttributesValues[dataAttributesArray[attr]])
							continue;
						if (a[dataAttributesArray[attr]])
							resultRecord[dataAttributesArray[attr]]=a[dataAttributesArray[attr]];
					}
				}
				if (a[observedPropertyName])
					resultRecord[a[observedPropertyName]]=a[extractedValueName];
			}
			return {data: resultData, dataAttributes: resultDataAttributes};
		}

		function getCSVReadParams(csvw){
			return csvw.dialect;
		}

		function SaveLayer(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSaveLayer").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				SaveLocalDataFile(JSON.stringify(GetGeoJSON(parentNode.STAdata, GetSelectedOptionsSaveLayer(false)), null, "\t"), "GeoJSON", ".geojson", "application/geo+json");
			}
		}

		function SaveLayerSchema(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSaveLayer").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				SaveLocalDataFile(JSON.stringify(GetGeoJSONSchema(parentNode.STAdata, GetSelectedOptionsSaveLayer(true)), null, "\t"), "JSON", ".json", "application/json");
			}
		}

		function SaveLayerMetaschema(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSaveLayer").close();
			SaveLocalDataFile(JSON.stringify(GetGeoJSONMetaschema(), null, "\t"), "JSON", ".json", "application/json");
		}

		function OpenMap(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSaveLayer").close();
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode) {
				var selectedOptionsSaveLayer=GetSelectedOptionsSaveLayer(true);
				OpenMapMMN(getAbsoluteURL(config.MMNpath) + (config.MMNpath.indexOf('?')>0 ? "&" : "?") + "reset=1", GetGeoJSON(parentNode.STAdata, selectedOptionsSaveLayer), GetGeoJSONPropertiesSchema(parentNode.STAdata, parentNode.STAdataAttributes, selectedOptionsSaveLayer), GetGeoJSONStyles(parentNode.STAdata, selectedOptionsSaveLayer), GetGeoJSONDates(parentNode.STAdata, selectedOptionsSaveLayer));
			}
		}

		function AddGUF(event) {
			event.preventDefault(); // We don't want to submit this form
			GUFAfegirFeedbackCapa(document.getElementById("DialogGUFTitleInput").value, document.getElementById("DialogGUFCodeInput").value, document.getElementById("DialogGUFCodespaceInput").value, "eng", "authenix", null)
		}

		function EditGUF(event) {
			event.preventDefault(); // We don't want to submit this form
			GUFOpenNimmbus("eng", "authenix");
		}

		function ShowGUF(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogGUF").close();
			
			var previousSTAURL = currentNode.STAURL;

			currentNode.STAURL = ServerGUF+"?SERVICE=WPS&REQUEST=EXECUTE&IDENTIFIER=NB_RESOURCE:ENUMERATE&LANGUAGE=eng&FORMAT=text/xml&TYPE=FEEDBACK";
			currentNode.STAURL +="&TRG_TYPE_1=CITATION&TRG_FLD_1=CODE&TRG_VL_1=" + document.getElementById("DialogGUFCodeInput").value + "&TRG_OPR_1=EQ&TRG_NXS_1=AND&TRG_TYPE_2=CITATION&TRG_FLD_2=NAMESPACE&TRG_VL_2=" + document.getElementById("DialogGUFCodespaceInput").value + "&TRG_OPR_2=EQ";			

			currentNode.OGCType = "GUF";
			
			networkNodes.update(currentNode);

			UpdateChildenSTAURL(currentNode, currentNode.STAURL, previousSTAURL);
			LoadJSONNodeSTAData(currentNode);
		}

		var MiraMonMapBrowserVars={};

		function DisplayMapMMN(){
			MiraMonMapBrowserVars.mmn.postMessage("CommandMMNAddGeoJSONLayer('SensorThings API data', "+ JSON.stringify(MiraMonMapBrowserVars.geojson) + ", " + JSON.stringify(MiraMonMapBrowserVars.geojsonSchema) + ", " + JSON.stringify(MiraMonMapBrowserVars.geojsonStyle) + ", " + JSON.stringify(MiraMonMapBrowserVars.geojsonDates) + ")", GetCleanURLMiraMonMapBrowser(MiraMonMapBrowserVars.mmnURL));
		}

		function OpenMapMMN(url, geojson, geojsonSchema, geojsonStyle, geojsonDates){
			MiraMonMapBrowserVars.geojson=geojson;
			MiraMonMapBrowserVars.geojsonSchema=geojsonSchema;
			MiraMonMapBrowserVars.geojsonStyle=geojsonStyle;
			MiraMonMapBrowserVars.geojsonDates=geojsonDates;
			if (MiraMonMapBrowserVars.mmn)
				DisplayMapMMN();
			else
			{
				window.addEventListener("message", ProcessMessageFromMiraMonMapBrowser);
				MiraMonMapBrowserVars.mmnURL=url;
				MiraMonMapBrowserVars.mmn=window.open(url, "_blank", "width=1000,height=800");
			}
		}

		function ProcessMessageFromMiraMonMapBrowser(event)
		{
			if (!IsTrustedMiraMonMapBrowser(event, MiraMonMapBrowserVars.mmnURL))
				return;

			try
			{
				var data=JSON.parse(event.data);
			}
			catch (e) 
			{
				showInfoMessage("JSON message parse error: " + e + " The response was:\n" + event.data);
				return;
			}

			if (data.msg === MMN_PM_IsListening)
			{
				showInfoMessage("MiraMon Map Browser is open and ready to show layers.");
				DisplayMapMMN();
				return;
			}

			if (data.msg === MMN_PM_Closed)
			{
				showInfoMessage("MiraMon Map Browser has been closed.");
				MiraMonMapBrowserVars.mmn=null;
				MiraMonMapBrowserVars.mmnURL=null;
				return;
			}
			/*if (data.msg === MMN_PM_CurrentLocationText)
			{
				MiraMonMapBrowserVars.currentLocText=data.text;
				return;
			}*/
		}

		function ShowTableSelectSortByDialog(node) {
			var data = node.STAdata;

			if (!data || !data.length) {
				document.getElementById("DialogSelectSortByRadioButtons").innerHTML = "No data to show.";
				return;
			}

			var dataAttributes = node.STAdataAttributes ? node.STAdataAttributes : getDataAttributes(data);

			const dataAttributesArray = Object.keys(dataAttributes);

			var s = "";
			var first=true;
			for (var a = 0; a < dataAttributesArray.length; a++)
			{
				if (!dataAttributesArray[a].endsWith("@iot.navigationLink") && dataAttributesArray[a].charAt(0)!='@')
				{
					s += "<label><input type='radio'" + (first ? "checked='checked'" : "") + " id='SelectSortByEntity_" + a + "' name='SelectSortByEntity'/> " + dataAttributesArray[a] + "</label><br>";
					first=false;
				}
			}
			document.getElementById("DialogSelectSortByRadioButtons").innerHTML = s;
			//document.getElementById("DialogSelectSortByHTML").style.display = "inline-block";
			document.getElementById("SelectSortByNumberOfRecords").value=node.STAExpectedLength;
		}


		function ShowTableSelectRowDialog(parentNode, node) {
			var data = parentNode.STAdata;
			
			if (node.STAURL)
				addTitleInRowFilterDialog("divTitleSelectRow");

			document.getElementById("SelectNumberOfRecordsSelectRowLabel").style.display=(node.image == "SelectRowTable.png") ? "none" : "inline-block";

			if (!data || !data.length) {
				document.getElementById("DialogSelectRowsTable").innerHTML = "No data to show.";
				return;
			}
			document.getElementById("DialogSelectRowsTable").innerHTML = GetHTMLTable(data, parentNode.STAdataAttributes ? parentNode.STAdataAttributes : getDataAttributes(data), false, "SelectRow_", node.STAURLIdSelected ? node.STAURLIdSelected : 0, null, "", isAttributeAnyURI);
		}

		function ShowTableFilterRowsDialog(parentNode, node) {
			var data = parentNode.STAdata;
			node.STAdata=data; //Put all data from parent in this node 
			networkNodes.update(node);
			var dataAttributes = getDataAttributes(data);

			if (parentNode.image != "FilterRowsTable.png") {
					addTitleInRowFilterDialog("divTitleSelectRows");
			}

			if (!data || !data.length) {
				document.getElementById("DialogSelectRowsTable").innerHTML = "No data to show.";
				return;
			}

			document.getElementById("DialogSelectRowsFilter").innerHTML = "<div id='selectorRowsContainer'><div id='divSelectorRowsFilter'></div></div>"; 
			var SelectNumberOfRecordsFilterRows=document.getElementById("SelectNumberOfRecordsFilterRows");
			var SelectNumberOfRecordsFilterRowsLabel=document.getElementById("SelectNumberOfRecordsFilterRowsLabel");

			if (node.image=="FilterRowsTable.png"){ //Hide number request
				SelectNumberOfRecordsFilterRows.style.display="none";
				SelectNumberOfRecordsFilterRowsLabel.style.display="none";
			}else{
				SelectNumberOfRecordsFilterRows.style.display="inline-block";
				SelectNumberOfRecordsFilterRowsLabel.style.display="inline-block";
			}
			if (node.STAExpectedLength){ //"write" number of data required previously 
				document.getElementById('SelectNumberOfRecordsFilterRows').value= node.STAExpectedLength
			}
			
			addNecessaryVariablesToFilterRowsSTANode(node);
			
			if (node.image=="FilterRowsSTA.png" && node.STAOGCAPIconformance){
				if (node.STAOGCAPIconformance.includes("filter")){ //Create Filters if the API allows to filter its information
					ShowFilterTable();

				}else{
				showFilterTableWithoutFilters(); //OGCAPIFeatures without filter option		
				}
			}else{
				ShowFilterTable(); //STA and CSV 
			}
		}

		function SeparateColumns(event) {
			event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSeparateColumns").close();
			var options={};
			if (document.getElementById("DialogSeparateColumnsArrayAs_Records").checked)
				options.arraysAsRecords=true;
			if (document.getElementById("DialogSeparateColumns_RemovePresent").checked)
			 	options.removeAlreadyPresent=true;
			var parentNode=GetFirstParentNode(currentNode);
			if (parentNode)
				SeparateColumnsNode(currentNode, parentNode, options);
		}

		function SeparateColumnsNode(node, parentNode, options) {
			var data=parentNode.STAdata;

			if (!data)
				showInfoMessage("No data loaded in the parent node.");
			if (parentNode.STAURL)
				node.STAURL=parentNode.STAURL;

			node.STAExpectedLength = parentNode.STAExpectedLength;
			if (parentNode.STAdataAttributes)
				node.STAdataAttributes={};

			node.STAdata=SeparateColumnsData(data, parentNode.STAdataAttributes, node.STAdataAttributes, options);
			networkNodes.update(node);
		}

		function ShowQueryNode(node) {
			if (node.STAURL) {
				document.getElementById("showQueryLink").innerHTML =
							document.getElementById("showQueryLink").href = node.STAURL;
				document.getElementById("showQuery").style.display="inline-block";
			} else {
				document.getElementById("showQueryLink").innerHTML="";
				document.getElementById("showQuery").style.display="none";
			}
		}

		function ShowTableNode(node)
		{
			if (node.STAdata && node.STAdata.length) {
				ShowTableOptionsDiv(node, "showTableOptions", "ShowTableNode");
				document.getElementById("showTable").innerHTML = GetHTMLTable(node.STAdata, node.STAdataAttributes ? node.STAdataAttributes : getDataAttributes(node.STAdata),
					document.getElementById("showTableOptionsRowNumber").checked ? true : false,
					"", null, null, "", isAttributeAnyURI, document.getElementById("showTableOptionsSelfNavLink").checked ? null : isAttributeSelfNavLink);
			} else {
				document.getElementById("showTableOptions").innerHTML="";
				document.getElementById("showTable").innerHTML="";
			}
		}

		/*return 
			null means connection should not be done.
			true means all done
			false means pending.*/
		function StartCircularImage(nodeTo, nodeFrom, calUnir)
		{
			var errorText=reasonNodeDoesNotFitWithPrevious(nodeTo, nodeFrom);
			/*if (nodeFrom.STALastEntity) { //I will need it to know "where I am" in Row filter (To apply the filter)
				nodeTo.STALastEntity = nodeFrom.STALastEntity;
			}*/
			if (errorText)
			{
				alert("Incompatible node. " + errorText + ". It has not been added.");
				return null;
			}
			if (nodeFrom.STAURL && IdOfSTAEntity(nodeTo) != -1) {
				if (nodeFrom.image=="sta.png")
					nodeTo.STAURL = nodeFrom.STAURL + "/" + STAEntitiesArray[IdOfSTAEntity(nodeTo)];
				else 
					nodeTo.STAURL = nodeFrom.STAURL + "/" + getConnectionSTAEntity(nodeFrom, nodeTo).entity;
				nodeTo.STAExpectedLength = nodeFrom.STAExpectedLength;

				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				showInfoMessage("Requesting " + STAEntitiesArray[IdOfSTAEntity(nodeTo)] + " to STA...");
				LoadJSONNodeSTAData(nodeTo);
				//nodeTo.STALastEntity = STAEntitiesArray[IdOfSTAEntity(nodeTo)]; //I will need it to Row Filter
				return true;
			}
			if (nodeFrom.STAURL && IdOfSTASpecialQueries(nodeTo) != -1) {
				nodeTo.STAURL = nodeFrom.STAURL + "/" + STASpecialQueries[STASpecialQueriesArray[IdOfSTASpecialQueries(nodeTo)]].query;
				nodeTo.STAExpectedLength = nodeFrom.STAExpectedLength;
				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				showInfoMessage("Requesting " + STASpecialQueriesArray[IdOfSTASpecialQueries(nodeTo)] + " to STA...");
				LoadJSONNodeSTAData(nodeTo);
				return true;
			}
			if (nodeFrom.STAURL && (nodeTo.image == "SelectColumnsSTA.png" || nodeTo.image == "ExpandColumnsSTA.png" || nodeTo.image == "SelectRowSTA.png" || nodeTo.image == "FilterRowsSTA.png" || nodeTo.image == "SortBySTA.png")) {
				nodeTo.STAURL = nodeFrom.STAURL;
				nodeTo.STAExpectedLength = nodeFrom.STAExpectedLength;
				if (nodeFrom.STAdata)
					nodeTo.STAdata = deapCopy(nodeFrom.STAdata);
				if (nodeFrom.STAdataAttributes)
					nodeTo.STAdataAttributes = deapCopy(nodeFrom.STAdataAttributes);
				networkNodes.update(nodeTo);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
					/*if (nodeFrom.OGCType){
					if (nodeTo.image == "FilterRowsSTA.png"&& nodeFrom.OGCType=="OGCAPIitems"){
						askForConformanceInOGCAPIFeatures();//OCGAPICconformande will be in select node
					}
				}*/
				//showInfoMessage("Selecting " + (nodeTo.image == "SelectColumnsSTA.png" ? "columns" : "rows") + " to STA...");
				//LoadJSONNodeSTAData(nodeTo);
				return true;
			}
			if (nodeTo.image == "GeoFilterRowsSTA.png") {
				if (!GetFirstParentNode(nodeTo)){
					nodeTo.STAURL = nodeFrom.STAURL;
					nodeTo.STAExpectedLength = nodeFrom.STAExpectedLength;
					if (nodeFrom.STAdata)
						nodeTo.STAdata = deapCopy(nodeFrom.STAdata);
					if (nodeFrom.STAdataAttributes)
						nodeTo.STAdataAttributes = deapCopy(nodeFrom.STAdataAttributes);		
					networkNodes.update(nodeTo);
				} else if (!nodeTo.STAURL)
					return false;
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				DoGeoFilterRows(nodeTo);
				return true;
			}
			if (nodeTo.image == "Meaning.png" || 
                            nodeTo.image == "SelectColumnsTable.png" || nodeTo.image == "SelectRowTable.png" || 
			    nodeTo.image == "FilterRowsTable.png" || nodeTo.image == "JoinTables.png"){
				if (nodeFrom.STAdata)
					nodeTo.STAdata = deapCopy(nodeFrom.STAdata);  //This copy will be done again in "SelectColumnsTable.png" and "SelectRowTable.png". We do it here to have the full table while the user does not enter any selection
				if (nodeFrom.STAdataAttributes)
					nodeTo.STAdataAttributes = deapCopy(nodeFrom.STAdataAttributes);
				networkNodes.update(nodeTo);
				UpdateChildTableNode(nodeTo, nodeFrom);
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				return true;
			}
			if (nodeTo.image == "SeparateColumns.png") {
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				SeparateColumnsNode(nodeTo, nodeFrom);
				return true;
			}
			if (nodeTo.image == "CreateColumns.png") {
				 if (nodeFrom.STAdata){
				 	nodeTo.STAdata = deapCopy(nodeFrom.STAdata); //necessary first time
					networkNodes.update(nodeTo);
				 }
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				return true;
			}
			if (nodeTo.image == "AggregateColumns.png") {
				if (nodeFrom.STAdata){
					nodeTo.STAdata = deapCopy(nodeFrom.STAdata); //necessary first time
					networkNodes.update(nodeTo);
				}
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				return true;
			}
			if (nodeTo.image == "staRoot.png") {
				if (nodeFrom) {
					var previousSTAURL=nodeTo.STAURL;
					nodeTo.STAURL=getSTAURLRoot(nodeFrom.STAURL);
					nodeTo.STAExpectedLength = nodeFrom.STAExpectedLength;
					networkNodes.update(nodeTo);
				}
				if (calUnir)
					networkEdges.add([{ from: nodeFrom.id, to: nodeTo.id, arrows: "from" }]);
				if (nodeFrom) {
					UpdateChildenSTAURL(nodeTo, nodeTo.STAURL, previousSTAURL);
					LoadJSONNodeSTAData(nodeTo);
				}
				return true;
			}
			return false;
		}

		function KeySTAPage(event) {
			//if (event.keyCode == 113)  //F2
			if (event.code == "F2" || event.code == "Delete"){
				event.preventDefault();
				var nodeId = network.getSelectedNodes();
				if (nodeId && nodeId.length) {
					switch (event.code) {
						case "F2":
							renameNode(nodeId[0]);
							break;
						case "Delete":
							removeNode(nodeId[0]);
							break;
					}
				}
			}
		}

		// create an array with nodes	
		var networkNodes = new vis.DataSet([]);

		// create an array with edges	
		var networkEdges = new vis.DataSet([]);
		var networkOptions = {
				interaction: { hover: true },
				manipulation: {  //https://stackoverflow.com/questions/39701703/add-edge-dynamically-visjs
					enabled: false,
					addEdge: function (data, callback) {
						//console.log('add edge', data);
						if (data.from == data.to)
							showInfoMessage("Connection to the same node is not allowed.");
						else {
							networkEdges.add([{ from: data.to, to: data.from, arrows: "from"}]);
							showInfoMessage("Connected.");
							StartCircularImage(networkNodes.get(data.from), networkNodes.get(data.to), false);
						}
						connectionInProcess = false;
					}
				}
			};

		var network = new vis.Network(document.getElementById("mynetwork"), {
			nodes: networkNodes,
			edges: networkEdges
		}, networkOptions);

		/*network.on("click", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "Click event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("click event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});*/
		function networkDoubleClick(params) {
			/*params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "doubleClick event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);*/

			if (params.nodes && params.nodes.length && !connectionInProcess) {
				currentNode = networkNodes.get(params.nodes[0])
				if (currentNode.image == "sta.png") {
					document.getElementById("divTitleDialogSTAURL").innerHTML = "SensorThings API and STAplus";
					if (currentNode.STAURL)
						document.getElementById("DialogSTAURLInput").value = currentNode.STAURL;
					document.getElementById("DialogSTAURLSelect").innerHTML = GetOptionsSelectDialog(config.suggestedSTAurls);
					//document.getElementById("DialogSTAURLInput").readOnly = false;
					//document.getElementById("DialogSTAURLOk").style.display = "inline-block";
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						// Has de table a dataURL and a schemaURL?, then I add this to the dialogbox.
						var data=parentNode.STAdata;
						if (!data || !data.length) 
							alert("Parent node has no data loaded. It will be ignored.");
						else if (data.length>1)
							alert("Parent node has more than one row. Please select on row first. It will be ignored.");
						else {
							var record=data[0];
							if (!record.dataURL)
								alert("Parent node has no dataURL column. It will be ignored.");
							else 
								document.getElementById("DialogSTAURLInput").value = record.dataURL;
						}
					}
					document.getElementById("DialogSTAURL").showModal();
				}
				else if (currentNode.image == "ogcAPIs.png") {
					document.getElementById("divTitleDialogSTAURL").innerHTML = "OGC API collections";
					if (currentNode.STAURL)
						document.getElementById("DialogSTAURLInput").value = currentNode.STAURL;
					document.getElementById("DialogSTAURLSelect").innerHTML = GetOptionsSelectDialog(config.suggestedOGCAPIurls);
					document.getElementById("DialogSTAURL").showModal();
				}
				else if (currentNode.image == "csw.png") {
					document.getElementById("divTitleDialogSTAURL").innerHTML = "Catalogues (OGC CSW)";
					if (currentNode.STAURL)
						document.getElementById("DialogSTAURLInput").value = currentNode.STAURL;
					document.getElementById("DialogSTAURLSelect").innerHTML = GetOptionsSelectDialog(config.suggestedCatalogues);
					document.getElementById("DialogSTAURL").showModal();
				}
				else if (currentNode.image == "ViewQuerySTA.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode)
						document.getElementById("DialogSTAViewQueryLink").innerHTML =
							document.getElementById("DialogSTAViewQueryLink").href = parentNode.STAURL;
					else
						document.getElementById("DialogSTAViewQueryLink").innerHTML="";
					//document.getElementById("DialogSTAURLInput").readOnly = true;
					//document.getElementById("DialogSTAURLOk").style.display = "none";
					document.getElementById("DialogSTAViewQuery").showModal();
				}
				else if (currentNode.image == "ImportCSV.png") {
					document.getElementById("DialogImportCSVSourceURLSelect").innerHTML = GetOptionsSelectDialog(config.suggestedCSVurls);
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						// Has de table a dataURL and a schemaURL?, then I add this to the dialogbox.
						var data=parentNode.STAdata;
						if (!data || !data.length) 
							alert("Parent node has no data loaded. It will be ignored.");
						else if (data.length>1)
							alert("Parent node has more than one row. Please select on row first. It will be ignored.");
						else {
							var record=data[0];
							if (!record.dataURL)
								alert("Parent node has no dataURL column. It will be ignored.");
							else {
								document.getElementById("DialogImportCSVSourceFile").checked=false;
								document.getElementById("DialogImportCSVSourceURL").checked=true;
								document.getElementById("DialogImportCSVSourceURLInput").value=record.dataURL;
								document.getElementById("DialogImportCSVSourceURLButton").disabled=false;
								
								if (record.schemaURL)
								{
									document.getElementById("DialogImportMeaningCSVSourceFile").checked=false;
									document.getElementById("DialogImportMeaningCSVSourceURL").checked=true;
									document.getElementById("DialogImportMeaningCSVSourceAuto").checked=false;
									document.getElementById("DialogImportMeaningCSVSourceURLInput").value=record.schemaURL;
									document.getElementById("DialogImportMeaningCSVSourceURLButton").disabled=false;
								}
							}
						}
					}
					document.getElementById("DialogImportCSV").showModal();
				}
				else if (currentNode.image == "ImportGeoJSON.png") {
					document.getElementById("DialogImportGeoJSONSourceURLSelect").innerHTML = GetOptionsSelectDialog(config.suggestedGeoJSONurls);
					document.getElementById("DialogImportGeoJSON").showModal();
				}
				else if (currentNode.image == "Table.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						ShowTableOptionsDiv(parentNode, "DialogOKOptions", "ShowTableDialog");
						ShowTableDialog(parentNode);
						document.getElementById("DialogOK").showModal();
					}
				}
				else if (currentNode.image == "UploadObservations.png") {
					ShowUploadObservationsDialog(currentNode);
					document.getElementById("DialogUploadObservations").showModal();
				}
				/*else if (currentNode.image == "UploadTimeAverages.png") {
					ShowUploadTimeAveragesDialog(currentNode.id);
					document.getElementById("UploadTimeAverages").showModal();
				}*/
				else if (currentNode.image == "SaveTable.png") {
					//ShowSaveTableDialog(currentNode.id);
					document.getElementById("DialogSaveTable").showModal();
				}
				else if (currentNode.image == "ScatterPlot.png") {
					var parentNodes=GetParentNodes(currentNode);
					if (parentNodes && parentNodes[0]) {
						if (parentNodes[0].STAdata)
							ShowScatterPlotDialog(parentNodes);
						document.getElementById("DialogScatterPlot").showModal();
					}
				}
				else if (currentNode.image == "BarPlot.png") {
					var parentNodes=GetParentNodes(currentNode);
					if (parentNodes && parentNodes[0]) {
						if (parentNodes[0].STAdata)
							ShowBarPlotDialog(parentNodes);
						document.getElementById("DialogBarPlot").showModal();
					}
				}
				else if (currentNode.image == "ImageViewer.png") {
					var parentNodes=GetParentNodes(currentNode);
					if (parentNodes && parentNodes[0]) {
						if (parentNodes[0].STAdata)
							ShowImageViewerDialog(parentNodes);
						document.getElementById("DialogImageViewer").showModal();
					}
				}
				else if (currentNode.image == "OneValueSTA.png") {
					ShowOneValueDialog(currentNode);
					document.getElementById("DialogOneValue").showModal();
				}
				else if (currentNode.image == "CountResultsSTA.png") {
					startingNodeContextId=currentNode.id;
					document.getElementById("DialogCountResults").showModal();
				}
				else if (currentNode.image == "SaveLayer.png") {
					ShowSaveLayerDialog(currentNode);
					document.getElementById("DialogSaveLayer").showModal();
				}
				else if (currentNode.image == "OpenMap.png") {
					ShowOpenMapDialog(currentNode);
					document.getElementById("DialogSaveLayer").showModal();
				}
				else if (currentNode.image == "guf.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						var data=parentNode.STAdata;
						if (!data || !data.length) 
							alert("Parent node has no data loaded. It will be ignored.");
						else if (data.length>1)
							alert("Parent node has more than one row. Please select on row first. It will be ignored.");
						else {
							var record=data[0];
							if (!record.dataURL)
								alert("Parent node has no dataURL column. It will be ignored.");
							else {
								document.getElementById("DialogGUFTitleInput").value=record.title;
								document.getElementById("DialogGUFCodeInput").value=record.dataURL;
								document.getElementById("DialogGUFCodespaceInput").value="";
								if (parentNode.STAURL)
									document.getElementById("DialogGUFCodespaceInput").value=parentNode.STAURL;
								else {
									var grandParentNode=GetFirstParentNode(parentNode);
									if (grandparentNode && grandParentNode.STAURL)
										document.getElementById("DialogGUFCodespaceInput").value=grandParentNode.STAURL;
								}
							}
						}
					}
					document.getElementById("DialogGUF").showModal();
				}
				else if (currentNode.image == "Meaning.png") {
					ShowMeaningTableDialog(currentNode);
					document.getElementById("DialogMeaningTable").showModal();
				}				
				else if (currentNode.image == "SelectColumnsSTA.png" || currentNode.image == "SelectColumnsTable.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						ShowTableSelectColumnsDialog("SelectColumns", parentNode, currentNode, true);
						document.getElementById("DialogSelectColumns").showModal();
					}
				}
				else if (currentNode.image == "SeparateColumns.png") {
					document.getElementById("DialogSeparateColumns").showModal();
				}
				else if (currentNode.image == "ExpandColumnsSTA.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						ShowTableSelectExpandsDialog(parentNode, currentNode, true);
						document.getElementById("DialogSelectExpands").showModal();
					}
				}
				else if (currentNode.image == "JoinTables.png") {
					var parentNodes=GetParentNodes(currentNode);
					if (parentNodes && parentNodes.length>1) {
						ShowJoinTablesDialog(parentNodes, currentNode);
						document.getElementById("DialogJoinTables").showModal();
					}
				}
				else if (currentNode.image == "SelectRowSTA.png" || currentNode.image == "SelectRowTable.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						if (parentNode.STAOGCAPIconformance){
							currentNode.STAOGCAPIconformance=parentNode.STAOGCAPIconformance;
						}
						
						if ((currentNode.image == "SelectRowSTA.png" && parentNode.STAURL) ||
						    currentNode.image == "SelectRowTable.png") {
							ShowTableSelectRowDialog(parentNode, currentNode);
						}
						document.getElementById("DialogSelectRow").showModal();
					}
				}
				else if (currentNode.image == "FilterRowsSTA.png" || currentNode.image == "FilterRowsTable.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						if (parentNode.STAOGCAPIconformance){
							currentNode.STAOGCAPIconformance=parentNode.STAOGCAPIconformance;
						}
						if (parentNode.STAOGCAPIqueryable){
							currentNode.STAOGCAPIqueryable=parentNode.STAOGCAPIqueryable;
						}
						if (parentNode.OGCType){
							currentNode.OGCType="OGCAPIitem";
						}
						ShowTableFilterRowsDialog(parentNode, currentNode);
						document.getElementById("DialogFilterRows").showModal();
					}
				}
				else if (currentNode.image == "SortBySTA.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						if (parentNode.STAURL)
							ShowTableSelectSortByDialog(parentNode);
						document.getElementById("DialogSelectSortBy").showModal();
					}
				}
				else if (currentNode.image == "GroupBy.png") {
					var parentNode=GetFirstParentNode(currentNode);
					if (parentNode) {
						ShowGroupByDialog(parentNode, currentNode);
						document.getElementById("DialogGroupBy").showModal();
					}
				}				
				else if (currentNode.image == "CreateColumns.png") {
					var parentNode=GetFirstParentNode(currentNode);
					createColumnListToAddColumns();//create columnsList including columns in the table 
					if (parentNode.STAdata){
						currentNode.STAdataCopy=currentNode.STAdata; //To recovery data if cancel is pressed
						currentNode.STAdata = deapCopy(parentNode.STAdata); //Necessary to reset data taking it from parent	
					}
					 if (parentNode) {
						if (!currentNode.STAnewColumnsToAdd){
							currentNode.STAnewColumnsToAdd=[]; //First time: To create it. Later: To erase old values					
						}
						networkNodes.update(currentNode);
						drawTableInColumnBoxTableInCreateColumns();
						document.getElementById("DialogCreateColumns").showModal();
					 }		
				}

				else if (currentNode.image == "AggregateColumns.png") {
					var parentNode=GetFirstParentNode(currentNode);
					createColumnListToAddColumns();//create columnsList including columns in the table 
					if (parentNode.STAdata){
						currentNode.STAdataCopy=currentNode.STAdata; //To recovery data if cancel is pressed
						currentNode.STAdata = deapCopy(parentNode.STAdata); //Necessary to reset data taking it from parent
					}
					fillAggregateColumVariablesList();
					showCheckRadioOptions("operationsFieldSet", "operationsRadioAggrgatedColumns_", AggregationColumnsOptions, 3, "operationsRadioAggrgatedColumns", "writeColumnNameInAggregatedColumns (event)");
					if (parentNode) {
						if (!currentNode.STAnewColumnsToAdd){
							currentNode.STAnewColumnsToAdd=[]; //First time: To create it. Later: To erase old values					
						}
						networkNodes.update(currentNode);
						drawTableInColumnBoxTableInAggregateColumns()
						document.getElementById("DialogAggregateColumns").showModal();
					}
				}
				else if (currentNode.image == "ColumnsCalculator.png") {
					var parentNode=GetFirstParentNode(currentNode);
					
					if (parentNode.STAdata){
						if (currentNode.STAdata){
							currentNode.STAdataCopy=currentNode.STAdata; //To recovery data if cancel is pressed
							createColumnListToAddColumns();//create columnsList including columns in the table
							currentNode.STAdata = deapCopy(parentNode.STAdata); //Necessary to reset data taking it from parent	
						}else{
							currentNode.STAdata = deapCopy(parentNode.STAdata); //Necessary to reset data taking it from parent	
							createColumnListToAddColumns();//create columnsList including columns in the table
						}						
					}
					
					fillCalculatorColumVariablesList();
					document.getElementById("textAreaFormulaColumnsCalculator").setAttribute("data-mousePosition",0);
					if (parentNode) {
						if (!currentNode.STAnewColumnsToAdd){
							currentNode.STAnewColumnsToAdd=[]; //First time: To create it. Later: To erase old values					
						}
						networkNodes.update(currentNode);
						drawTableInColumnBoxTableInCalculatorColumns();
						document.getElementById("DialogColumnsCalculator").showModal();
					}
				}
				else if (currentNode.image == "SeparateColumns.png") {
					;
				}
				else if (currentNode.image == "GeoFilterRowsSTA.png" || 
					IdOfSTAEntity(currentNode) != -1 ||
					IdOfSTASpecialQueries(currentNode) != -1) {
					document.getElementById("DialogSelectNRecords").showModal();
				}
				else if (currentNode.image == "ObservedProperty.png" || currentNode.image == "Observation.png" || 
					currentNode.image == "FeatureOfInterest.png" || currentNode.image == "Sensor.png" || 
					currentNode.image == "Thing.png" || currentNode.image == "Location.png" || 
					currentNode.image == "HistoricalLocation.png" || currentNode.image == "Datastream.png" || 
					currentNode.image == "MultiDatastream.png" || currentNode.image == "Party.png" || 
					currentNode.image == "Campaign.png" || currentNode.image == "License.png" || 
					currentNode.image == "ObservationGroup.png" || currentNode.image == "Relation.png") {
					startingNodeContextId=currentNode.id;
					if (GetFirstParentNode(currentNode)) {
						if (PopulateCreateUpdateDeleteEntity(getSTAEntityPlural(removeExtension(currentNode.image), true), currentNode))
							document.getElementById("DialogCreateUpdateDeleteEntity").showModal();
					}
				}
			}
		}

		function networkContext(params) {
			params.event.preventDefault();  //https://stackoverflow.com/questions/38258940/open-an-extension-popup-html-list-on-right-click-of-node-contextmenu-in-visj

			var nodeId = network.getNodeAt(params.pointer.DOM); //params.nodes is not useful here as params.nodes are the selected ones and not the ones rightclicked.
			if (nodeId) {
				startingNodeContextId = nodeId;
				document.getElementById("DialogContextMenu").showModal();
				return;
			}
			var edgeId = network.getEdgeAt(params.pointer.DOM);
			if (edgeId) {
				startingEdgeContextId = edgeId;
				document.getElementById("DialogEdgeContextMenu").showModal();
			}
			/*params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "oncontext (right click) event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);*/
		}

		function networkSelectNode(params) {
			params.event.preventDefault();  //https://stackoverflow.com/questions/38258940/open-an-extension-popup-html-list-on-right-click-of-node-contextmenu-in-visj

			var nodeId = network.getNodeAt(params.pointer.DOM); //params.nodes is not useful here as params.nodes are the selected ones and not the ones rightclicked.
			if (nodeId) {
				var node=networkNodes.get(nodeId);
				ShowQueryNode(node);
				ShowTableNode(node);
				return;
			}
		}

		function setEventFunctionsNetwork() {
			network.on("doubleClick", networkDoubleClick);
			network.on("oncontext", networkContext);
			network.on("selectNode", networkSelectNode);
		}
		setEventFunctionsNetwork();

		/*network.on("dragStart", function (params) {
			// There's no point in displaying this event on screen, it gets immediately overwritten
			params.event = "[original event]";
			console.log("dragStart Event:", params);
			console.log("dragStart event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});
		network.on("dragging", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "dragging event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("dragEnd", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "dragEnd event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("dragEnd Event:", params);
			console.log("dragEnd event, getNodeAt returns: " + this.getNodeAt(params.pointer.DOM));
		});
		network.on("controlNodeDragging", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "control node dragging event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("controlNodeDragEnd", function (params) {
			params.event = "[original event]";
			document.getElementById("eventSpanHeading").innerText = "control node drag end event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
			console.log("controlNodeDragEnd Event:", params);
		});
		network.on("zoom", function (params) {
			document.getElementById("eventSpanHeading").innerText = "zoom event:";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("showPopup", function (params) {
			document.getElementById("eventSpanHeading").innerText = "showPopup event: ";
			document.getElementById("eventSpanContent").innerText = JSON.stringify(params, null, 4);
		});
		network.on("hidePopup", function () {
			console.log("hidePopup Event");
		});
		network.on("select", function (params) {
			console.log("select Event:", params);
		});
		network.on("selectEdge", function (params) {
			console.log("selectEdge Event:", params);
		});
		network.on("deselectNode", function (params) {
			console.log("deselectNode Event:", params);
		});
		network.on("deselectEdge", function (params) {
			console.log("deselectEdge Event:", params);
		});
		network.on("hoverNode", function (params) {
			console.log("hoverNode Event:", params);
		});
		network.on("hoverEdge", function (params) {
			console.log("hoverEdge Event:", params);
		});
		network.on("blurNode", function (params) {
			console.log("blurNode Event:", params);
		});
		network.on("blurEdge", function (params) {
			console.log("blurEdge Event:", params);
		});*/


		function addCircularImage(event, dialog, label, image) {
			var returnStart=false;
			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			var newId = (Math.random() * 1e7).toString(32);
			var node = { id: newId, label: label, image: image, shape: "circularImage" };

			if (image == "sta.png" || image == "ogcAPIs.png")
				node.STAExpectedLength = 100;

			if (!startingNodeContextId)
				networkNodes.add(node);
			else
			{
				returnStart=StartCircularImage(node, networkNodes.get(startingNodeContextId), true);
				if (returnStart==null)
					return;
				if (!returnStart)
				{
					networkNodes.add(node);
					networkEdges.add([{ from: startingNodeContextId, to: newId, arrows: "from" }]);
				}
			}

			if (startingNodeContextId)
				startingNodeContextId = null;

			network.selectNodes([newId]);
		}

		function removeNode(nodeId)
		 {
			var node=networkNodes.get(nodeId);
			if (confirm("Do you want to remove the node '" + node.label + "'?"))
			{
				networkNodes.remove(nodeId);
				return 0;
			}
			return 1;
		}

		function removeCircularImage(event, dialog) {

			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			if (startingNodeContextId) {
				if (0==removeNode(startingNodeContextId))
					startingNodeContextId = null;
			}
		}

		function renameNode(nodeId){
			var node=networkNodes.get(nodeId);
			var name=prompt("Change node label to:", node.label);
			if (name!=null)
			{
				node.label=name;
				networkNodes.update(node);
			}
		}

		function renameCircularImage(event, dialog) {
			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			if (startingNodeContextId) {
				renameNode(startingNodeContextId);
				startingNodeContextId = null;
			}
		}

		function addEdge() {
			network.addEdgeMode();
			connectionInProcess = true;
			showInfoMessage("Press the mouse botton on the starting node (child node), and drag and drop the mouse on the end node (parent node).");
		}

		function removeEdge(event, dialog) {
			if (event)
				event.preventDefault(); // We don't want to submit this form
			if (dialog)
				document.getElementById(dialog).close();
			if (startingEdgeContextId) {
				if (confirm("Do you want to remove the edge?"))
				{
					networkEdges.remove(startingEdgeContextId);
					startingEdgeContextId = null;
				}
			}
		}

		function openNetwork(data) {
			network.destroy();
			networkNodes = new vis.DataSet(data.nodes);
			networkEdges = new vis.DataSet(data.edges);
			network = new vis.Network(document.getElementById("mynetwork"), {
						nodes: networkNodes,
						edges: networkEdges
				}, networkOptions);
			setEventFunctionsNetwork();
		}

		function openFileNetwork(event) {
			var input = event.target;

			var reader = new FileReader();
			reader.onload = function() {
				//Transform the JSON text in something in memory
				try
				{
					openNetwork(JSON.parse(reader.result));
					document.getElementById("openNetworkFileName").value = null;  //https://stackoverflow.com/questions/3528359/html-input-type-file-file-selection-event
				}
				catch (e) 
				{
					showInfoMessage("JSON message parse error: " + e + " The file content is:\n" + reader.result);
					return;
				}
			};
			reader.readAsText(input.files[0]);
		}

		function openURLNetwork(event) {
			document.getElementById("DialogOpenURLNetwork").close();
			HTTPJSONData(document.getElementById("DialogOpenURLNetworkInput").value).then(
						function(value) {
							openNetwork(value.obj);
							showInfoMessage('Download network completed.'); 
						},
						function(error) { 
							showInfoMessage('Error downloading network. <br>name: ' + error.name + ' message: ' + error.message + ' at: ' + error.at + ' text: ' + error.text);
							console.log(error) ;
						}
					);	
		}

		function saveNetwork(event){
			var pos=network.getPositions()
			var posArray=Object.keys(pos);
			var data={nodes:[], edges:[]};
			for (var i=0; i<posArray.length; i++)
			{
				data.nodes.push(deapCopy(networkNodes._data[posArray[i]]));
				data.nodes[i].x=pos[posArray[i]].x;
				data.nodes[i].y=pos[posArray[i]].y;
			}
			var edgesArray=Object.keys(networkEdges._data);
			for (var i=0; i<edgesArray.length; i++)
			{
				data.edges.push(deapCopy(networkEdges._data[edgesArray[i]]));
				delete data.edges[i].id;
			}
			SaveLocalDataFile(JSON.stringify(data, null, "\t"), "network", ".json", "application/json");
		}

		async function reloadSTA(event) {
			var nodesArray=Object.keys(networkNodes._data);
			for (var i=0; i<nodesArray.length; i++)
			{
				var node=networkNodes._data[nodesArray[i]];
				if (node.image=="sta.png")
				{
					showInfoMessage("Reload STA home page and dependencies...");
					showInfoMessage("Requesting STA page...");
					await LoadJSONNodeSTAData(node, function () {
						showInfoMessage("Reload STA home page and dependencies completed.");
					});
				}
				else if (node.image=="ogcSTAs.png")
				{
					showInfoMessage("Reload OGC API collections page and dependencies...");
					showInfoMessage("Requesting OGC API collections page...");
					await LoadJSONNodeSTAData(node, function () {
						showInfoMessage("Reload OGC API collections page and dependencies completed.");
					});
				}
				else if (node.image=="csw.png")
				{
					showInfoMessage("Reload OGC CSW records and dependencies...");
					showInfoMessage("Requesting OGC CSW collections...");
					await LoadJSONNodeSTAData(node, function () {
						showInfoMessage("Reload OGC CSW records and dependencies completed.");
					});
				}
			}
		}
		//General to addColumns
		function cancelButtonRecoveryOldData(event){
			event.preventDefault();
			currentNode.STAdata=currentNode.STAdataCopy;
			networkNodes.update(currentNode)

			if (currentNode.image=="CreateColumns.png"){
				document.getElementById("DialogCreateColumns").close();
			}else if (currentNode.image=="AggregateColumns.png"){
				document.getElementById("DialogAggregateColumns").close();
			}else{
				document.getElementById("DialogColumnsCalculator").close();
			}
		}
		function deleteRowInColumnsBoxTable(number){
			event.preventDefault(); 
			var copyWithoutNumber=[],n=currentNode.STAcolumnsList.length, c=currentNode.STAnewColumnsToAdd.length,columsnListNew=[];
			for (var i=0;i<c;i++){
				if (i!=number){
					copyWithoutNumber.push(currentNode.STAnewColumnsToAdd[i])
				}else{
					var columnToErase=currentNode.STAnewColumnsToAdd[i][1];
				}
			}

			//Erase attribute from the column list
			for (var a=0;a<n;a++) {
				if (currentNode.STAcolumnsList[a]!=columnToErase){
					columsnListNew.push(currentNode.STAcolumnsList[a])
				}
			}	

			currentNode.STAnewColumnsToAdd=copyWithoutNumber;
			currentNode.STAcolumnsList=columsnListNew;
			networkNodes.update(currentNode);
			if (currentNode.image=="CreateColumns.png"){ //createColumn
				drawTableInColumnBoxTableInCreateColumns();
			}else if (currentNode.image=="AggregateColumns.png"){ //aggregateTable
				drawTableInColumnBoxTableInAggregateColumns();
			} else{
				drawTableInColumnBoxTableInCalculatorColumns();
			}
			
		}
		function columnExistInTheTable(columnName){
			var columnList=	currentNode.STAcolumnsList;
			var n= columnList.length, columnNameExist=false;
			
			for (var i=0;i<n;i++){
				if (columnList[i]==columnName){
					columnNameExist=true;
					break;
				}
			}
			if (!columnNameExist){
				columnList.push(columnName); //Add to Column list to avoid duplicates
				currentNode.STAcolumnsList=columnList 
			}

			return columnNameExist;
		}
		function createColumnListToAddColumns(){
			var dataKeys= Object.keys(currentNode.STAdata[0]);
			currentNode.STAcolumnsList=dataKeys;
			networkNodes.update(currentNode);
		}

		//Create Columns

		function addColumnToListCreateColumn(event){
			event.preventDefault();
			
			var TypeOfValuesRadiobuttons= document.getElementsByName("TypeOfValues");
			var columnName= document.getElementById("columnNameCreateColumns").value;
			var n= TypeOfValuesRadiobuttons.length;
			
			if (columnName.length==0) columnName="noname";
			var columnNameExist=columnExistInTheTable(columnName); //Search if name for column is not repeated

			if(columnNameExist){ //It will not be added because column name already exist
				alert("Chosen column name already exists, change it to add column to the list ");
			}else{
				for (var i = 0; i <n ; i++) {
                if (TypeOfValuesRadiobuttons[i].checked){
					var columnName= document.getElementById("columnNameCreateColumns").value;
					var number= document.getElementById("inputText_"+TypeOfValuesRadiobuttons[i].value)?.value;
					if (number=="") //to avoid undefined in column list and problems afeter
							number="0";
					currentNode.STAnewColumnsToAdd.push([TypeOfValuesRadiobuttons[i].value,columnName,number]);
				}
				} 
				networkNodes.update(currentNode);
				drawTableInColumnBoxTableInCreateColumns();
			}

		}

		function drawTableInColumnBoxTableInCreateColumns(){
			var spanColumnsListAggregateColumns=document.getElementById("spanColumnsListCreateColumns");
			var cdns=[], tableHTML;

			tableHTML='<table border=1><tr><th>Column type</th><th>Column name</th><th>Value</th><th></th></tr>';
			if (currentNode.STAnewColumnsToAdd.length!=0){ //[columnType, columnName, value]
				var n= currentNode.STAnewColumnsToAdd.length, columnType;
				for (var i=0;i<n;i++){
					switch(currentNode.STAnewColumnsToAdd[i][0]){
						case "constantValue":
							columnType="Constant value"
							break;
						case "autoincrementalValue":
							columnType="Autoincremental value"
							break;
						case "empty":
							columnType="Empty"
							break;
								
					}
						tableHTML+=`<tr><td>${columnType}</td><td>${currentNode.STAnewColumnsToAdd[i][1]}</td>`;
					if (currentNode.STAnewColumnsToAdd[i][2]){ 
						tableHTML+=`<td>${currentNode.STAnewColumnsToAdd[i][2]}</td>`;
				}else{
						tableHTML+=`<td> </td>`;
					}
					tableHTML+=`<td><button onclick='deleteRowInColumnsBoxTable(${i})'><img src="trash.png" alt="Remove" title="Remove"></button> </td>`;
				}
			}
			else{
				tableHTML+=`<tr style="height:20px"><td> </td><td></td><td></td><td></td></tr>`
			}
			tableHTML+=`</table>`;
			cdns=[tableHTML];
			spanColumnsListAggregateColumns.innerHTML=cdns;
		}
		function addColumnsToTableInCreateColumns(){
			event.preventDefault();
				var datan,n=currentNode.STAnewColumnsToAdd.length;
				for (var i=0;i<n;i++){
	
				switch(currentNode.STAnewColumnsToAdd[i][0]) {
				case  "constantValue":
						addNewColumnWithUniqueValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1], currentNode.STAnewColumnsToAdd[i][2])
					break;
				case  "autoincrementalValue":
						addNewColumnWithAutoincrementalValues(currentNode.STAdata,currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2])
					break;
				case  "empty":
						addNewEmptyColumn(currentNode.STAdata,currentNode.STAnewColumnsToAdd[i][1]);
					
					break;
				}	
				networkNodes.update(currentNode);	
					
			}
			document.getElementById("DialogCreateColumns").close();
			showInfoMessage("New columns have been added");
		}
		

		//Aggregate columns

		function deselectColumnNameRadioButton(radiobutton){
			if (radiobutton=="personalized"){
				document.getElementById("columnNameAggregateColumns").disabled = false;
			}else{
				document.getElementById("columnNameAggregateColumns").disabled = true;
			}
		}

		function fillAggregateColumVariablesList(){

			var dataKeys= Object.keys(currentNode.STAdata[0]);
		 //var n= dataKeys.length;
		// var dataKeysObject=[];
		// for (var i=0;i<n;i++){
		// 	dataKeysObject.push({name:dataKeys[i], desc:dataKeys[i] });
		// }
		//showCheckRadioOptions("columnsFielset", "attributesRadioAggrgatedColumns_", dataKeysObject, 1, null, "writeColumnNameInAggregatedColumns (event)");
		var parentNode=GetFirstParentNode(currentNode);
		ShowTableSelectColumnsDialog("columnsFielset", parentNode, currentNode, false,"writeColumnNameInAggregatedColumns (event)" );

		//Create list of columns to avoid repetitions
		currentNode.STAcolumnsList=dataKeys;
	
	}

	function checkRadioButtonColumName(event){
		event.preventDefault();
		document.getElementById("columnNameRadioAggregateColumns_personalized").setAttribute("checked", true);
		document.getElementById("columnNameRadioAggregateColumns_suggested").setAttribute("checked", false);
	}
	function addColumnToListAggregateColumns(event) {
		event.preventDefault();
		var TypeOfOperation = document.getElementsByName("operationsRadioAggrgatedColumns"); //operation
		var STANewColumnsArray = [], attributesArray = [], attribute;
		var dataKeys = Object.keys(currentNode.STAdata[0]);
		var chooseNumberDecimalsInputRadio, chooseNumberDecimalsInput, typeOfOperationLenght = TypeOfOperation.length, dataKeysLenght = dataKeys.length;
		var columnList = currentNode.STAcolumnsList;
		var columnName;

		var typeOfOperationExist = false, atLeast2attributesSelected = false;
		//Operation
		for (var i = 0; i < typeOfOperationLenght; i++) { //Take operation 
			if (TypeOfOperation[i].checked) {
			STANewColumnsArray.push(TypeOfOperation[i].id.split("AggrgatedColumns_")[1]);
			typeOfOperationExist = true;
					}
				}
		//attributes
		for (var a = 0; a < dataKeysLenght; a++) {
			attribute = document.getElementById("columnsFielset_" + a);
			if (attribute.checked) {
			attributesArray.push(dataKeys[a]);
			}
		}
		if (attributesArray.length >= 2) {
			atLeast2attributesSelected = true;
		}

		if (typeOfOperationExist == false || atLeast2attributesSelected == false) {
			alert("At least two attributes and one aggregation method have to be selected");
		} else {//All is correct, new column can be added to the list
			//columnName
			if (document.getElementById("columnNameRadioAggregateColumns_personalized").checked) {
			columnName = document.getElementById("columnNameAggregateColumns").value;
			if (columnName.length == 0) columnName = "noname";
			} else {
			columnName = document.getElementById("columnNameAggregateColumns_span").value;
			}
			var columnNameExist = columnExistInTheTable(columnName); //Search if name for column is not repeated
			
			if (columnNameExist) { //It will not be added because column name already exist
			alert("Chosen column name already exists, change it to add column to the list ");
					}
			else { //It can be added
			STANewColumnsArray.push(columnName, attributesArray);
			if (document.getElementById("chooseNumberDecimals_0").checked) {
					STANewColumnsArray.push(document.getElementById("chooseNumberDecimals_0_input").value)
				}	
			currentNode.STAnewColumnsToAdd.push(STANewColumnsArray); //[typeOfOperation,columnName,[attributes]]
				networkNodes.update(currentNode);
				drawTableInColumnBoxTableInAggregateColumns();
			}
      }
		}
		function drawTableInColumnBoxTableInAggregateColumns(){
			var spanColumnsListAggregateColumns=document.getElementById("spanColumnsListAggregateColumns");
			var cdns;
			var tableHTML=`<table border=1><tr><th>Attributes</th><th>Operation</th><th>Column name</th><th>Number of decimals</th><th></th></tr>`;
			if (currentNode.STAnewColumnsToAdd.length!=0){
				var n= currentNode.STAnewColumnsToAdd.length, attributes="";
				for (var i=0;i<n;i++){
					attributes="";//restart
					for (var a =0; a<currentNode.STAnewColumnsToAdd[i][2].length; a++){
						if (a!=0){
							attributes+=", ";
						}
						attributes +=currentNode.STAnewColumnsToAdd[i][2][a];
						
					}
					tableHTML+=`<tr><td>${attributes}</td><td>${currentNode.STAnewColumnsToAdd[i][0]}</td><td>${currentNode.STAnewColumnsToAdd[i][1]}</td>`;
					if (currentNode.STAnewColumnsToAdd[i][3]){ //number of decimals
						tableHTML+=`<td>${currentNode.STAnewColumnsToAdd[i][3]}</td><td><button onclick='deleteRowInColumnsBoxTable(${i})'><img src="trash.png" alt="Remove" title="Remove"></button></td></tr>`;
					}else{
						tableHTML+=`<td> </td><td><button onclick='deleteRowInColumnsBoxTable(${i})'><img src="trash.png" alt="Remove" title="Remove"></button></td></tr>`;
				}
				}
			}else{
				tableHTML+=`<tr style="height:20px"><td></td><td></td><td></td><td></td><td></td></tr>`
			}
			
			tableHTML+=`</table>`;
			cdns=[tableHTML];
			spanColumnsListAggregateColumns.innerHTML=cdns;
		}

		function addColumnsToTableInAggregateColumns(event){
			event.preventDefault();
			var data;
			var decimalNumber,n=currentNode.STAnewColumnsToAdd.length;
			var dataAttributes= getDataAttributes(currentNode.STAdata)
			if (n!=0){
				for (var i=0;i<n;i++){
				decimalNumber=""; //Restart 
				if (currentNode.STAnewColumnsToAdd[i][3]){
				decimalNumber=currentNode.STAnewColumnsToAdd[i][3];
			}
				switch(currentNode.STAnewColumnsToAdd[i][0]) {
						case  "Sum":
						if (decimalNumber!=""){
								addnewColumnSummingColumns(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],decimalNumber, dataAttributes); //data, columnName,columnsToSum, decimalnumber

						}else{
								addnewColumnSummingColumns(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes); //data, columnName,columnsToSum

						}
						break;
						case  "Product": //(s'ha de crear)
					if (decimalNumber!=""){
								addnewColumnMultiplyingColumns(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],decimalNumber, dataAttributes); //data, columnName,columnsToSum, decimalnumber

						}else{
								addnewColumnMultiplyingColumns(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes); //data, columnName,columnsToSum

						}
						break;
						case  "MinValue":
					if (decimalNumber!=""){
							addnewColumnMinimalValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes); 

					}else{
							addnewColumnMinimalValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes); 
					}
						break;
						case  "MaxValue":
					if (decimalNumber!=""){
							addnewColumnMaximalValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber,dataAttributes); 
					}else{
					}
							addnewColumnMaximalValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes); 

						break;
						case  "Mean":
					if (decimalNumber!=""){
							addnewColumnMeanValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);

					}else{
							addnewColumnMeanValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);

					}	
						break;
						case  "Variance":
					if (decimalNumber!=""){
								addnewColumnVarianceValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);

					}else{
								addnewColumnVarianceValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);

					}
						break;
						case  "Median":
						if (decimalNumber!=""){
								addnewColumnMedianValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);

						}else{
								addnewColumnMedianValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);

						}
						break;
						case  "Concatenate":
						addnewColumnConcatenatingValues(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2]);
						break;

						case  "Mode":
						if (decimalNumber!=""){
							addnewColumnModeValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnModeValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);
						}
							break;
						case  "FirstValue":
						if (decimalNumber!=""){
							addnewColumnFirstValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnFirstValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);
						}
							break;

						case  "StandardDeviation":
						if (decimalNumber!=""){
							addnewColumnStandardDeviationValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber,"", dataAttributes);
						}else{
							addnewColumnStandardDeviationValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], dataAttributes);
						}
							break;
						case  "LastValue":
						if (decimalNumber!=""){
							addnewColumnLastValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnLastValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);
						}
							break;
						case  "Q1":
						if (decimalNumber!=""){
							addnewColumnQ1Value(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnQ1Value(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);
						}
							break;
						case  "Q3":
						if (decimalNumber!=""){
							addnewColumnQ3Value(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnQ3Value(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2],"", dataAttributes);
						}
							break;
						case  "RandomValue":
						if (decimalNumber!=""){
							addnewColumnRandomValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber,"", dataAttributes);
						}else{
							addnewColumnRandomValue(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], dataAttributes);
						}
							break;						
						case  "Count": //TE SENTIT?
							addnewColumnCount(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], dataAttributes);
							break;
						case  "CountDefined": //Falta fer la funció que conta
							
							break;
						case  "Range": 						
							if (decimalNumber!=""){
								addnewColumnRange(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
							}else{
								addnewColumnRange(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2]),"", dataAttributes;
							}
								break;
						case  "ProportionDefined": //Falta fer la funció que conta
						if (decimalNumber!=""){
							addnewColumnProportionDefined(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2], decimalNumber, dataAttributes);
						}else{
							addnewColumnProportionDefined(currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][2]),"", dataAttributes;
						}
							
							break;
				}
			}
			showInfoMessage("New columns have been added");
			document.getElementById("DialogAggregateColumns").close();
			}else{
				alert("There are no columns in the list to add, nothing will be added to the table")
			}

			
		}
		function writeColumnNameInAggregatedColumns(event){
			event.preventDefault();
			var columnName=document.getElementById("columnNameAggregateColumns")
			var columnNameValue=columnName.value;
			var spanSuggested= document.getElementById("columnNameAggregateColumns_span");
				var dataKeys= Object.keys(currentNode.STAdata[0]);
				var dataKeysLenght=dataKeys.length, attribute, columnNameText="";
				for (var a=0;a<dataKeysLenght;a++ ){
						attribute=document.getElementById("columnsFielset_"+a);
						if (attribute.checked){
							if (columnNameText==""){
								columnNameText+=dataKeys[a];
							}else{ //more than one chosen
								columnNameText+="_"+dataKeys[a];
							}
							
						}
				}
				//
				var TypeOfOperation=document.getElementsByName("operationsRadioAggrgatedColumns");
				var typeOfOperationLenght=TypeOfOperation.length
				for (var i=0;i<typeOfOperationLenght;i++){ //Take operation and column name
					if (TypeOfOperation[i].checked){
						columnNameText+="_"+ TypeOfOperation[i].id.split("AggrgatedColumns_")[1];
					}
				}

				spanSuggested.innerHTML= columnNameText;
				spanSuggested.value=columnNameText;
				
			/////
			
		}
		//Calulator 
		var textarea = document.getElementById("textAreaFormulaColumnsCalculator")
		textarea.addEventListener('click', event => { //keep mouse position to add buttons information in that place
		textarea.setAttribute("data-mousePosition", textarea.selectionStart) 
		})

		function WriteInTheFormulaButtons(character) {
		event.preventDefault();
		var textAreaFormulaColumnsCalculator = document.getElementById("textAreaFormulaColumnsCalculator");
		var text = textAreaFormulaColumnsCalculator.value;
		var mousePosition = textAreaFormulaColumnsCalculator.getAttribute("data-mousePosition");
			if (character=="&#40;"){
				character=="("
			}else if (character=="&#41;"){
				character==")"
			}




		if (character == "attributeSelected") {
			var selector = document.getElementById("calculator_selectColumns");
			character = selector.options[selector.selectedIndex].value;
		}
		textAreaFormulaColumnsCalculator.value = [text.slice(0, mousePosition), character, text.slice(mousePosition)].join('');
		textAreaFormulaColumnsCalculator.setAttribute("data-mousePosition", parseInt(mousePosition) + character.length); //If there is no click, next button will be written after this.
		}
		
		function addColumnToListColumnsCalculator(event){
			event.preventDefault();
			var columnName= document.getElementById("columnNameColumnsCalculator").value;
			var textAreaFormulaColumnsCalculator= document.getElementById("textAreaFormulaColumnsCalculator");
			if (columnName.length==0) columnName="noname";
			var columnNameExist=columnExistInTheTable(columnName); //Search if name for column is not repeated
			if(columnNameExist){ //It will not be added because column name already exist
				alert("Chosen column name already exists, change it to add column to the list ");
			}else{
				var decimalNumber="";
				if (document.getElementById("chooseNumberDecimalsCalculator_0").checked) {
					decimalNumber=document.getElementById("chooseNumberDecimalsCalculator_0_input").value;
				}
				currentNode.STAnewColumnsToAdd.push([textAreaFormulaColumnsCalculator.value,columnName,decimalNumber]);
				drawTableInColumnBoxTableInCalculatorColumns();
			}
			
		}
		function fillCalculatorColumVariablesList(){ //omplir el desplegable

			// var dataKeys= Object.keys(currentNode.STAdata[0]);
			//var n= dataKeys.length;
			var dataAttributes= getDataAttributes(currentNode.STAdata);
			var dataAttributesKeys=Object.keys(dataAttributes)
			var n= dataAttributesKeys.length;
			
			var select = document.getElementById("calculator_selectColumns");
			var cdns=[]

			for (var i=0;i<n;i++){
				//cdns.push(`<option value= ${dataKeys[i]}>${dataKeys[i]}</option>`);
				if (dataAttributes[dataAttributesKeys[i]]['type']=="number") cdns.push(`<option value= ${dataAttributesKeys[i]}>${dataAttributesKeys[i]}</option>`);
			}
			select.innerHTML=cdns.join("");
		
			
		}
		function drawTableInColumnBoxTableInCalculatorColumns(){
			var spanColumnsListAggregateColumns=document.getElementById("spanColumnsListCalculatorColumns");
			var cdns;
			var tableHTML=`<table border=1><tr><th>Formula</th><th>Column name</th><th>Number of decimals</th><th></th></tr>`;
				if (currentNode.STAnewColumnsToAdd.length!=0){
					var n= currentNode.STAnewColumnsToAdd.length;
					for (var i=0;i<n;i++){
						tableHTML+= `<tr><td>${currentNode.STAnewColumnsToAdd[i][0]}</td><td>${currentNode.STAnewColumnsToAdd[i][1]}</td><td>${currentNode.STAnewColumnsToAdd[i][2]}</td><td><button onclick='deleteRowInColumnsBoxTable(${i})'><img src="trash.png" alt="Remove" title="Remove"></button></td></tr>`

					}
				}else{
					tableHTML+=`<tr style="height:20px"><td></td><td></td><td></td><td></td></tr>`
			}
				tableHTML+=`</table>`;
				cdns=[tableHTML];
				spanColumnsListAggregateColumns.innerHTML=cdns;
		}

		function addColumnsToTableInColumnsCalculator(){
			event.preventDefault();
			var decimalNumber;//decimalNumber=currentNode.STAnewColumnsToAdd[i][2];
			var n=currentNode.STAnewColumnsToAdd.length;
			for (var i=0;i<n;i++){
				decimalNumber=currentNode.STAnewColumnsToAdd[i][2];
				if (decimalNumber!=""){
					addnewColumnWithFormula (currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][0],decimalNumber);
				}else{
					addnewColumnWithFormula (currentNode.STAdata, currentNode.STAnewColumnsToAdd[i][1],currentNode.STAnewColumnsToAdd[i][0]);
				}
			}
			showInfoMessage("New columns have been added");
			document.getElementById("DialogColumnsCalculator").close();

		}
			
		/*
		function giveMeNetworkInformation(event) {
			if (event)
				event.preventDefault(); // We don't want to submit this form
			document.getElementById("DialogSelectColumns").close();
			console.log(networkNodes);
		}*/
	</script>

</body>


</html>